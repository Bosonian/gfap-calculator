<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iGFAP Check - Mark 6 (Debugged)</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#007bff" />
  <style>
    /* Root-level CSS variables for theming */
    :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --secondary-color: #dc3545;
      --secondary-hover: #b52b3a;
      --experimental-color: #ffc107;
      --experimental-text-color: #212529;
      --experimental-hover: #e0a800;
      --background-color: #f8f9fa;
      --text-color: #333;
      --warning-text-color: #856404;
      --warning-bg-color: #fff3cd;
      --warning-border-color: #ffeeba;
      --loading-spinner-color: var(--primary-color);
    }

    /* Dark mode overrides for CSS variables */
    body.dark-mode {
      --primary-color: #3399ff;
      --primary-hover: #287ac7;
      --secondary-color: #e06666;
      --secondary-hover: #cc5252;
      --experimental-color: #ffca2c;
      --experimental-text-color: #212529;
      --experimental-hover: #f5b90a;
      --background-color: #333;
      --text-color: #f8f9fa;
      --warning-text-color: #ffeeba;
      --warning-bg-color: #533f03;
      --warning-border-color: #856404;
      --loading-spinner-color: var(--primary-color);
    }

    /* Box-sizing reset for all elements */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    /* Base body styling */
    body {
      font-family: "Arial", sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Container styling for central panels */
    .container {
      max-width: 500px;
      margin: 70px auto 20px auto;
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease;
    }

    /* Dark mode container background */
    body.dark-mode .container {
      background-color: #444;
    }

    /* Spacing for input groups and checkbox groups */
    .input-group,
    .checkbox-group {
      margin-bottom: 15px;
      text-align: left;
    }

    /* Layout for checkbox groups */
    .checkbox-group {
      display: flex;
      align-items: center;
    }

    .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
      width: 1.3em;
      height: 1.3em;
    }

    .checkbox-group label {
      cursor: pointer;
    }

    /* Styling for number/password inputs and select elements */
    .input-group input[type="number"],
    .input-group input[type="password"],
    select.score-select {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border: 2px solid var(--primary-color);
      border-radius: 5px;
      background-color: var(--background-color);
      color: var(--text-color);
    }

    /* Dark mode override for inputs and selects */
    body.dark-mode .input-group input[type="number"],
    body.dark-mode .input-group input[type="password"],
    body.dark-mode select.score-select {
      background-color: #555;
      color: var(--text-color);
      border-color: var(--primary-color);
    }

    /* Placeholder text color */
    .input-group input::placeholder {
      color: #aaa;
    }

    body.dark-mode .input-group input::placeholder {
      color: #888;
    }

    /* Class for invalid input highlighting */
    .input-error {
      border: 2px solid var(--secondary-color) !important;
    }

    /* Base button styling */
    button {
      padding: 12px;
      margin-top: 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
      width: 100%;
      font-weight: bold;
      position: relative;
    }

    /* Spinner animation for loading buttons */
    button.loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      border: 4px solid transparent;
      border-top-color: var(--loading-spinner-color);
      border-right-color: var(--loading-spinner-color);
      border-radius: 50%;
      animation: button-loading-spinner 1s ease infinite;
    }

    button.loading span {
      visibility: hidden;
    }

    /* Keyframes for loading spinner rotation */
    @keyframes button-loading-spinner {
      from {
        transform: rotate(0turn);
      }
      to {
        transform: rotate(1turn);
      }
    }

    /* Primary button appearance */
    .primary {
      background-color: var(--primary-color);
      color: white;
    }

    .primary:hover {
      background-color: var(--primary-hover);
    }

    body.dark-mode .primary {
      --loading-spinner-color: #fff;
    }

    /* Experimental button styling (used for toggling advanced models) */
    .experimental {
      background-color: var(--experimental-color);
      color: var(--experimental-text-color);
      border: 1px solid #c69500;
    }

    .experimental:hover {
      background-color: var(--experimental-hover);
    }

    body.dark-mode .experimental {
      --loading-spinner-color: var(--experimental-text-color);
    }

    /* Secondary button styling */
    .secondary {
      background-color: var(--secondary-color);
      color: white;
    }

    .secondary:hover {
      background-color: var(--secondary-hover);
    }

    body.dark-mode .secondary {
      --loading-spinner-color: #fff;
    }

    /* Result box styling */
    .result {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      border: 1px solid transparent;
    }

    /* Warning result styling */
    .result.warning {
      color: var(--warning-text-color);
      background-color: var(--warning-bg-color);
      border-color: var(--warning-border-color);
    }

    /* Risk-level color coding */
    .low-risk {
      color: #28a745;
    }

    .medium-risk {
      color: #daa520;
    }

    .red-risk {
      color: #dc3545;
    }

    body.dark-mode .low-risk {
      color: #34d399;
    }

    body.dark-mode .medium-risk {
      color: #f59e0b;
    }

    body.dark-mode .red-risk {
      color: #f87171;
    }

    /* Header styling (app bar) */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: var(--primary-color);
      color: white;
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .app-header h1 {
      font-size: 1.5em;
      margin: 0;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-right button {
      width: auto;
      padding: 8px 12px;
      margin-top: 0;
    }

    /* Language switcher icons */
    .language-switcher img {
      width: 24px;
      height: 16px;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle;
    }

    .language-switcher button {
      background: none;
      border: none;
      padding: 5px;
      cursor: pointer;
    }

    /* Modal overlay styling (for disclaimer) */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      opacity: 0;
      transition: opacity 0.3s ease;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background-color: #fff;
      padding: 20px;
      width: 80%;
      max-width: 400px;
      border-radius: 10px;
      text-align: center;
    }

    body.dark-mode .modal-content {
      background-color: #444;
    }

    /* Error message styling */
    #accessError,
    #prerequisiteError,
    #advancedStrokeError {
      color: var(--secondary-color);
      margin-top: 10px;
      font-weight: bold;
    }

    body.dark-mode #accessError,
    body.dark-mode #prerequisiteError,
    body.dark-mode #advancedStrokeError {
      color: var(--secondary-color);
    }

    /* Utility class to hide elements */
    .hidden {
      display: none !important;
    }

    /* Styles for interactive score calculator containers */
    .score-calculator-group {
      border: 1px solid #eee;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 5px;
    }

    body.dark-mode .score-calculator-group {
      border-color: #555;
    }

    .score-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .score-header > label {
      font-weight: bold;
      margin-right: 10px;
      flex-grow: 1;
    }

    .score-value-display {
      font-weight: bold;
      font-size: 1.1em;
      color: var(--primary-color);
      min-width: 25px;
      text-align: right;
      margin-right: 10px;
    }

    .calculate-score-btn {
      padding: 6px 10px !important;
      font-size: 0.9em !important;
      width: auto !important;
      margin-top: 0 !important;
      background-color: #6c757d;
      color: white;
      flex-shrink: 0;
    }

    body.dark-mode .calculate-score-btn {
      background-color: #868e96;
    }

    .calculate-score-btn:hover {
      background-color: #5a6268;
    }

    body.dark-mode .calculate-score-btn:hover {
      background-color: #707880;
    }

    /* Score components layout */
    .score-components {
      padding-top: 10px;
      border-top: 1px dashed #ccc;
      margin-top: 10px;
    }

    body.dark-mode .score-components {
      border-top-color: #555;
    }

    .score-components .checkbox-group,
    .score-components .input-group {
      margin-left: 0px;
      margin-bottom: 10px;
    }

    .score-components .input-group label,
    .score-components .checkbox-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.95em;
    }

    select.score-select {
      font-size: 16px;
      padding: 10px;
    }
    
    /* Back-to-top button */
    #backToTop {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: none;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: background-color 0.2s ease;
    }
    #backToTop:hover {
      background-color: var(--primary-hover);
    }
    
    /* Debug info styling */
    .debug-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <!-- App Header -->
  <header class="app-header">
    <div class="header-left">
      <h1 id="appTitle" data-translate="appTitle">iGFAP Check</h1>
    </div>
    <div class="header-right">
      <div class="language-switcher">
        <button onclick="switchLanguage('en')" aria-label="Switch to English" title="Switch to English">
          <img src="https://flagcdn.com/gb.svg" alt="English" />
        </button>
        <button onclick="switchLanguage('de')" aria-label="Switch to German" title="Switch to German">
          <img src="https://flagcdn.com/de.svg" alt="Deutsch" />
        </button>
      </div>
      <button id="darkModeToggle" aria-label="Toggle dark mode"><span>üåô</span></button>
      <button class="home-button" id="homeButton" data-translate="homeButton" onclick="navigateToModuleSelection()">
        <span>üè† Home</span>
      </button>
    </div>
  </header>
  
  <!-- Back to top button -->
  <button id="backToTop" title="Back to top">‚¨ÜÔ∏è</button>
  
  <!-- Debug info -->
  <div class="debug-info" id="debugInfo"></div>

  <!-- Access Code Entry Section -->
  <section id="codeEntrySection" class="container">
    <p id="codePrompt" data-translate="codePrompt">üîë Please enter your access code:</p>
    <div class="input-group">
      <input
        type="password"
        id="accessCodeInput"
        placeholder=""
        data-translate-placeholder="accessCodePlaceholder"
      />
    </div>
    <button class="primary" id="accessCodeButton" data-translate="accessCodeButton">
      <span>Submit</span>
    </button>
    <p id="accessError" class="hidden" data-is-server-error="false"></p>
  </section>

  <!-- Module Selection Section -->
  <section id="moduleSelectionSection" class="container hidden">
    <h2 id="moduleSelectionTitle" data-translate="moduleSelectionTitle">Check probability for:</h2>
    <!-- Restored Coma Module Button -->
    <button class="primary" id="comaModuleButton" data-translate="comaModuleButton">
      <span>Intracranial hemorrhage in comatose patients (GCS 3-8)</span>
    </button>
    <button class="primary" id="strokeModuleButton" data-translate="strokeModuleButton">
      <span>Intracerebral hemorrhage in patients with stroke symptoms</span>
    </button>
  </section>

  <!-- Coma Module Section -->
  <section id="comaModuleSection" class="container hidden">
    <h2 id="comaModuleTitle" data-translate="comaModuleTitle">
      Intracranial hemorrhage in comatose patients (GCS 3-8)
    </h2>
    <div class="input-group">
      <label for="gfapComaInput" id="gfapComaLabel" data-translate="gfapLabel">GFAP Value (pg/mL)</label>
      <input type="number" id="gfapComaInput" min="29" max="10001" placeholder="" />
    </div>
    <button class="primary" id="calculateComaButton" data-translate="calculateButton">
      <span>Calculate Probability</span>
    </button>
    <button class="secondary" id="comaBackButton" data-translate="backButton" onclick="navigateToModuleSelection()">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <div class="result hidden" id="comaResult" aria-live="polite"></div>
  </section>

  <!-- Intracerebral Hemorrhage Module Choice -->
  <section id="strokeChoiceSection" class="container hidden">
    <h2 data-translate="strokeChoiceTitle">Choose Model Pathway</h2>
    <button class="primary" id="standardModelButton" data-translate="standardModelButton">
      <span>Standard Model (3 inputs)</span>
    </button>
    <button class="primary" id="advancedModelButton" data-translate="advancedModelButton">
      <span>Advanced Model</span>
    </button>
    <button class="secondary" id="strokeBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
  </section>

  <!-- Standard Model Prerequisites -->
  <section id="standardPrerequisitesSection" class="container hidden">
    <h2 data-translate="standardPrereqTitle">Standard Model Prerequisites</h2>
    <div class="checkbox-group">
      <input type="checkbox" id="stdPrereq1" />
      <label for="stdPrereq1" data-translate="prereq1">Confirmed time window &lt; 6 hours</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="stdPrereq2" />
      <label for="stdPrereq2" data-translate="prereq2">No prior neurological deficits</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="stdPrereq3" />
      <label for="stdPrereq3" data-translate="prereq3">No identifiable head trauma</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="stdPrereq4" />
      <label for="stdPrereq4" data-translate="prereq4">FAST ED Score ‚â• 3</label>
    </div>
    <button class="primary" id="standardNextButton" data-translate="nextButton">
      <span>Next</span>
    </button>
    <button class="secondary" id="standardBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <p id="standardPrereqError" class="error hidden"></p>
  </section>

  <!-- Standard Model Input Form (3 inputs) -->
  <section id="standardStrokeModuleSection" class="container hidden">
    <h2 data-translate="standardStrokeTitle">Intracerebral Hemorrhage (Standard)</h2>
    <div class="input-group">
      <label for="stdAgeInput" data-translate="ageLabel">Patient Age (Years)</label>
      <input type="number" id="stdAgeInput" min="18" max="120" />
    </div>
    <div class="input-group">
      <label for="stdGfapInput" data-translate="gfapLabel">GFAP Value (pg/mL)</label>
      <input type="number" id="stdGfapInput" min="29" max="10001" />
    </div>
    <div class="input-group">
      <label for="stdSbpInput" data-translate="sbpLabel">Systolic BP (mmHg)</label>
      <input type="number" id="stdSbpInput" min="50" max="250" />
    </div>
    <button class="primary" id="calculateStandardButton" data-translate="calculateButton">
      <span>Calculate Probability</span>
    </button>
    <button class="secondary" id="stdBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <div class="result hidden" id="standardResult" aria-live="polite"></div>
    <p id="standardError" class="error hidden"></p>
  </section>

  <!-- Advanced Model Prerequisites -->
  <section id="advancedPrerequisitesSection" class="container hidden">
    <h2 data-translate="advancedPrereqTitle">Advanced Model Prerequisites</h2>
    <div class="checkbox-group">
      <input type="checkbox" id="advPrereq1" />
      <label for="advPrereq1" data-translate="prereq1">Confirmed time window &lt; 6 hours</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="advPrereq2" />
      <label for="advPrereq2" data-translate="prereq2">No prior neurological deficits</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="advPrereq3" />
      <label for="advPrereq3" data-translate="prereq3">No identifiable head trauma</label>
    </div>
    <button class="primary" id="advancedNextButton" data-translate="nextButton">
      <span>Next</span>
    </button>
    <button class="secondary" id="advancedBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <p id="advancedPrereqError" class="error hidden"></p>
  </section>

  <!-- Advanced Model Version Choice -->
  <section id="advancedChoiceSection" class="container hidden">
    <h2 data-translate="advancedChoiceTitle">Advanced Model Versions</h2>
    <button class="primary" id="rapidVersionButton" data-translate="rapidVersionButton">
      <span>Schnell ‚ÅÑ Rapid (5 inputs)</span>
    </button>
    <button class="primary" id="maxVersionButton" data-translate="maxVersionButton">
      <span>Max (13 inputs)</span>
    </button>
    <button class="secondary" id="advChoiceBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
  </section>

  <!-- Rapid Version Input Form (5 inputs) -->
  <section id="rapidModuleSection" class="container hidden">
    <h2 data-translate="rapidTitle">Rapid Model (Schnell)</h2>
    <div class="input-group">
      <label for="rapAgeInput" data-translate="ageLabel">Patient Age (Years)</label>
      <input type="number" id="rapAgeInput" min="18" max="120" />
    </div>
    <div class="input-group">
      <label for="rapFastEdInput" data-translate="fastEdLabel">FAST ED Score</label>
      <input type="number" id="rapFastEdInput" min="0" max="9" />
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="rapHeadacheInput" />
      <label for="rapHeadacheInput" data-translate="headacheLabel">Headache ‚úÖ</label>
    </div>
    <div class="input-group">
      <label for="rapSbpInput" data-translate="sbpLabel">Systolic BP (mmHg)</label>
      <input type="number" id="rapSbpInput" min="50" max="250" />
    </div>
    <div class="input-group">
      <label for="rapGfapInput" data-translate="gfapLabel">GFAP Value (pg/mL)</label>
      <input type="number" id="rapGfapInput" min="29" max="10001" />
    </div>
    <button class="primary" id="calculateRapidButton" data-translate="calculateButton">
      <span>Calculate Probability</span>
    </button>
    <button class="secondary" id="rapidBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <div class="result hidden" id="rapidResult" aria-live="polite"></div>
    <p id="rapidError" class="error hidden"></p>
  </section>

  <!-- Max Version Input Form (13 inputs) -->
  <section id="maxModuleSection" class="container hidden">
    <h2 data-translate="maxTitle">Max Model (13 inputs)</h2>

    <div class="input-group">
      <label for="maxAgeInput" data-translate="ageLabel">Patient Age (Years)</label>
      <input type="number" id="maxAgeInput" min="18" max="120" />
    </div>
    <div class="input-group">
      <label for="maxGfapInput" data-translate="gfapLabel">GFAP Value (pg/mL)</label>
      <input type="number" id="maxGfapInput" min="0" max="50000" />
    </div>
    <div class="input-group">
      <label for="maxSbpInput" data-translate="sbpLabel">Systolic BP (mmHg)</label>
      <input type="number" id="maxSbpInput" min="50" max="300" />
    </div>
    <div class="input-group">
      <label for="maxDbpInput" data-translate="dbpLabel">Diastolic BP (mmHg)</label>
      <input type="number" id="maxDbpInput" min="30" max="200" />
    </div>

    <!-- FAST-ED Score Calculator for Max -->
    <div class="input-group score-calculator-group">
      <div class="score-header">
        <label id="maxFastEdDisplayLabel" data-translate="advFastEdDisplayLabel">FAST ED Score:</label>
        <span id="maxFastEdScoreDisplay" class="score-value-display">0</span>
        <button type="button" class="calculate-score-btn" id="maxToggleFastEdBtn" aria-expanded="false" aria-controls="fastEdComponentsContainerMax">
          <span id="maxToggleFastEdBtnText" data-translate="toggleFastEdBtnTextCalculate">Calculate/Edit</span>
        </button>
        <input type="hidden" id="maxFastEdInput" name="maxFastEdInput" value="0" />
      </div>
      <div id="fastEdComponentsContainerMax" class="score-components hidden">
        <p id="fastEdInfoTextMax" style="font-size: 0.9em; margin-bottom: 5px;" data-translate="fastEdInfoText">
          Select present findings for FAST ED:
        </p>

        <div class="checkbox-group">
          <input type="checkbox" id="maxFastEdFacialPalsy" data-points="1" />
          <label for="maxFastEdFacialPalsy" id="fastEdFacialPalsyLabelMax" data-translate="fastEdFacialPalsyLabel">
            Facial Palsy (Partial/Complete)
          </label>
        </div>
        <div class="input-group">
          <label for="maxFastEdArmWeakness" id="fastEdArmWeaknessLabelMax" data-translate="fastEdArmWeaknessLabel">Arm Weakness</label>
          <select id="maxFastEdArmWeakness" class="score-select">
            <option value="0" id="fastEdArm0LabelMax" data-translate="fastEdArm0Label">0 ‚Äì No drift</option>
            <option value="1" id="fastEdArm1LabelMax" data-translate="fastEdArm1Label">1 ‚Äì Drifts down</option>
            <option value="2" id="fastEdArm2LabelMax" data-translate="fastEdArm2Label">2 ‚Äì No effort / Falls</option>
          </select>
        </div>
        <div class="input-group">
          <label for="maxFastEdSpeechChanges" id="fastEdSpeechChangesLabelMax" data-translate="fastEdSpeechChangesLabel">Speech Changes</label>
          <select id="maxFastEdSpeechChanges" class="score-select">
            <option value="0" id="fastEdSpeech0LabelMax" data-translate="fastEdSpeech0Label">0 ‚Äì Normal</option>
            <option value="1" id="fastEdSpeech1LabelMax" data-translate="fastEdSpeech1Label">1 ‚Äì Mild/Moderate</option>
            <option value="2" id="fastEdSpeech2LabelMax" data-translate="fastEdSpeech2Label">2 ‚Äì Severe/Mute</option>
          </select>
        </div>
        <div class="input-group">
          <label for="maxFastEdEyeDeviation" id="fastEdEyeDeviationLabelMax" data-translate="fastEdEyeDeviationLabel">Eye Deviation</label>
          <select id="maxFastEdEyeDeviation" class="score-select">
            <option value="0" id="fastEdEye0LabelMax" data-translate="fastEdEye0Label">0 ‚Äì Absent</option>
            <option value="1" id="fastEdEye1LabelMax" data-translate="fastEdEye1Label">1 ‚Äì Partial</option>
            <option value="2" id="fastEdEye2LabelMax" data-translate="fastEdEye2Label">2 ‚Äì Forced Deviation</option>
          </select>
        </div>
        <div class="input-group">
          <label for="maxFastEdDenialNeglect" id="fastEdDenialNeglectLabelMax" data-translate="fastEdDenialNeglectLabel">Denial/Neglect</label>
          <select id="maxFastEdDenialNeglect" class="score-select">
            <option value="0" id="fastEdDenial0LabelMax" data-translate="fastEdDenial0Label">0 ‚Äì Absent</option>
            <option value="1" id="fastEdDenial1LabelMax" data-translate="fastEdDenial1Label">1 ‚Äì Mild (Extinction)</option>
            <option value="2" id="fastEdDenial2LabelMax" data-translate="fastEdDenial2Label">2 ‚Äì Severe (Unawareness)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Additional Symptoms & History -->
    <p style="font-weight: bold; margin-top: 20px; margin-bottom: 5px;" id="maxAdditionalSymptomsLabel" data-translate="advAdditionalSymptomsLabel">
      Additional Symptoms & History (Check if Present/Yes):
    </p>
    <div class="checkbox-group">
      <input type="checkbox" id="maxEyeDeviationInput" />
      <label for="maxEyeDeviationInput" id="advEyeDeviationFlippedLabelMax" data-translate="advEyeDeviationFlippedLabel">
        Eye Deviation (Symptom)
      </label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="maxArmParesisInput" />
      <label for="maxArmParesisInput" id="advArmPareseFlippedLabelMax" data-translate="advArmPareseFlippedLabel">
        Arm Paresis (Symptom)
      </label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="maxLegParesisInput" />
      <label for="maxLegParesisInput" id="advBeinPareseFlippedLabelMax" data-translate="advBeinPareseFlippedLabel">
        Leg Paresis (Symptom)
      </label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="maxVigilanceInput" />
      <label for="maxVigilanceInput" id="advVigilanzminderungLabelMax" data-translate="advVigilanzminderungLabel">
        Altered Sensorium
      </label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="maxAfibInput" />
      <label for="maxAfibInput" id="advAfibLabelMax" data-translate="advAfibLabel">
        Known Atrial Fibrillation
      </label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="maxHeadacheInput" />
      <label for="maxHeadacheInput" id="advHeadacheLabelMax" data-translate="advHeadacheLabel">
        Headache
      </label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="maxNoakInput" />
      <label for="maxNoakInput" id="advNoakLabelMax" data-translate="advNoakLabel">
        On Anticoagulants (NOAK)
      </label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="maxAntiplateletsInput" />
      <label for="maxAntiplateletsInput" id="advAntiplateletsLabelMax" data-translate="advAntiplateletsLabel">
        On Antiplatelets
      </label>
    </div>

    <button class="primary" id="calculateMaxButton" data-translate="calculateAdvancedStrokeButton">
      <span>Calculate Probability</span>
    </button>
    <button class="secondary" id="maxBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <div class="result hidden" id="maxResult" aria-live="polite"></div>
    <p id="maxError" class="error hidden"></p>
  </section>

  <!-- Footer -->
  <footer style="text-align:center; margin-top:20px; padding-bottom: 20px;">
    <p>¬© <span id="currentYear"></span> iGFAP. All rights reserved.</p>
  </footer>

  <!-- Disclaimer Modal -->
  <div id="disclaimerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="disclaimerModalTitleText">
    <div class="modal-content">
      <p id="disclaimerModalTitleText" class="disclaimer-text" data-translate="disclaimer">
        The calculations are for research purposes only, do not make clinical decisions based on it.
      </p>
      <button class="primary" id="disclaimerConfirmButton" data-translate="confirmButton">
        <span>Confirm</span>
      </button>
    </div>
  </div>

  <script>
    // Current language setting (default English)
    let currentLang = "en";
    // Placeholder for pending result data (used for showing after disclaimer)
    let pendingResult = null;

    // API endpoints for backend calls
    const ACCESS_CODE_VALIDATOR_URL =
      "https://europe-west3-igfap-452720.cloudfunctions.net/validateAccessCode";
    const COMA_CALCULATOR_URL =
      "https://europe-west3-igfap-452720.cloudfunctions.net/calculateComaRisk";
      
    // DEBUGGED: Corrected endpoints for stroke models
    const STANDARD_URL   = "https://europe-west3-igfap-452720.cloudfunctions.net/calculateStrokeRisk";
    const RAPID_URL      = "https://europe-west3-igfap-452720.cloudfunctions.net/calculate-rapid-stroke-rf";
    const MAX_URL        = "https://europe-west3-igfap-452720.cloudfunctions.net/calculate-advanced-stroke-risk-calibrated-xgb";

    // Translation dictionaries for English and German
    const translations = {
      en: {
        appTitle: "iGFAP Check",
        codePrompt: "üîë Please enter your access code:",
        accessCodeButton: "Submit",
        homeButton: "üè† Home",
        moduleSelectionTitle: "Check probability for:",
        comaModuleButton: "Intracranial hemorrhage in comatose patients (GCS 3-8)",
        strokeModuleButton: "Intracerebral hemorrhage in patients with stroke symptoms",
        strokeChoiceTitle: "Choose Model Pathway",
        standardModelButton: "Standard Model (3 inputs)",
        advancedModelButton: "Advanced Model",
        standardPrereqTitle: "Standard Model Prerequisites",
        prereq1: "Confirmed time window < 6 hours",
        prereq2: "No prior neurological deficits",
        prereq3: "No identifiable head trauma",
        prereq4: "FAST ED Score ‚â• 3",
        nextButton: "Next",
        standardStrokeTitle: "Intracerebral Hemorrhage (Standard)",
        backButton: "‚¨ÖÔ∏è Back",
        advancedPrereqTitle: "Advanced Model Prerequisites",
        advancedChoiceTitle: "Advanced Model Versions",
        rapidVersionButton: "Schnell ‚ÅÑ Rapid (5 inputs)",
        maxVersionButton: "Max (13 inputs)",
        rapidTitle: "Rapid Model (Schnell)",
        ageLabel: "Patient Age (Years)",
        fastEdLabel: "FAST ED Score",
        headacheLabel: "Headache ‚úÖ",
        sbpLabel: "Systolic BP (mmHg)",
        gfapLabel: "GFAP Value (pg/mL)",
        maxTitle: "Max Model (13 inputs)",
        dbpLabel: "Diastolic BP (mmHg)",
        advFastEdDisplayLabel: "FAST ED Score:",
        toggleFastEdBtnTextCalculate: "Calculate/Edit",
        fastEdInfoText: "Select present findings for FAST ED:",
        fastEdFacialPalsyLabel: "Facial Palsy (Partial/Complete)",
        fastEdArmWeaknessLabel: "Arm Weakness",
        fastEdArm0Label: "0 ‚Äì No drift",
        fastEdArm1Label: "1 ‚Äì Drifts down",
        fastEdArm2Label: "2 ‚Äì No effort / Falls",
        fastEdSpeechChangesLabel: "Speech Changes",
        fastEdSpeech0Label: "0 ‚Äì Normal",
        fastEdSpeech1Label: "1 ‚Äì Mild/Moderate",
        fastEdSpeech2Label: "2 ‚Äì Severe/Mute",
        fastEdEyeDeviationLabel: "Eye Deviation",
        fastEdEye0Label: "0 ‚Äì Absent",
        fastEdEye1Label: "1 ‚Äì Partial",
        fastEdEye2Label: "2 ‚Äì Forced Deviation",
        fastEdDenialNeglectLabel: "Denial/Neglect",
        fastEdDenial0Label: "0 ‚Äì Absent",
        fastEdDenial1Label: "1 ‚Äì Mild (Extinction)",
        fastEdDenial2Label: "2 ‚Äì Severe (Unawareness)",
        advAdditionalSymptomsLabel: "Additional Symptoms & History (Check if Present/Yes):",
        advEyeDeviationFlippedLabel: "Eye Deviation (Symptom)",
        advArmPareseFlippedLabel: "Arm Paresis (Symptom)",
        advBeinPareseFlippedLabel: "Leg Paresis (Symptom)",
        advVigilanzminderungLabel: "Altered Sensorium",
        advAfibLabel: "Known Atrial Fibrillation",
        advHeadacheLabel: "Headache",
        advNoakLabel: "On Anticoagulants (NOAK)",
        advAntiplateletsLabel: "On Antiplatelets",
        calculateButton: "Calculate Probability",
        calculateAdvancedStrokeButton: "Calculate Advanced Probability",
        proceedButton: "Proceed to Calculation",
        backToStandardStrokeButton: "‚¨ÖÔ∏è Back to Standard Stroke",
        rangeErrorGFAP: "Please enter a GFAP value between 0 and 50000 pg/mL.",
        invalidInput: "Please enter a valid value!",
        lowRisk: "Low Risk",
        mediumRisk: "Medium Risk",
        highRisk: "High Risk",
        disclaimer:
          "The calculations are for research purposes only, do not make clinical decisions based on it.",
        confirmButton: "Confirm",
        probability: "Probability",
        riskLevel: "Risk Level",
        sbpError: "Valid SBP range: 50-300 mmHg.",
        dbpError: "Valid DBP range: 30-200 mmHg.",
        fastEdError: "Invalid FAST ED Score (0-9).",
        invalidAge: "Please enter valid age (18-120).",
        invalidGFAP: "Invalid GFAP value. Must be between 0 and 50000.",
        serverError: "A server error occurred. Please try again later.",
        gfapPlaceholder: "GFAP Value (pg/mL)",
        agePlaceholder: "Patient Age (Years)",
        sbpPlaceholder: "Systolic BP (mmHg)",
        dbpPlaceholder: "e.g., 90",
        accessCodePlaceholder: "Enter code",
        darkModeToggleLabelOn: "Switch to Light Mode",
        darkModeToggleLabelOff: "Switch to Dark Mode",
        advAgeLabel: "Patient Age (Years)",
        advGfapLabel: "GFAP Value (pg/mL)",
        advSbpLabel: "Systolic BP (mmHg)",
        advDbpLabel: "Diastolic BP (mmHg)",
      },
      de: {
        appTitle: "iGFAP Check",
        codePrompt: "üîë Bitte geben Sie Ihren Zugangscode ein:",
        accessCodeButton: "Absenden",
        homeButton: "üè† Startseite",
        moduleSelectionTitle: "Wahrscheinlichkeit pr√ºfen f√ºr:",
        comaModuleButton: "Intrakranielle Blutungen bei komat√∂sen Patienten (GCS 3-8)",
        strokeModuleButton: "Intrazerebrale Blutungen bei Patienten mit Schlaganfallsymptomen",
        strokeChoiceTitle: "Modellpfad w√§hlen",
        standardModelButton: "Standardmodell (3 Eingaben)",
        advancedModelButton: "Erweitertes Modell",
        standardPrereqTitle: "Voraussetzungen f√ºr das Standardmodell",
        prereq1: "Best√§tigtes Zeitfenster < 6 Stunden",
        prereq2: "Keine vorherigen neurologischen Defizite",
        prereq3: "Keine erkennbare Kopfverletzung",
        prereq4: "FAST ED Score ‚â• 3",
        nextButton: "Weiter",
        standardStrokeTitle: "Intrazerebrale Blutung (Standard)",
        backButton: "‚¨ÖÔ∏è Zur√ºck",
        advancedPrereqTitle: "Voraussetzungen f√ºr das erweiterte Modell",
        advancedChoiceTitle: "Versionen des erweiterten Modells",
        rapidVersionButton: "Schnell (5 Eingaben)",
        maxVersionButton: "Max (13 Eingaben)",
        rapidTitle: "Schnell-Modell",
        ageLabel: "Patientenalter (Jahre)",
        fastEdLabel: "FAST ED Score",
        headacheLabel: "Kopfschmerzen ‚úÖ",
        sbpLabel: "Systolischer Blutdruck (mmHg)",
        gfapLabel: "GFAP-Wert (pg/mL)",
        maxTitle: "Max-Modell (13 Eingaben)",
        dbpLabel: "Diastolischer Blutdruck (mmHg)",
        advFastEdDisplayLabel: "FAST ED Score:",
        toggleFastEdBtnTextCalculate: "Berechnen/Bearbeiten",
        fastEdInfoText: "W√§hlen Sie vorhandene Befunde f√ºr FAST ED:",
        fastEdFacialPalsyLabel: "Fazialisparese (teilweise/komplett)",
        fastEdArmWeaknessLabel: "Arm-Schw√§che",
        fastEdArm0Label: "0 ‚Äì Kein Absinken",
        fastEdArm1Label: "1 ‚Äì Absinken",
        fastEdArm2Label: "2 ‚Äì Keine Bewegung / F√§llt",
        fastEdSpeechChangesLabel: "Sprachver√§nderungen",
        fastEdSpeech0Label: "0 ‚Äì Normal",
        fastEdSpeech1Label: "1 ‚Äì Leicht/mittelgradig",
        fastEdSpeech2Label: "2 ‚Äì Schwer/Stumm",
        fastEdEyeDeviationLabel: "Blickdeviation",
        fastEdEye0Label: "0 ‚Äì Abwesend",
        fastEdEye1Label: "1 ‚Äì Teilweise",
        fastEdEye2Label: "2 ‚Äì Forcierte Deviation",
        fastEdDenialNeglectLabel: "Verleugnung/Neglect",
        fastEdDenial0Label: "0 ‚Äì Abwesend",
        fastEdDenial1Label: "1 ‚Äì Leicht (z.B. Extinktion)",
        fastEdDenial2Label: "2 ‚Äì Schwer (z.B. Unbewusstheit)",
        advAdditionalSymptomsLabel: "Zus√§tzliche Symptome & Anamnese (Ankreuzen, falls vorhanden/ja):",
        advEyeDeviationFlippedLabel: "Blickdeviation (Symptom)",
        advArmPareseFlippedLabel: "Armparese (Symptom)",
        advBeinPareseFlippedLabel: "Beinparese (Symptom)",
        advVigilanzminderungLabel: "Vigilanzminderung",
        advAfibLabel: "Bekanntes Vorhofflimmern",
        advHeadacheLabel: "Kopfschmerzen",
        advNoakLabel: "Antikoagulanzien (NOAK)",
        advAntiplateletsLabel: "Thrombozytenaggregationshemmer",
        calculateButton: "Wahrscheinlichkeit berechnen",
        calculateAdvancedStrokeButton: "Erweiterte Wahrscheinlichkeit berechnen",
        proceedButton: "Zur Berechnung fortfahren",
        backToStandardStrokeButton: "‚¨ÖÔ∏è Zur√ºck zum Standard-Schlaganfall",
        rangeErrorGFAP: "Bitte geben Sie einen GFAP-Wert zwischen 0 und 50000 pg/mL ein.",
        invalidInput: "Bitte geben Sie einen g√ºltigen Wert ein!",
        lowRisk: "Geringes Risiko",
        mediumRisk: "Mittleres Risiko",
        highRisk: "Hohes Risiko",
        disclaimer:
          "Die Berechnungen dienen nur Forschungszwecken. Treffen Sie keine klinischen Entscheidungen auf dieser Grundlage.",
        confirmButton: "Best√§tigen",
        probability: "Wahrscheinlichkeit",
        riskLevel: "Risikostufe",
        sbpError: "G√ºltiger systolischer Blutdruckbereich: 50-300 mmHg.",
        dbpError: "G√ºltiger diastolischer Blutdruck: 30-200 mmHg.",
        fastEdError: "Ung√ºltiger FAST-ED-Score (0-9).",
        invalidAge: "Bitte geben Sie ein g√ºltiges Alter ein (18-120).",
        invalidGFAP: "Ung√ºltiger GFAP-Wert. Muss zwischen 0 und 50000 liegen.",
        serverError: "Ein Serverfehler ist aufgetreten. Bitte versuchen Sie es sp√§ter erneut.",
        gfapPlaceholder: "GFAP-Wert (pg/mL)",
        agePlaceholder: "Patientenalter (Jahre)",
        sbpPlaceholder: "Systolischer Blutdruck (mmHg)",
        dbpPlaceholder: "z.B. 90",
        accessCodePlaceholder: "Code eingeben",
        darkModeToggleLabelOn: "Wechseln zu Hellmodus",
        darkModeToggleLabelOff: "Wechseln zu Dunkelmodus",
        advAgeLabel: "Patientenalter (Jahre)",
        advGfapLabel: "GFAP-Wert (pg/mL)",
        advSbpLabel: "Systolischer Blutdruck (mmHg)",
        advDbpLabel: "Diastolischer Blutdruck (mmHg)",
      },
    };

    // List of all section IDs for show/hide functionality
    const ALL_SECTIONS = [
      "codeEntrySection",
      "moduleSelectionSection",
      "comaModuleSection",
      "strokeChoiceSection",
      "standardPrerequisitesSection",
      "standardStrokeModuleSection",
      "advancedPrerequisitesSection",
      "advancedChoiceSection",
      "rapidModuleSection",
      "maxModuleSection"
    ];

    /**
     * Show only the specified section by removing 'hidden' from that ID
     * and adding 'hidden' to all others.
     */
    function showSection(sectionIdToShow) {
      ALL_SECTIONS.forEach((id) => {
        const section = document.getElementById(id);
        if (section) {
          if (id === sectionIdToShow) {
            section.classList.remove("hidden");
          } else {
            section.classList.add("hidden");
          }
        }
      });
    }

    /**
     * Update text content of an element (or its inner <span>) using translations.
     */
    function updateTextContent(elementId, translationKey) {
      const element = document.getElementById(elementId);
      if (
        element &&
        translations[currentLang] &&
        translations[currentLang][translationKey] !== undefined
      ) {
        const target = element.querySelector("span") || element;
        target.textContent = translations[currentLang][translationKey];
      }
    }

    /**
     * Switch UI language between English and German.
     */
    function switchLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      localStorage.setItem("language", lang);
      const texts = translations[lang] || translations.en;

      // 1) Update all elements with data-translate attribute
      document.querySelectorAll("[data-translate]").forEach((el) => {
        const key = el.dataset.translate;
        const target = el.querySelector("span") || el;
        if (texts[key] !== undefined) {
          target.textContent = texts[key];
        }
      });

      // 2) Update placeholder translations
      document
        .querySelectorAll("[data-translate-placeholder]")
        .forEach((el) => {
          const key = el.dataset.translatePlaceholder;
          if (texts[key] !== undefined) {
            el.placeholder = texts[key];
          }
        });

      // 3) Update specific elements by ID that don't use data-translate
      const toUpdate = [
        ["appTitle", "appTitle"],
        ["moduleSelectionTitle", "moduleSelectionTitle"],
        ["comaModuleButton", "comaModuleButton"],
        ["strokeModuleButton", "strokeModuleButton"],
        ["comaModuleTitle", "comaModuleTitle"],
        ["gfapComaLabel", "gfapLabel"],
        ["calculateComaButton", "calculateButton"],
        ["comaBackButton", "backButton"],
        ["strokeChoiceTitle", "strokeChoiceTitle"],
        ["standardModelButton", "standardModelButton"],
        ["advancedModelButton", "advancedModelButton"],
        ["standardPrereqTitle", "standardPrereqTitle"],
        ["stdPrereq1", "prereq1"],
        ["stdPrereq2", "prereq2"],
        ["stdPrereq3", "prereq3"],
        ["stdPrereq4", "prereq4"],
        ["standardNextButton", "nextButton"],
        ["standardBackButton", "backButton"],
        ["standardStrokeTitle", "standardStrokeTitle"],
        ["stdAgeInput", "ageLabel"],
        ["stdGfapInput", "gfapLabel"],
        ["stdSbpInput", "sbpLabel"],
        ["calculateStandardButton", "calculateButton"],
        ["stdBackButton", "backButton"],
        ["advancedPrereqTitle", "advancedPrereqTitle"],
        ["advPrereq1", "prereq1"],
        ["advPrereq2", "prereq2"],
        ["advPrereq3", "prereq3"],
        ["advancedNextButton", "nextButton"],
        ["advancedBackButton", "backButton"],
        ["advancedChoiceTitle", "advancedChoiceTitle"],
        ["rapidVersionButton", "rapidVersionButton"],
        ["maxVersionButton", "maxVersionButton"],
        ["advChoiceBackButton", "backButton"],
        ["rapidTitle", "rapidTitle"],
        ["rapAgeInput", "ageLabel"],
        ["rapFastEdInput", "fastEdLabel"],
        ["rapHeadacheInput", "headacheLabel"],
        ["rapSbpInput", "sbpLabel"],
        ["rapGfapInput", "gfapLabel"],
        ["calculateRapidButton", "calculateButton"],
        ["rapidBackButton", "backButton"],
        ["maxTitle", "maxTitle"],
        ["maxAgeInput", "ageLabel"],
        ["maxGfapInput", "gfapLabel"],
        ["maxSbpInput", "sbpLabel"],
        ["maxDbpInput", "dbpLabel"],
        ["maxFastEdDisplayLabel", "advFastEdDisplayLabel"],
        ["maxToggleFastEdBtnText", "toggleFastEdBtnTextCalculate"],
        ["fastEdInfoTextMax", "fastEdInfoText"],
        ["fastEdFacialPalsyLabelMax", "fastEdFacialPalsyLabel"],
        ["fastEdArmWeaknessLabelMax", "fastEdArmWeaknessLabel"],
        ["fastEdArm0LabelMax", "fastEdArm0Label"],
        ["fastEdArm1LabelMax", "fastEdArm1Label"],
        ["fastEdArm2LabelMax", "fastEdArm2Label"],
        ["fastEdSpeechChangesLabelMax", "fastEdSpeechChangesLabel"],
        ["fastEdSpeech0LabelMax", "fastEdSpeech0Label"],
        ["fastEdSpeech1LabelMax", "fastEdSpeech1Label"],
        ["fastEdSpeech2LabelMax", "fastEdSpeech2Label"],
        ["fastEdEyeDeviationLabelMax", "fastEdEyeDeviationLabel"],
        ["fastEdEye0LabelMax", "fastEdEye0Label"],
        ["fastEdEye1LabelMax", "fastEdEye1Label"],
        ["fastEdEye2LabelMax", "fastEdEye2Label"],
        ["fastEdDenialNeglectLabelMax", "fastEdDenialNeglectLabel"],
        ["fastEdDenial0LabelMax", "fastEdDenial0Label"],
        ["fastEdDenial1LabelMax", "fastEdDenial1Label"],
        ["fastEdDenial2LabelMax", "fastEdDenial2Label"],
        ["maxAdditionalSymptomsLabel", "advAdditionalSymptomsLabel"],
        ["advEyeDeviationFlippedLabelMax", "advEyeDeviationFlippedLabel"],
        ["advArmPareseFlippedLabelMax", "advArmPareseFlippedLabel"],
        ["advBeinPareseFlippedLabelMax", "advBeinPareseFlippedLabel"],
        ["advVigilanzminderungLabelMax", "advVigilanzminderungLabel"],
        ["advAfibLabelMax", "advAfibLabel"],
        ["advHeadacheLabelMax", "advHeadacheLabel"],
        ["advNoakLabelMax", "advNoakLabel"],
        ["advAntiplateletsLabelMax", "advAntiplateletsLabel"],
        ["calculateMaxButton", "calculateAdvancedStrokeButton"],
        ["maxBackButton", "backButton"],
        ["disclaimerModalTitleText", "disclaimer"],
        ["disclaimerConfirmButton", "confirmButton"],
      ];

      toUpdate.forEach(([elId, key]) => {
        updateTextContent(elId, key);
      });

      // 4) Dark-Mode Toggle aria-label & icon
      const darkModeButton = document.getElementById("darkModeToggle");
      if (darkModeButton) {
        const iconSpan = darkModeButton.querySelector("span");
        if (document.body.classList.contains("dark-mode")) {
          darkModeButton.setAttribute("aria-label", texts.darkModeToggleLabelOn);
          if (iconSpan) iconSpan.textContent = "‚òÄÔ∏è";
        } else {
          darkModeButton.setAttribute("aria-label", texts.darkModeToggleLabelOff);
          if (iconSpan) iconSpan.textContent = "üåô";
        }
      }

      // 5) If any error messages are visible, update their text as well
      ["accessError", "prerequisiteError", "advancedStrokeError"].forEach(
        (errId) => {
          const errEl = document.getElementById(errId);
          if (errEl && !errEl.classList.contains("hidden")) {
            let key = errId;
            if (errId === "accessError" && errEl.dataset.isServerError === "true") {
              key = "serverError";
            }
            errEl.textContent = texts[key] || "An error occurred.";
          }
        }
      );
    }

    /**
     * Clear Coma Module inputs and hide result
     */
    function resetComaModuleInputs() {
      const gfapInput = document.getElementById("gfapComaInput");
      if (gfapInput) gfapInput.value = "";
      const comaResult = document.getElementById("comaResult");
      if (comaResult) {
        comaResult.classList.add("hidden");
        comaResult.innerHTML = "";
        comaResult.className = "result hidden";
      }
    }

    /**
     * Clear Standard Stroke Module inputs
     */
    function resetStandardStrokeInputs() {
      ["stdAgeInput", "stdGfapInput", "stdSbpInput"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      const result = document.getElementById("standardResult");
      if (result) {
        result.classList.add("hidden");
        result.innerHTML = "";
        result.className = "result hidden";
      }
      const error = document.getElementById("standardError");
      if (error) error.classList.add("hidden");
    }

    /**
     * Clear Rapid Stroke Module inputs
     */
    function resetRapidStrokeInputs() {
      ["rapAgeInput", "rapFastEdInput", "rapSbpInput", "rapGfapInput"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      const headacheInput = document.getElementById("rapHeadacheInput");
      if (headacheInput) headacheInput.checked = false;
      const result = document.getElementById("rapidResult");
      if (result) {
        result.classList.add("hidden");
        result.innerHTML = "";
        result.className = "result hidden";
      }
      const error = document.getElementById("rapidError");
      if (error) error.classList.add("hidden");
    }

    /**
     * Clear Max Stroke Module inputs
     */
    function resetMaxStrokeInputs() {
      // Clear basic fields
      const fieldsToClear = [
        "maxAgeInput",
        "maxGfapInput",
        "maxSbpInput",
        "maxDbpInput",
      ];
      fieldsToClear.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });

      // Clear symptom checkboxes and FAST ED toggles
      const checkboxesToClear = [
        "maxEyeDeviationInput",
        "maxArmParesisInput",
        "maxLegParesisInput",
        "maxVigilanceInput",
        "maxAfibInput",
        "maxHeadacheInput",
        "maxNoakInput",
        "maxAntiplateletsInput",
        "maxFastEdFacialPalsy",
      ];
      checkboxesToClear.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.checked = false;
      });

      // Reset FAST ED select values to 0
      const selectsToReset = {
        maxFastEdArmWeakness: "0",
        maxFastEdSpeechChanges: "0",
        maxFastEdEyeDeviation: "0",
        maxFastEdDenialNeglect: "0",
      };
      Object.keys(selectsToReset).forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.value = selectsToReset[id];
      });

      // Update displayed FAST ED score after clearing
      updateMaxFastEdScore();

      // Hide score component container and reset toggle button for FAST ED
      const fastEdContainer = document.getElementById("fastEdComponentsContainerMax");
      if (fastEdContainer) fastEdContainer.classList.add("hidden");
      const fastEdBtn = document.getElementById("maxToggleFastEdBtn");
      if (fastEdBtn) fastEdBtn.setAttribute("aria-expanded", "false");
      const fastEdBtnTextEl = document.getElementById("maxToggleFastEdBtnText");
      if (fastEdBtnTextEl && translations[currentLang]) {
        fastEdBtnTextEl.textContent =
          translations[currentLang].toggleFastEdBtnTextCalculate || "Calculate/Edit";
      }

      // Hide result and error elements
      const resultEl = document.getElementById("maxResult");
      if (resultEl) {
        resultEl.classList.add("hidden");
        resultEl.innerHTML = "";
        resultEl.className = "result hidden";
      }
      const errorEl = document.getElementById("maxError");
      if (errorEl) errorEl.classList.add("hidden");
    }

    /**
     * Navigate to module selection screen if authenticated; otherwise show access code entry.
     */
    function navigateToModuleSelection() {
      // Check if user is authenticated
      if (sessionStorage.getItem("isAuthenticated") !== "true") {
        showSection("codeEntrySection");
        return;
      }

      // Show module selection, reset other modules
      showSection("moduleSelectionSection");
      resetComaModuleInputs();
      resetStandardStrokeInputs();
      resetRapidStrokeInputs();
      resetMaxStrokeInputs();
      ["accessCodeInput", "accessError"].forEach(
        (id) => {
          const el = document.getElementById(id);
          if (el) {
            if (el.tagName === "INPUT") el.value = ""; // Clear input fields
            else el.classList.add("hidden"); // Hide error messages
          }
        }
      );
    }

    /**
     * Navigate back to code entry (log out).
     */
    function navigateToCodeEntry() {
      showSection("codeEntrySection");
      resetComaModuleInputs();
      resetStandardStrokeInputs();
      resetRapidStrokeInputs();
      resetMaxStrokeInputs();
      const accessCodeInput = document.getElementById("accessCodeInput");
      if (accessCodeInput) {
        accessCodeInput.value = "";
        accessCodeInput.focus();
      }
      const accessErrorEl = document.getElementById("accessError");
      if (accessErrorEl) accessErrorEl.classList.add("hidden");
    }

    /**
     * Determine risk category (low/medium/high) based on probability percentage.
     */
    function updateRiskStratification(probability) {
      let riskLevel, riskClass;
      if (probability < 25) {
        riskLevel = translations[currentLang].lowRisk;
        riskClass = "low-risk";
      } else if (probability < 50) {
        riskLevel = translations[currentLang].mediumRisk;
        riskClass = "medium-risk";
      } else {
        riskLevel = translations[currentLang].highRisk;
        riskClass = "red-risk";
      }
      return { riskLevel, riskClass };
    }

    /**
     * Validate the access code by sending it to the backend.
     */
    async function validateAccessCode() {
      const accessCodeInput = document.getElementById("accessCodeInput");
      const accessErrorEl = document.getElementById("accessError");
      const accessCodeButton = document.getElementById("accessCodeButton");
      if (!accessCodeInput || !accessErrorEl || !accessCodeButton) return;

      const accessCode = accessCodeInput.value.trim();
      if (!accessCode) {
        accessErrorEl.textContent = translations[currentLang].invalidInput;
        accessErrorEl.classList.remove("hidden");
        accessErrorEl.dataset.isServerError = "false";
        return;
      }

      setButtonLoading(accessCodeButton, true);
      accessErrorEl.classList.add("hidden");

      try {
        const response = await fetch(ACCESS_CODE_VALIDATOR_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ accessCode }),
        });
        const data = await response.json();
        if (response.ok && data.success) {
          sessionStorage.setItem("isAuthenticated", "true");
          navigateToModuleSelection();
        } else {
          accessErrorEl.textContent = data.message || translations[currentLang].accessError;
          accessErrorEl.classList.remove("hidden");
          accessErrorEl.dataset.isServerError = String(response.status >= 500);
        }
      } catch (error) {
        console.error("Error validating access code:", error);
        accessErrorEl.textContent = translations[currentLang].serverError;
        accessErrorEl.classList.remove("hidden");
        accessErrorEl.dataset.isServerError = "true";
      } finally {
        setButtonLoading(accessCodeButton, false);
      }
    }

    /**
     * Show the Coma Module.
     */
    function startComaModule() {
      showSection("comaModuleSection");
      resetComaModuleInputs();
      document.getElementById("gfapComaInput")?.focus();
    }

    /**
     * Show the Stroke Module Choice.
     */
    function startStrokeModule() {
      showSection("strokeChoiceSection");
      resetStandardStrokeInputs();
      resetRapidStrokeInputs();
      resetMaxStrokeInputs();
    }

    /**
     * Validate standard stroke prerequisites.
     */
    function validateStandardPrerequisites() {
      const checksMet = ["stdPrereq1", "stdPrereq2", "stdPrereq3", "stdPrereq4"].every(
        (id) => document.getElementById(id)?.checked
      );

      const errorEl = document.getElementById("standardPrereqError");
      if (checksMet) {
        showSection("standardStrokeModuleSection");
        document.getElementById("stdAgeInput")?.focus();
        if (errorEl) errorEl.classList.add("hidden");
      } else {
        if (errorEl) {
          errorEl.textContent = "All prerequisites must be met to proceed";
          errorEl.classList.remove("hidden");
        }
      }
    }

    /**
     * Validate advanced stroke prerequisites.
     */
    function validateAdvancedPrerequisites() {
      const checksMet = ["advPrereq1", "advPrereq2", "advPrereq3"].every(
        (id) => document.getElementById(id)?.checked
      );

      const errorEl = document.getElementById("advancedPrereqError");
      if (checksMet) {
        showSection("advancedChoiceSection");
        if (errorEl) errorEl.classList.add("hidden");
      } else {
        if (errorEl) {
          errorEl.textContent = "All prerequisites must be met to proceed";
          errorEl.classList.remove("hidden");
        }
      }
    }

    /**
     * Show disclaimer modal.
     */
    function showDisclaimer() {
      const modal = document.getElementById("disclaimerModal");
      const confirmBtn = document.getElementById("disclaimerConfirmButton");
      if (!modal || !confirmBtn) return;
      modal.style.display = "flex";
      setTimeout(() => {
        modal.classList.add("show");
        confirmBtn.focus();
      }, 10);
    }

    /**
     * Close disclaimer modal and show pending result.
     */
    function closeDisclaimer() {
      const modal = document.getElementById("disclaimerModal");
      if (!modal) return;
      modal.classList.remove("show");
      modal.addEventListener(
        "transitionend",
        function handler() {
          modal.style.display = "none";
          modal.removeEventListener("transitionend", handler);
          if (pendingResult) {
            let focusButtonId = null;
            if (pendingResult.element.id === "comaResult")
              focusButtonId = "calculateComaButton";
            else if (pendingResult.element.id === "standardResult")
              focusButtonId = "calculateStandardButton";
            else if (pendingResult.element.id === "rapidResult")
              focusButtonId = "calculateRapidButton";
            else if (pendingResult.element.id === "maxResult")
              focusButtonId = "calculateMaxButton";
            document.getElementById(focusButtonId)?.focus();
            // Apply risk class to result elements
            if (pendingResult.element.id.includes("Result")) {
              pendingResult.element.classList.add(pendingResult.riskClass);
            }
          }
        },
        { once: true }
      );
    }

    /**
     * Setup FAST-ED score calculator for Max module.
     */
    function setupMaxFastEdScore() {
      const toggleBtn = document.getElementById("maxToggleFastEdBtn");
      const componentsDiv = document.getElementById("fastEdComponentsContainerMax");
      const scoreDisplay = document.getElementById("maxFastEdScoreDisplay");
      const hiddenInput = document.getElementById("maxFastEdInput");
      const toggleBtnTextEl = document.getElementById("maxToggleFastEdBtnText");

      if (!toggleBtn || !componentsDiv || !scoreDisplay || !hiddenInput || !toggleBtnTextEl) {
        console.warn("Missing elements for FAST ED score calculator");
        return () => {};
      }

      function calculateAndUpdate() {
        let currentScore = 0;
        
        // Facial Palsy (checkbox - 1 point)
        const facialPalsy = document.getElementById("maxFastEdFacialPalsy");
        if (facialPalsy && facialPalsy.checked) currentScore += 1;
        
        // Arm Weakness (select - 0-2 points)
        const armWeakness = document.getElementById("maxFastEdArmWeakness");
        if (armWeakness) currentScore += parseInt(armWeakness.value);
        
        // Speech Changes (select - 0-2 points)
        const speechChanges = document.getElementById("maxFastEdSpeechChanges");
        if (speechChanges) currentScore += parseInt(speechChanges.value);
        
        // Eye Deviation (select - 0-2 points)
        const eyeDeviation = document.getElementById("maxFastEdEyeDeviation");
        if (eyeDeviation) currentScore += parseInt(eyeDeviation.value);
        
        // Denial/Neglect (select - 0-2 points)
        const denialNeglect = document.getElementById("maxFastEdDenialNeglect");
        if (denialNeglect) currentScore += parseInt(denialNeglect.value);
        
        scoreDisplay.textContent = currentScore;
        hiddenInput.value = currentScore;
      }

      // Add event listeners to all score components
      document.querySelectorAll("#fastEdComponentsContainerMax input, #fastEdComponentsContainerMax select")
        .forEach(el => el.addEventListener("change", calculateAndUpdate));
      
      toggleBtn.addEventListener("click", () => {
        const isHiddenAfterToggle = componentsDiv.classList.toggle("hidden");
        toggleBtn.setAttribute("aria-expanded", String(!isHiddenAfterToggle));
        let calculateKey = "toggleFastEdBtnTextCalculate";
        let hideKey = "toggleFastEdBtnTextHide";
        toggleBtnTextEl.textContent =
          translations[currentLang][isHiddenAfterToggle ? calculateKey : hideKey];
      });
      
      calculateAndUpdate(); // Initial calculation
      return calculateAndUpdate; // Return the function so it can be called externally if needed
    }

    /**
     * Calculate coma risk.
     */
    async function calculateComaRisk() {
      const gfapInput = document.getElementById("gfapComaInput");
      const resultEl = document.getElementById("comaResult");
      const calculateButton = document.getElementById("calculateComaButton");
      if (!gfapInput || !resultEl || !calculateButton) return;

      const gfap = parseFloat(gfapInput.value);
      resultEl.className = "result hidden"; // Reset classes

      if (isNaN(gfap) || gfap < 29 || gfap > 10001) {
        resultEl.textContent = translations[currentLang].invalidGFAP;
        resultEl.classList.add("warning");
        resultEl.classList.remove("hidden");
        gfapInput.focus();
        return;
      }

      setButtonLoading(calculateButton, true);
      try {
        const response = await fetch(COMA_CALCULATOR_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gfap }),
        });
        const data = await response.json();
        if (response.ok && data.success) {
          showDisclaimer();
          const { riskLevel, riskClass } = updateRiskStratification(data.probability);
          pendingResult = {
            element: resultEl,
            html:
              `<strong>${translations[currentLang].probability}:</strong> ${data.probability.toFixed(
                1
              )}%<br>
               <strong>${translations[currentLang].riskLevel}:</strong> ${riskLevel}`,
            baseClass: "result",
            riskClass: riskClass,
          };
        } else {
          resultEl.textContent = data.message || translations[currentLang].serverError;
          resultEl.classList.add("warning");
          resultEl.classList.remove("hidden");
        }
      } catch (error) {
        console.error("Error calculating coma risk:", error);
        resultEl.textContent = translations[currentLang].serverError;
        resultEl.classList.add("warning");
        resultEl.classList.remove("hidden");
      } finally {
        setButtonLoading(calculateButton, false);
      }
    }

    /**
     * Calculate standard stroke risk.
     */
    async function calculateStandardStrokeRisk() {
      const ageInput = document.getElementById("stdAgeInput");
      const gfapInput = document.getElementById("stdGfapInput");
      const sbpInput = document.getElementById("stdSbpInput");
      const resultEl = document.getElementById("standardResult");
      const calculateButton = document.getElementById("calculateStandardButton");
      if (!ageInput || !gfapInput || !sbpInput || !resultEl || !calculateButton) return;

      const age = parseInt(ageInput.value, 10);
      const gfap = parseFloat(gfapInput.value);
      const sbp = parseFloat(sbpInput.value);
      resultEl.className = "result hidden"; // Reset classes

      if (isNaN(age) || age < 18 || age > 120) {
        resultEl.textContent = translations[currentLang].invalidAge;
        resultEl.classList.add("warning");
        resultEl.classList.remove("hidden");
        ageInput.focus();
        return;
      }
      if (isNaN(gfap) || gfap < 29 || gfap > 10001) {
        resultEl.textContent = translations[currentLang].invalidGFAP;
        resultEl.classList.add("warning");
        resultEl.classList.remove("hidden");
        gfapInput.focus();
        return;
      }
      if (isNaN(sbp) || sbp < 50 || sbp > 250) {
        resultEl.textContent = translations[currentLang].sbpError;
        resultEl.classList.add("warning");
        resultEl.classList.remove("hidden");
        sbpInput.focus();
        return;
      }

      setButtonLoading(calculateButton, true);
      try {
        const response = await fetch(STANDARD_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ age, gfap, sbp }),
        });
        const data = await response.json();
        if (response.ok && data.success) {
          showDisclaimer();
          const { riskLevel, riskClass } = updateRiskStratification(data.probability);
          pendingResult = {
            element: resultEl,
            html:
              `<strong>${translations[currentLang].probability}:</strong> ${data.probability.toFixed(
                1
              )}%<br>
               <strong>${translations[currentLang].riskLevel}:</strong> ${riskLevel}`,
            baseClass: "result",
            riskClass: riskClass,
          };
        } else {
          resultEl.textContent = data.message || translations[currentLang].serverError;
          resultEl.classList.add("warning");
          resultEl.classList.remove("hidden");
        }
      } catch (error) {
        console.error("Error calculating stroke risk:", error);
        resultEl.textContent = translations[currentLang].serverError;
        resultEl.classList.add("warning");
        resultEl.classList.remove("hidden");
      } finally {
        setButtonLoading(calculateButton, false);
      }
    }

    /**
     * Calculate rapid stroke risk.
     */
    async function calculateRapidStrokeRisk() {
      const ageInput = document.getElementById("rapAgeInput");
      const fastEdInput = document.getElementById("rapFastEdInput");
      const headacheInput = document.getElementById("rapHeadacheInput");
      const sbpInput = document.getElementById("rapSbpInput");
      const gfapInput = document.getElementById("rapGfapInput");
      const resultEl = document.getElementById("rapidResult");
      const calculateButton = document.getElementById("calculateRapidButton");
      if (!ageInput || !fastEdInput || !sbpInput || !gfapInput || !resultEl || !calculateButton) return;

      const age = parseInt(ageInput.value, 10);
      const fastEd = parseInt(fastEdInput.value, 10);
      const headache = headacheInput.checked ? 1 : 0;
      const sbp = parseFloat(sbpInput.value);
      const gfap = parseFloat(gfapInput.value);
      resultEl.className = "result hidden"; // Reset classes

      if (isNaN(age) || age < 18 || age > 120) {
        resultEl.textContent = translations[currentLang].invalidAge;
        resultEl.classList.add("warning");
        resultEl.classList.remove("hidden");
        ageInput.focus();
        return;
      }
      if (isNaN(fastEd) || fastEd < 0 || fastEd > 9) {
        resultEl.textContent = translations[currentLang].fastEdError;
        resultEl.classList.add("warning");
        resultEl.classList.remove("hidden");
        fastEdInput.focus();
        return;
      }
      if (isNaN(sbp) || sbp < 50 || sbp > 250) {
        resultEl.textContent = translations[currentLang].sbpError;
        resultEl.classList.add("warning");
        resultEl.classList.remove("hidden");
        sbpInput.focus();
        return;
      }
      if (isNaN(gfap) || gfap < 29 || gfap > 10001) {
        resultEl.textContent = translations[currentLang].invalidGFAP;
        resultEl.classList.add("warning");
        resultEl.classList.remove("hidden");
        gfapInput.focus();
        return;
      }

      setButtonLoading(calculateButton, true);
      try {
        const response = await fetch(RAPID_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ age, fast_ed: fastEd, headache, sbp, gfap }),
        });
        const data = await response.json();
        if (response.ok && data.success) {
          showDisclaimer();
          const { riskLevel, riskClass } = updateRiskStratification(data.probability);
          pendingResult = {
            element: resultEl,
            html:
              `<strong>${translations[currentLang].probability}:</strong> ${data.probability.toFixed(
                1
              )}%<br>
               <strong>${translations[currentLang].riskLevel}:</strong> ${riskLevel}`,
            baseClass: "result",
            riskClass: riskClass,
          };
        } else {
          resultEl.textContent = data.message || translations[currentLang].serverError;
          resultEl.classList.add("warning");
          resultEl.classList.remove("hidden");
        }
      } catch (error) {
        console.error("Error calculating rapid stroke risk:", error);
        resultEl.textContent = translations[currentLang].serverError;
        resultEl.classList.add("warning");
        resultEl.classList.remove("hidden");
      } finally {
        setButtonLoading(calculateButton, false);
      }
    }

    /**
     * Calculate max stroke risk.
     */
    async function calculateMaxStrokeRisk() {
      const resultEl = document.getElementById("maxResult");
      const errorEl = document.getElementById("maxError");
      const calculateButton = document.getElementById("calculateMaxButton");
      if (!resultEl || !errorEl || !calculateButton) {
        console.error("Max stroke elements missing");
        return;
      }

      resultEl.className = "result hidden";
      errorEl.classList.add("hidden");
      document.querySelectorAll(".input-error").forEach((el) => el.classList.remove("input-error"));

      // Read fields
      const age = parseInt(document.getElementById("maxAgeInput")?.value, 10);
      const gfap = parseFloat(document.getElementById("maxGfapInput")?.value);
      const sbp = parseFloat(document.getElementById("maxSbpInput")?.value);
      const dbp = parseFloat(document.getElementById("maxDbpInput")?.value);
      const fastEd = parseInt(document.getElementById("maxFastEdInput")?.value, 10);

      // Checkboxes
      const eyeDeviation = document.getElementById("maxEyeDeviationInput")?.checked ? 1 : 0;
      const armParese = document.getElementById("maxArmParesisInput")?.checked ? 1 : 0;
      const legParese = document.getElementById("maxLegParesisInput")?.checked ? 1 : 0;
      const vigilance = document.getElementById("maxVigilanceInput")?.checked ? 1 : 0;
      const afib = document.getElementById("maxAfibInput")?.checked ? 1 : 0;
      const headache = document.getElementById("maxHeadacheInput")?.checked ? 1 : 0;
      const noak = document.getElementById("maxNoakInput")?.checked ? 1 : 0;
      const antiplatelets = document.getElementById("maxAntiplateletsInput")?.checked ? 1 : 0;

      // Validate all fields
      const fieldsToValidate = [
        {
          id: "maxAgeInput",
          condition: isNaN(age) || age < 18 || age > 120,
          error: translations[currentLang].invalidAge,
        },
        {
          id: "maxGfapInput",
          condition: isNaN(gfap) || gfap < 0 || gfap > 50000,
          error: translations[currentLang].invalidGFAP,
        },
        {
          id: "maxSbpInput",
          condition: isNaN(sbp) || sbp < 50 || sbp > 300,
          error: translations[currentLang].sbpError,
        },
        {
          id: "maxDbpInput",
          condition: isNaN(dbp) || dbp < 30 || dbp > 200,
          error: translations[currentLang].dbpError,
        },
        {
          id: "maxFastEdInput",
          condition: isNaN(fastEd) || fastEd < 0 || fastEd > 9,
          error: translations[currentLang].fastEdError,
        },
      ];

      let errorMessages = [];
      fieldsToValidate.forEach((field) => {
        if (field.condition) {
          errorMessages.push(field.error);
          document.getElementById(field.id)?.classList.add("input-error");
        }
      });

      if (errorMessages.length > 0) {
        errorEl.innerHTML = errorMessages.join("<br>");
        errorEl.classList.remove("hidden");
        return;
      }

      setButtonLoading(calculateButton, true);

      // Payload keys exactly as expected by your Cloud Function
      const payload = {
        "Age (years)": age,
        "FAST ED Score": fastEd,
        "Eye Deviation Flipped(1ja/0Nein)": eyeDeviation,
        "Armparese Flipped(1ja/0Nein)": armParese,
        "Beinparese Flipped(Ja1/0Nein)": legParese,
        "Vigilanzminderung (1Ja/0Nein)": vigilance,
        "Atrial Fibrillation bekannt(Ja1/Nein0)": afib,
        "Headache(Ja1/Nein0)": headache,
        "Systolic BP": sbp,
        "Diastolic BP": dbp,
        "Antcoagulated-NOAK(Ja1/Nein0)": noak,
        "Antiplatelets(ja1/Nein0)": antiplatelets,
        "GFAP value": gfap,
      };

      try {
        const response = await fetch(MAX_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (response.ok && data.success) {
          showDisclaimer();
          const { riskLevel, riskClass } = updateRiskStratification(data.probability);
          pendingResult = {
            element: resultEl,
            html:
              `<strong>${translations[currentLang].probability}:</strong> ${
                data.probability !== undefined ? data.probability.toFixed(1) : "N/A"
              }%<br>
              <strong>${translations[currentLang].riskLevel}:</strong> <span class="${riskClass}">${riskLevel}</span>`,
            baseClass: "result",
            riskClass: riskClass,
          };
        } else {
          errorEl.textContent = data.message || translations[currentLang].serverError;
          errorEl.classList.remove("hidden");
        }
      } catch (error) {
        console.error("Error calculating max stroke risk:", error);
        errorEl.textContent = translations[currentLang].serverError;
        errorEl.classList.remove("hidden");
      } finally {
        setButtonLoading(calculateButton, false);
      }
    }

    /**
     * Toggle button between loading and normal state.
     */
    function setButtonLoading(buttonElement, isLoading) {
      if (!buttonElement) return;
      if (isLoading) {
        buttonElement.classList.add("loading");
        buttonElement.disabled = true;
      } else {
        buttonElement.classList.remove("loading");
        buttonElement.disabled = false;
      }
    }
    
    /**
     * Update the FAST-ED score display for Max module
     */
    function updateMaxFastEdScore() {
      const scoreDisplay = document.getElementById("maxFastEdScoreDisplay");
      const hiddenInput = document.getElementById("maxFastEdInput");
      if (!scoreDisplay || !hiddenInput) return;
      
      // Recalculate score
      let currentScore = 0;
      
      // Facial Palsy (checkbox - 1 point)
      const facialPalsy = document.getElementById("maxFastEdFacialPalsy");
      if (facialPalsy && facialPalsy.checked) currentScore += 1;
      
      // Arm Weakness (select - 0-2 points)
      const armWeakness = document.getElementById("maxFastEdArmWeakness");
      if (armWeakness) currentScore += parseInt(armWeakness.value);
      
      // Speech Changes (select - 0-2 points)
      const speechChanges = document.getElementById("maxFastEdSpeechChanges");
      if (speechChanges) currentScore += parseInt(speechChanges.value);
      
      // Eye Deviation (select - 0-2 points)
      const eyeDeviation = document.getElementById("maxFastEdEyeDeviation");
      if (eyeDeviation) currentScore += parseInt(eyeDeviation.value);
      
      // Denial/Neglect (select - 0-2 points)
      const denialNeglect = document.getElementById("maxFastEdDenialNeglect");
      if (denialNeglect) currentScore += parseInt(denialNeglect.value);
      
      scoreDisplay.textContent = currentScore;
      hiddenInput.value = currentScore;
    }
    
    /**
     * Back to top functionality
     */
    function setupBackToTop() {
      const backToTopButton = document.getElementById("backToTop");
      if (!backToTopButton) return;
      
      window.addEventListener("scroll", () => {
        if (window.pageYOffset > 300) {
          backToTopButton.style.display = "block";
        } else {
          backToTopButton.style.display = "none";
        }
      });
      
      backToTopButton.addEventListener("click", () => {
        window.scrollTo({
          top: 0,
          behavior: "smooth"
        });
      });
    }
    
    /**
     * Debug function to show API calls in UI
     */
    function updateDebugInfo(url, payload) {
      const debugEl = document.getElementById("debugInfo");
      if (!debugEl) return;
      
      debugEl.innerHTML = `
        API Call: ${url}<br>
        Payload: ${JSON.stringify(payload)}
      `;
    }

    /**
     * DOMContentLoaded event listener: initializes the app.
     */
    document.addEventListener("DOMContentLoaded", function () {
      if (sessionStorage.getItem("isAuthenticated") === "true") {
        navigateToModuleSelection();
      } else {
        showSection("codeEntrySection");
      }

      // Set current year
      if (document.getElementById("currentYear")) {
        document.getElementById("currentYear").textContent = new Date().getFullYear();
      }

      document.getElementById("accessCodeInput")?.focus();

      // Dark-Mode from localStorage and icon
      if (localStorage.getItem("darkMode") === "enabled") {
        document.body.classList.add("dark-mode");
        const darkModeSpan = document
          .getElementById("darkModeToggle")
          ?.querySelector("span");
        if (darkModeSpan) darkModeSpan.textContent = "‚òÄÔ∏è";
      }

      // Preferred language
      const preferredLang = localStorage.getItem("language") || "en";
      switchLanguage(preferredLang);

      // FAST-ED Score setup for Max module
      const updateMaxFastEdScore = setupMaxFastEdScore();

      // Set up back to top button
      setupBackToTop();

      // Register Service Worker if available
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./sw.js")
            .then((reg) => console.log("Service Worker registered with scope:", reg.scope))
            .catch((err) => console.error("Service Worker registration failed:", err));
        });
      }

      // Attach event listeners
      document.getElementById("accessCodeButton")?.addEventListener("click", validateAccessCode);
      document.getElementById("accessCodeInput")?.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          validateAccessCode();
        }
      });
      
      // Coma module
      document.getElementById("comaModuleButton")?.addEventListener("click", startComaModule);
      document.getElementById("calculateComaButton")?.addEventListener("click", calculateComaRisk);
      document.getElementById("gfapComaInput")?.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          calculateComaRisk();
        }
      });
      
      // Stroke module navigation
      document.getElementById("strokeModuleButton")?.addEventListener("click", startStrokeModule);
      document.getElementById("standardModelButton")?.addEventListener("click", () => showSection("standardPrerequisitesSection"));
      document.getElementById("advancedModelButton")?.addEventListener("click", () => showSection("advancedPrerequisitesSection"));
      document.getElementById("standardNextButton")?.addEventListener("click", validateStandardPrerequisites);
      document.getElementById("advancedNextButton")?.addEventListener("click", validateAdvancedPrerequisites);
      document.getElementById("rapidVersionButton")?.addEventListener("click", () => showSection("rapidModuleSection"));
      document.getElementById("maxVersionButton")?.addEventListener("click", () => showSection("maxModuleSection"));
      
      // Back buttons
      document.getElementById("strokeBackButton")?.addEventListener("click", () => showSection("moduleSelectionSection"));
      document.getElementById("standardBackButton")?.addEventListener("click", () => showSection("strokeChoiceSection"));
      document.getElementById("stdBackButton")?.addEventListener("click", () => showSection("standardPrerequisitesSection"));
      document.getElementById("advancedBackButton")?.addEventListener("click", () => showSection("strokeChoiceSection"));
      document.getElementById("advChoiceBackButton")?.addEventListener("click", () => showSection("advancedPrerequisitesSection"));
      document.getElementById("rapidBackButton")?.addEventListener("click", () => showSection("advancedChoiceSection"));
      document.getElementById("maxBackButton")?.addEventListener("click", () => showSection("advancedChoiceSection"));
      document.getElementById("comaBackButton")?.addEventListener("click", navigateToModuleSelection);
      document.getElementById("homeButton")?.addEventListener("click", navigateToModuleSelection);
      
      // Calculation buttons
      document.getElementById("calculateStandardButton")?.addEventListener("click", calculateStandardStrokeRisk);
      document.getElementById("calculateRapidButton")?.addEventListener("click", calculateRapidStrokeRisk);
      document.getElementById("calculateMaxButton")?.addEventListener("click", calculateMaxStrokeRisk);
      
      // Add keyboard support for inputs
      ["stdAgeInput", "stdGfapInput", "stdSbpInput"].forEach((id) => {
        document.getElementById(id)?.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            calculateStandardStrokeRisk();
          }
        });
      });
      
      ["rapAgeInput", "rapFastEdInput", "rapSbpInput", "rapGfapInput"].forEach((id) => {
        document.getElementById(id)?.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            calculateRapidStrokeRisk();
          }
        });
      });
      
      ["maxAgeInput", "maxGfapInput", "maxSbpInput", "maxDbpInput"].forEach((id) => {
        document.getElementById(id)?.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            calculateMaxStrokeRisk();
          }
        });
      });

      // Dark mode toggle
      const darkModeButton = document.getElementById("darkModeToggle");
      darkModeButton?.addEventListener("click", function () {
        document.body.classList.toggle("dark-mode");
        const iconSpan = darkModeButton.querySelector("span");
        const texts = translations[currentLang];
        if (document.body.classList.contains("dark-mode")) {
          if (iconSpan) iconSpan.textContent = "‚òÄÔ∏è";
          darkModeButton.setAttribute("aria-label", texts.darkModeToggleLabelOn);
          localStorage.setItem("darkMode", "enabled");
        } else {
          if (iconSpan) iconSpan.textContent = "üåô";
          darkModeButton.setAttribute("aria-label", texts.darkModeToggleLabelOff);
          localStorage.setItem("darkMode", "disabled");
        }
      });

      // Disclaimer confirmation
      document
        .getElementById("disclaimerConfirmButton")
        ?.addEventListener("click", function () {
          closeDisclaimer();
          if (pendingResult) {
            pendingResult.element.innerHTML = pendingResult.html;
            pendingResult.element.className = `${pendingResult.baseClass}`;
            pendingResult.element.classList.remove("hidden");
            if (pendingResult.riskClass) {
              pendingResult.element.classList.add(pendingResult.riskClass);
            }
            pendingResult = null;
          }
        });
    });
  </script>
</body>
</html>
