<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>iGFAP Check - Mark 4</title>
Â  Â  <link rel="manifest" href="manifest.json">
Â  Â  <meta name="theme-color" content="#007bff">
Â  <style>
Â  Â  /* Root-level CSS variables for theming */
Â  Â  :root {
Â  Â  Â  --primary-color: #007bff;
Â  Â  Â  --primary-hover: #0056b3;
Â  Â  Â  --secondary-color: #dc3545;
Â  Â  Â  --secondary-hover: #b52b3a;
Â  Â  Â  --experimental-color: #ffc107;
Â  Â  Â  --experimental-text-color: #212529;
Â  Â  Â  --experimental-hover: #e0a800;
Â  Â  Â  --background-color: #f8f9fa;
Â  Â  Â  --text-color: #333;
Â  Â  Â  --warning-text-color: #856404;
Â  Â  Â  --warning-bg-color: #fff3cd;
Â  Â  Â  --warning-border-color: #ffeeba;
Â  Â  Â  --loading-spinner-color: var(--primary-color);
Â  Â  }

Â  Â  /* Dark mode overrides for CSS variables */
Â  Â  body.dark-mode {
Â  Â  Â  --primary-color: #3399ff;
Â  Â  Â  --primary-hover: #287ac7;
Â  Â  Â  --secondary-color: #e06666;
Â  Â  Â  --secondary-hover: #cc5252;
Â  Â  Â  --experimental-color: #ffca2c;
Â  Â  Â  --experimental-text-color: #212529;
Â  Â  Â  --experimental-hover: #f5b90a;
Â  Â  Â  --background-color: #333;
Â  Â  Â  --text-color: #f8f9fa;
Â  Â  Â  --warning-text-color: #ffeeba;
Â  Â  Â  --warning-bg-color: #533f03;
Â  Â  Â  --warning-border-color: #856404;
Â  Â  Â  --loading-spinner-color: var(--primary-color);
Â  Â  }

Â  Â  /* Box-sizing reset for all elements */
Â  Â  *, *::before, *::after {
Â  Â  Â  box-sizing: border-box;
Â  Â  }

Â  Â  /* Base body styling */
Â  Â  body {
Â  Â  Â  font-family: 'Arial', sans-serif;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  background-color: var(--background-color);
Â  Â  Â  color: var(--text-color);
Â  Â  Â  transition: background-color 0.3s ease, color 0.3s ease;
Â  Â  }

Â  Â  /* Container styling for central panels */
Â  Â  .container {
Â  Â  Â  max-width: 500px;
Â  Â  Â  margin: 70px auto 20px auto;
Â  Â  Â  padding: 20px;
Â  Â  Â  background-color: white;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
Â  Â  Â  transition: background-color 0.3s ease;
Â  Â  }
Â  Â  /* Dark mode container background */
Â  Â  body.dark-mode .container {
Â  Â  Â  background-color: #444;
Â  Â  }

Â  Â  /* Spacing for input groups and checkbox groups */
Â  Â  .input-group, .checkbox-group {
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  text-align: left;
Â  Â  }

Â  Â  /* Layout for checkbox groups */
Â  Â  .checkbox-group {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  .checkbox-group input[type="checkbox"] {
Â  Â  Â  margin-right: 8px;
Â  Â  Â  width: 1.3em;
Â  Â  Â  height: 1.3em;
Â  Â  }
Â  Â  .checkbox-group label {
Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  /* Styling for number/password inputs and select elements */
Â  Â  .input-group input[type="number"],
Â  Â  .input-group input[type="password"],
Â  Â  select.score-select {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 12px;
Â  Â  Â  font-size: 18px;
Â  Â  Â  border: 2px solid var(--primary-color);
Â  Â  Â  border-radius: 5px;
Â  Â  Â  background-color: var(--background-color);
Â  Â  Â  color: var(--text-color);
Â  Â  }
Â  Â  /* Dark mode override for inputs and selects */
Â  Â  body.dark-mode .input-group input[type="number"],
Â  Â  body.dark-mode .input-group input[type="password"],
Â  Â  body.dark-mode select.score-select {
Â  Â  Â  background-color: #555;
Â  Â  Â  color: var(--text-color);
Â  Â  Â  border-color: var(--primary-color);
Â  Â  }

Â  Â  /* Placeholder text color */
Â  Â  .input-group input::placeholder {
Â  Â  Â  color: #aaa;
Â  Â  }
Â  Â  body.dark-mode .input-group input::placeholder {
Â  Â  Â  color: #888;
Â  Â  }

Â  Â  /* Class for invalid input highlighting */
Â  Â  .input-error {
Â  Â  Â  border: 2px solid var(--secondary-color) !important;
Â  Â  }

Â  Â  /* Base button styling */
Â  Â  button {
Â  Â  Â  padding: 12px;
Â  Â  Â  margin-top: 15px;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 5px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 16px;
Â  Â  Â  transition: background-color 0.3s ease;
Â  Â  Â  width: 100%;
Â  Â  Â  font-weight: bold;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  /* Spinner animation for loading buttons */
Â  Â  button.loading::after {
Â  Â  Â  content: "";
Â  Â  Â  position: absolute;
Â  Â  Â  width: 16px;
Â  Â  Â  height: 16px;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  right: 0;
Â  Â  Â  bottom: 0;
Â  Â  Â  margin: auto;
Â  Â  Â  border: 4px solid transparent;
Â  Â  Â  border-top-color: var(--loading-spinner-color);
Â  Â  Â  border-right-color: var(--loading-spinner-color);
Â  Â  Â  border-radius: 50%;
Â  Â  Â  animation: button-loading-spinner 1s ease infinite;
Â  Â  }
Â  Â  button.loading span {
Â  Â  Â  visibility: hidden;
Â  Â  }

Â  Â  /* Keyframes for loading spinner rotation */
Â  Â  @keyframes button-loading-spinner {
Â  Â  Â  from { transform: rotate(0turn); }
Â  Â  Â  to { transform: rotate(1turn); }
Â  Â  }

Â  Â  /* Primary button appearance */
Â  Â  .primary {
Â  Â  Â  background-color: var(--primary-color);
Â  Â  Â  color: white;
Â  Â  }
Â  Â  .primary:hover { background-color: var(--primary-hover); }
Â  Â  body.dark-mode .primary { --loading-spinner-color: #fff; }

Â  Â  /* Experimental button styling (used for toggling advanced models) */
Â  Â  .experimental {
Â  Â  Â  background-color: var(--experimental-color);
Â  Â  Â  color: var(--experimental-text-color);
Â  Â  Â  border: 1px solid #c69500;
Â  Â  }
Â  Â  .experimental:hover { background-color: var(--experimental-hover); }
Â  Â  body.dark-mode .experimental { --loading-spinner-color: var(--experimental-text-color); }

Â  Â  /* Secondary button styling */
Â  Â  .secondary {
Â  Â  Â  background-color: var(--secondary-color);
Â  Â  Â  color: white;
Â  Â  }
Â  Â  .secondary:hover { background-color: var(--secondary-hover); }
Â  Â  body.dark-mode .secondary { --loading-spinner-color: #fff; }

Â  Â  /* Result box styling */
Â  Â  .result {
Â  Â  Â  margin-top: 1.5rem;
Â  Â  Â  padding: 1rem;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  font-size: 18px;
Â  Â  Â  font-weight: bold;
Â  Â  Â  text-align: center;
Â  Â  Â  border: 1px solid transparent;
Â  Â  }
Â  Â  /* Warning result styling */
Â  Â  .result.warning {
Â  Â  Â  color: var(--warning-text-color);
Â  Â  Â  background-color: var(--warning-bg-color);
Â  Â  Â  border-color: var(--warning-border-color);
Â  Â  }

Â  Â  /* Risk-level color coding */
Â  Â  .low-risk { color: #28a745; }
Â  Â  .medium-risk { color: #daa520; }
Â  Â  .red-risk { color: #dc3545; }
Â  Â  body.dark-mode .low-risk { color: #34d399; }
Â  Â  body.dark-mode .medium-risk { color: #f59e0b; }
Â  Â  body.dark-mode .red-risk { color: #f87171; }

Â  Â  /* Header styling (app bar) */
Â  Â  .app-header {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 10px 20px;
Â  Â  Â  background-color: var(--primary-color);
Â  Â  Â  color: white;
Â  Â  Â  position: sticky;
Â  Â  Â  top: 0;
Â  Â  Â  z-index: 999;
Â  Â  }
Â  Â  .app-header h1 { font-size: 1.5em; margin: 0; }
Â  Â  .header-right { display: flex; align-items: center; gap: 10px; }
Â  Â  .header-right button { width: auto; padding: 8px 12px; margin-top: 0; }

Â  Â  /* Language switcher icons */
Â  Â  .language-switcher img {
Â  Â  Â  width: 24px;
Â  Â  Â  height: 16px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 3px;
Â  Â  Â  vertical-align: middle;
Â  Â  }
Â  Â  .language-switcher button {
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  padding: 5px;
Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  /* Modal overlay styling (for disclaimer) */
Â  Â  .modal {
Â  Â  Â  display: none;
Â  Â  Â  position: fixed;
Â  Â  Â  z-index: 9999;
Â  Â  Â  left: 0;
Â  Â  Â  top: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background-color: rgba(0,0,0,0.6);
Â  Â  Â  opacity: 0;
Â  Â  Â  transition: opacity 0.3s ease;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  }
Â  Â  .modal.show {
Â  Â  Â  display: flex;
Â  Â  Â  opacity: 1;
Â  Â  }
Â  Â  .modal-content {
Â  Â  Â  background-color: #fff;
Â  Â  Â  padding: 20px;
Â  Â  Â  width: 80%;
Â  Â  Â  max-width: 400px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  body.dark-mode .modal-content {
Â  Â  Â  background-color: #444;
Â  Â  }

Â  Â  /* Error message styling */
Â  Â  #accessError, #prerequisiteError, #advancedStrokeError {
Â  Â  Â  color: var(--secondary-color);
Â  Â  Â  margin-top: 10px;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  body.dark-mode #accessError,
Â  Â  body.dark-mode #prerequisiteError,
Â  Â  body.dark-mode #advancedStrokeError {
Â  Â  Â  color: var(--secondary-color);
Â  Â  }

Â  Â  /* Utility class to hide elements */
Â  Â  .hidden { display: none !important; }

Â  Â  /* Styles for interactive score calculator containers */
Â  Â  .score-calculator-group {
Â  Â  Â  border: 1px solid #eee;
Â  Â  Â  padding: 10px;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  border-radius: 5px;
Â  Â  }
Â  Â  body.dark-mode .score-calculator-group {
Â  Â  Â  border-color: #555;
Â  Â  }
Â  Â  .score-header {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 8px;
Â  Â  }
Â  Â  .score-header > label {
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin-right: 10px;
Â  Â  Â  flex-grow: 1;
Â  Â  }
Â  Â  .score-value-display {
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 1.1em;
Â  Â  Â  color: var(--primary-color);
Â  Â  Â  min-width: 25px;
Â  Â  Â  text-align: right;
Â  Â  Â  margin-right: 10px;
Â  Â  }
Â  Â  .calculate-score-btn {
Â  Â  Â  padding: 6px 10px !important;
Â  Â  Â  font-size: 0.9em !important;
Â  Â  Â  width: auto !important;
Â  Â  Â  margin-top: 0 !important;
Â  Â  Â  background-color: #6c757d;
Â  Â  Â  color: white;
Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â  body.dark-mode .calculate-score-btn { background-color: #868e96; }
Â  Â  .calculate-score-btn:hover { background-color: #5a6268; }
Â  Â  body.dark-mode .calculate-score-btn:hover { background-color: #707880; }

Â  Â  /* Score components layout */
Â  Â  .score-components {
Â  Â  Â  padding-top: 10px;
Â  Â  Â  border-top: 1px dashed #ccc;
Â  Â  Â  margin-top: 10px;
Â  Â  }
Â  Â  body.dark-mode .score-components { border-top-color: #555; }
Â  Â  .score-components .checkbox-group,
Â  Â  .score-components .input-group {
Â  Â  Â  margin-left: 0px;
Â  Â  Â  margin-bottom: 10px;
Â  Â  }
Â  Â  .score-components .input-group label,
Â  Â  .score-components .checkbox-group label {
Â  Â  Â  display: block;
Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  font-size: 0.95em;
Â  Â  }
Â  Â  select.score-select {
Â  Â  Â  font-size: 16px;
Â  Â  Â  padding: 10px;
Â  Â  }
Â  </style>
</head>
<body>
Â  Â  <header class="app-header">
Â  Â  <div class="header-left">
Â  Â  Â  <h1 id="appTitle">iGFAP Check</h1>
Â  Â  </div>
Â  Â  <div class="header-right">
Â  Â  Â  Â  Â  Â  <div class="language-switcher">
Â  Â  Â  Â  <button onclick="switchLanguage('en')" aria-label="Switch to English" title="Switch to English">
Â  Â  Â  Â  Â  <img src="https://flagcdn.com/gb.svg" alt="English">
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button onclick="switchLanguage('de')" aria-label="Switch to German" title="Switch to German">
Â  Â  Â  Â  Â  <img src="https://flagcdn.com/de.svg" alt="Deutsch">
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="darkModeToggle" aria-label="Toggle dark mode"><span>ğŸŒ™</span></button>
Â  Â  Â  Â  Â  Â  <button class="home-button" id="homeButton" onclick="navigateToModuleSelection()"><span>ğŸ  Home</span></button>
Â  Â  </div>
Â  </header>

Â  Â  <section id="codeEntrySection" class="container">
Â  Â  <p id="codePrompt">ğŸ”‘ Please enter your access code:</p>
Â  Â  <div class="input-group">
Â  Â  Â  <input type="password" id="accessCodeInput" placeholder="Enter code">
Â  Â  </div>
Â  Â  <button class="primary" id="accessCodeButton"><span>Submit</span></button>
Â  Â  <p id="accessError" class="hidden"></p>
Â  </section>

Â  Â  <section id="moduleSelectionSection" class="container hidden">
Â  Â  <h2 id="moduleSelectionTitle">Check probability for:</h2>
Â  Â  <button class="primary" id="comaModuleButton"><span>Coma Module</span></button>
Â  Â  <button class="primary" id="strokeModuleButton"><span>Intracerebral hemorrhage in patients with stroke symptoms</span></button>
Â  </section>

Â  Â  <section id="comaModuleSection" class="container hidden">
Â  Â  <h2 id="comaModuleTitle">Intracranial hemorrhage in comatose patients (GCS 3-8)</h2>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  <label for="gfapComaInput" id="gfapComaLabel">GFAP Value (pg/mL)</label>
Â  Â  Â  <input type="number" id="gfapComaInput" min="29" max="10001" placeholder="">
Â  Â  </div>
Â  Â  Â  Â  <button class="primary" id="calculateComaButton"><span>Calculate Probability</span></button>
Â  Â  Â  Â  <button class="secondary" id="comaBackButton" onclick="navigateToModuleSelection()"><span>â¬…ï¸ Back</span></button>
Â  Â  Â  Â  <div class="result hidden" id="comaResult" aria-live="polite"></div>
Â  </section>

Â  Â  <section id="strokePrerequisiteSection" class="container hidden">
Â  Â  <h2 id="strokePrerequisiteTitle">Prerequisites for Stroke Risk Calculation</h2>
Â  Â  Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="prerequisite1">
Â  Â  Â  <label for="prerequisite1" id="prerequisite1Label">Confirmed time window < 6 hours</label>
Â  Â  </div>
Â  Â  Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="prerequisite2">
Â  Â  Â  <label for="prerequisite2" id="prerequisite2Label">No neurological deficits before the event</label>
Â  Â  </div>
Â  Â  Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="prerequisite3">
Â  Â  Â  <label for="prerequisite3" id="prerequisite3Label">No identifiable head trauma (severe fall)</label>
Â  Â  </div>
Â  Â  Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="prerequisite4">
Â  Â  Â  <label for="prerequisite4" id="prerequisite4Label">FAST ED Score >= 3 points</label>
Â  Â  </div>
Â  Â  Â  Â  <button class="primary" id="proceedButton"><span>Proceed to Calculation</span></button>
Â  Â  Â  Â  <button class="secondary" id="strokePrerequisiteBackButton" onclick="navigateToModuleSelection()"><span>â¬…ï¸ Back</span></button>
Â  Â  Â  Â  <p id="prerequisiteError" class="hidden"></p>
Â  </section>

Â  Â  <section id="strokeModuleSection" class="container hidden">
Â  Â  <h2 id="strokeModuleTitle">Intracerebral hemorrhage in patients with stroke symptoms (Standard)</h2>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  <label for="ageInput" id="ageLabel">Patient Age (Years)</label>
Â  Â  Â  <input type="number" id="ageInput" min="18" max="120" placeholder="">
Â  Â  </div>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  <label for="gfapStrokeInput" id="gfapStrokeLabel">GFAP Value (pg/mL)</label>
Â  Â  Â  <input type="number" id="gfapStrokeInput" min="29" max="10001" placeholder="">
Â  Â  </div>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  <label for="sbpInput" id="sbpLabel">Systolic BP (mmHg)</label>
Â  Â  Â  <input type="number" id="sbpInput" min="50" max="250" placeholder="">
Â  Â  </div>
Â  Â  Â  Â  <button class="primary" id="calculateStrokeButton"><span>Calculate Probability</span></button>
Â  Â  Â  Â  <button class="experimental" id="switchToAdvancedStrokeButton" style="margin-top: 10px;">
Â  Â  Â  <span>Use Advanced Model (13 Params - Validated)</span>
Â  Â  </button>
Â  Â  Â  Â  <button class="secondary" id="strokeModuleBackButton" onclick="navigateToModuleSelection()"><span>â¬…ï¸ Back</span></button>
Â  Â  Â  Â  <div class="result hidden" id="strokeResult" aria-live="polite"></div>
Â  </section>

Â  Â  <section id="advancedStrokeModuleSection" class="container hidden">
Â  Â  <h2 id="advancedStrokeModuleTitle">Advanced Stroke Model (Validated - 13 Params)</h2>

Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  <label for="advAgeInput" id="advAgeLabel">Patient Age (Years)</label>
Â  Â  Â  <input type="number" id="advAgeInput" min="18" max="120" placeholder="e.g., 75">
Â  Â  </div>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  <label for="advGfapInput" id="advGfapLabel">GFAP Value (pg/mL)</label>
Â  Â  Â  <input type="number" id="advGfapInput" min="0" max="50000" placeholder="e.g., 1500">
Â  Â  </div>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  <label for="advSbpInput" id="advSbpLabel">Systolic BP (mmHg)</label>
Â  Â  Â  <input type="number" id="advSbpInput" min="50" max="300" placeholder="e.g., 160">
Â  Â  </div>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  <label for="advDbpInput" id="advDbpLabel">Diastolic BP (mmHg)</label>
Â  Â  Â  <input type="number" id="advDbpInput" min="30" max="200" placeholder="e.g., 90">
Â  Â  </div>

Â  Â  Â  Â  <div class="input-group score-calculator-group">
Â  Â  Â  <div class="score-header">
Â  Â  Â  Â  <label id="advFastEdDisplayLabel">FAST ED Score:</label>
Â  Â  Â  Â  <span id="advFastEdScoreDisplay" class="score-value-display">0</span>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="calculate-score-btn" id="toggleFastEdBtn" aria-expanded="false" aria-controls="fastEdComponentsContainer">
Â  Â  Â  Â  Â  <span id="toggleFastEdBtnText">Calculate/Edit</span>
Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="advFastEdInput" name="advFastEdInput" value="0">
Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="fastEdComponentsContainer" class="score-components hidden">
Â  Â  Â  Â  <p id="fastEdInfoText" style="font-size: 0.9em; margin-bottom: 5px;">Select present findings for FAST ED:</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="checkbox-group">
Â  Â  Â  Â  Â  <input type="checkbox" id="fastEdFacialPalsy" data-points="1">
Â  Â  Â  Â  Â  <label for="fastEdFacialPalsy" id="fastEdFacialPalsyLabel">Facial Palsy (Partial/Complete)</label>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="fastEdArmWeakness" id="fastEdArmWeaknessLabel">Arm Weakness</label>
Â  Â  Â  Â  Â  <select id="fastEdArmWeakness" class="score-select">
Â  Â  Â  Â  Â  Â  <option value="0" id="fastEdArm0Label">0 - No drift</option>
Â  Â  Â  Â  Â  Â  <option value="1" id="fastEdArm1Label">1 - Drifts down</option>
Â  Â  Â  Â  Â  Â  <option value="2" id="fastEdArm2Label">2 - No effort / Falls</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="fastEdSpeechChanges" id="fastEdSpeechChangesLabel">Speech Changes</label>
Â  Â  Â  Â  Â  <select id="fastEdSpeechChanges" class="score-select">
Â  Â  Â  Â  Â  Â  <option value="0" id="fastEdSpeech0Label">0 - Normal</option>
Â  Â  Â  Â  Â  Â  <option value="1" id="fastEdSpeech1Label">1 - Mild/Moderate</option>
Â  Â  Â  Â  Â  Â  <option value="2" id="fastEdSpeech2Label">2 - Severe/Mute</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="fastEdEyeDeviation" id="fastEdEyeDeviationLabel">Eye Deviation</label>
Â  Â  Â  Â  Â  <select id="fastEdEyeDeviation" class="score-select">
Â  Â  Â  Â  Â  Â  <option value="0" id="fastEdEye0Label">0 - Absent</option>
Â  Â  Â  Â  Â  Â  <option value="1" id="fastEdEye1Label">1 - Partial</option>
Â  Â  Â  Â  Â  Â  <option value="2" id="fastEdEye2Label">2 - Forced Deviation</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="fastEdDenialNeglect" id="fastEdDenialNeglectLabel">Denial/Neglect</label>
Â  Â  Â  Â  Â  <select id="fastEdDenialNeglect" class="score-select">
Â  Â  Â  Â  Â  Â  <option value="0" id="fastEdDenial0Label">0 - Absent</option>
Â  Â  Â  Â  Â  Â  <option value="1" id="fastEdDenial1Label">1 - Mild (e.g., Extinction)</option>
Â  Â  Â  Â  Â  Â  <option value="2" id="fastEdDenial2Label">2 - Severe (e.g., Unawareness)</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <p style="font-weight: bold; margin-top: 20px; margin-bottom: 5px;" id="advAdditionalSymptomsLabel">Additional Symptoms & History (Check if Present/Yes):</p>
Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="advEyeDeviationFlippedInput">
Â  Â  Â  <label for="advEyeDeviationFlippedInput" id="advEyeDeviationFlippedLabel">Eye Deviation (Symptom)</label>
Â  Â  </div>
Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="advArmPareseFlippedInput">
Â  Â  Â  <label for="advArmPareseFlippedInput" id="advArmPareseFlippedLabel">Arm Paresis (Symptom)</label>
Â  Â  </div>
Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="advBeinPareseFlippedInput">
Â  Â  Â  <label for="advBeinPareseFlippedInput" id="advBeinPareseFlippedLabel">Leg Paresis (Symptom)</label>
Â  Â  </div>
Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="advVigilanzminderungInput">
Â  Â  Â  <label for="advVigilanzminderungLabel" id="advVigilanzminderungLabel">Altered Sensorium</label>
Â  Â  </div>
Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="advAfibInput">
Â  Â  Â  <label for="advAfibInput" id="advAfibLabel">Known Atrial Fibrillation</label>
Â  Â  </div>
Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="advHeadacheInput">
Â  Â  Â  <label for="advHeadacheInput" id="advHeadacheLabel">Headache</label>
Â  Â  </div>
Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="advNoakInput">
Â  Â  Â  <label for="advNoakInput" id="advNoakLabel">On Anticoagulants (NOAK)</label>
Â  Â  </div>
Â  Â  <div class="checkbox-group">
Â  Â  Â  <input type="checkbox" id="advAntiplateletsInput">
Â  Â  Â  <label for="advAntiplateletsInput" id="advAntiplateletsLabel">On Antiplatelets</label>
Â  Â  </div>

Â  Â  Â  Â  <button class="primary" id="calculateAdvancedStrokeButton"><span>Calculate Advanced Probability</span></button>
Â  Â  Â  Â  <button class="secondary" id="advancedStrokeModuleBackButton" onclick="navigateToStrokeModule()"><span>â¬…ï¸ Back to Standard Stroke</span></button>
Â  Â  Â  Â  <div class="result hidden" id="advancedStrokeResult" aria-live="polite"></div>
Â  Â  Â  Â  <p id="advancedStrokeError" class="hidden"></p>
Â  </section>

Â  Â  <footer style="text-align:center; margin-top:20px; padding-bottom: 20px;">
Â  Â  <p>Â© <span id="currentYear"></span> iGFAP. All rights reserved.</p>
Â  </footer>

Â  Â  <div id="disclaimerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="disclaimerModalTitleText">
Â  Â  <div class="modal-content">
Â  Â  Â  <p id="disclaimerModalTitleText" class="disclaimer-text">The calculations are for research purposes only, do not make clinical decisions based on it.</p>
Â  Â  Â  <button class="primary" id="disclaimerConfirmButton"><span>Confirm</span></button>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // Current language setting (default English)
Â  Â  let currentLang = 'en';
Â  Â  // Placeholder for pending result data (used for showing after disclaimer)
Â  Â  let pendingResult = null;

Â  Â  // API endpoints for backend calls
Â  Â  const ACCESS_CODE_VALIDATOR_URL = 'https://europe-west3-igfap-452720.cloudfunctions.net/validateAccessCode';
Â  Â  const COMA_CALCULATOR_URL = 'https://europe-west3-igfap-452720.cloudfunctions.net/calculateComaRisk';
Â  Â  const STROKE_CALCULATOR_URL = 'https://europe-west3-igfap-452720.cloudfunctions.net/calculateStrokeRisk';
Â  Â  const ADVANCED_STROKE_CALCULATOR_URL = 'https://europe-west3-igfap-452720.cloudfunctions.net/calculate-advanced-stroke-risk-rf';

Â  Â  // Translation dictionaries for English and German
Â  Â  const translations = {
Â  Â  Â  en: {
Â  Â  Â  Â  appTitle: "iGFAP Check",
Â  Â  Â  Â  codePrompt: "ğŸ”‘ Please enter your access code:",
Â  Â  Â  Â  accessCodeButton: "Submit",
Â  Â  Â  Â  homeButton: "ğŸ  Home",
Â  Â  Â  Â  moduleSelectionTitle: "Check probability for:",
Â  Â  Â  Â  comaModuleButton: "Intracranial hemorrhage in comatose patients (GCS 3-8)",
Â  Â  Â  Â  strokeModuleButton: "Intracerebral hemorrhage in patients with stroke symptoms",
Â  Â  Â  Â  switchToAdvancedStrokeButton: "Use Advanced Model (13 Params - Validated)",
Â  Â  Â  Â  advancedStrokeModuleTitle: "Advanced Stroke Model (Validated - 13 Params)",
Â  Â  Â  Â  comaModuleTitle: "Intracranial hemorrhage in comatose patients (GCS 3-8)",
Â  Â  Â  Â  strokeModuleTitle: "Intracerebral hemorrhage in patients with stroke symptoms (Standard)",
Â  Â  Â  Â  strokePrerequisiteTitle: "Prerequisites for Stroke Risk Calculation",
Â  Â  Â  Â  accessError: "Incorrect code or server error. Please try again.",
Â  Â  Â  Â  prerequisiteError: "All prerequisites must be met to proceed.",
Â  Â  Â  Â  advancedStrokeError: "Please fill all fields with valid values and ensure scores are calculated.",
Â  Â  Â  Â  calculateButton: "Calculate Probability",
Â  Â  Â  Â  calculateAdvancedStrokeButton: "Calculate Advanced Probability",
Â  Â  Â  Â  proceedButton: "Proceed to Calculation",
Â  Â  Â  Â  backButton: "â¬…ï¸ Back",
Â  Â  Â  Â  backToStandardStrokeButton: "â¬…ï¸ Back to Standard Stroke",
Â  Â  Â  Â  rangeErrorGFAP: "Please enter a GFAP value between 0 and 50000 pg/mL.",
Â  Â  Â  Â  invalidInput: "Please enter a valid value!",
Â  Â  Â  Â  lowRisk: "Low Risk",
Â  Â  Â  Â  mediumRisk: "Medium Risk",
Â  Â  Â  Â  highRisk: "High Risk",
Â  Â  Â  Â  disclaimer: "The calculations are for research purposes only, do not make clinical decisions based on it.",
Â  Â  Â  Â  confirmButton: "Confirm",
Â  Â  Â  Â  probability: "Probability",
Â  Â  Â  Â  riskLevel: "Risk Level",
Â  Â  Â  Â  gfapLabel: "GFAP Value (pg/mL)",
Â  Â  Â  Â  ageLabel: "Patient Age (Years)",
Â  Â  Â  Â  sbpLabel: "Systolic BP (mmHg)",
Â  Â  Â  Â  sbpError: "Valid SBP range: 50-300 mmHg.",
Â  Â  Â  Â  dbpLabel: "Diastolic BP (mmHg)",
Â  Â  Â  Â  dbpError: "Valid DBP range: 30-200 mmHg.",
Â  Â  Â  Â  fastEdError: "Invalid FAST ED Score (0-9).",
Â  Â  Â  Â  raceScoreError: "Invalid RACE Score (0-9).",
Â  Â  Â  Â  invalidAge: "Please enter valid age (18-120).",
Â  Â  Â  Â  invalidGFAP: "Invalid GFAP value. Must be between 0 and 50000.",
Â  Â  Â  Â  prerequisite1: "Confirmed time window < 6 hours",
Â  Â  Â  Â  prerequisite2: "No neurological deficits before the event",
Â  Â  Â  Â  prerequisite3: "No identifiable head trauma (severe fall)",
Â  Â  Â  Â  prerequisite4: "FAST ED Score >= 3 points",
Â  Â  Â  Â  serverError: "A server error occurred. Please try again later.",
Â  Â  Â  Â  gfapPlaceholder: "GFAP Value (pg/mL)",
Â  Â  Â  Â  agePlaceholder: "Patient Age (Years)",
Â  Â  Â  Â  sbpPlaceholder: "Systolic BP (mmHg)",
Â  Â  Â  Â  dbpPlaceholder: "e.g., 90",
Â  Â  Â  Â  accessCodePlaceholder: "Enter code",
Â  Â  Â  Â  darkModeToggleLabelOn: "Switch to Light Mode",
Â  Â  Â  Â  darkModeToggleLabelOff: "Switch to Dark Mode",
Â  Â  Â  Â  advAgeLabel: "Patient Age (Years)",
Â  Â  Â  Â  advGfapLabel: "GFAP Value (pg/mL)",
Â  Â  Â  Â  advSbpLabel: "Systolic BP (mmHg)",
Â  Â  Â  Â  advDbpLabel: "Diastolic BP (mmHg)",
Â  Â  Â  Â  advFastEdDisplayLabel: "FAST ED Score:",
Â  Â  Â  Â  toggleFastEdBtnTextCalculate: "Calculate/Edit",
Â  Â  Â  Â  toggleFastEdBtnTextHide: "Hide Components",
Â  Â  Â  Â  fastEdInfoText: "Select present findings for FAST ED:",
Â  Â  Â  Â  fastEdFacialPalsyLabel: "Facial Palsy (Partial/Complete)",
Â  Â  Â  Â  fastEdArmWeaknessLabel: "Arm Weakness",
Â  Â  Â  Â  fastEdArm0Label: "0 - No drift",
Â  Â  Â  Â  fastEdArm1Label: "1 - Drifts down",
Â  Â  Â  Â  fastEdArm2Label: "2 - No effort / Falls",
Â  Â  Â  Â  fastEdSpeechChangesLabel: "Speech Changes",
Â  Â  Â  Â  fastEdSpeech0Label: "0 - Normal",
Â  Â  Â  Â  fastEdSpeech1Label: "1 - Mild/Moderate",
Â  Â  Â  Â  fastEdSpeech2Label: "2 - Severe/Mute",
Â  Â  Â  Â  fastEdEyeDeviationLabel: "Eye Deviation",
Â  Â  Â  Â  fastEdEye0Label: "0 - Absent",
Â  Â  Â  Â  fastEdEye1Label: "1 - Partial",
Â  Â  Â  Â  fastEdEye2Label: "2 - Forced Deviation",
Â  Â  Â  Â  fastEdDenialNeglectLabel: "Denial/Neglect",
Â  Â  Â  Â  fastEdDenial0Label: "0 - Absent",
Â  Â  Â  Â  fastEdDenial1Label: "1 - Mild (e.g., Extinction)",
Â  Â  Â  Â  fastEdDenial2Label: "2 - Severe (e.g., Unawareness)",
Â  Â  Â  Â  advAdditionalSymptomsLabel: "Additional Symptoms & History (Check if Present/Yes):",
Â  Â  Â  Â  advEyeDeviationFlippedLabel: "Eye Deviation (Symptom)",
Â  Â  Â  Â  advArmPareseFlippedLabel: "Arm Paresis (Symptom)",
Â  Â  Â  Â  advBeinPareseFlippedLabel: "Leg Paresis (Symptom)",
Â  Â  Â  Â  advVigilanzminderungLabel: "Altered Sensorium",
Â  Â  Â  Â  advAfibLabel: "Known Atrial Fibrillation",
Â  Â  Â  Â  advHeadacheLabel: "Headache",
Â  Â  Â  Â  advNoakLabel: "On Anticoagulants (NOAK)",
Â  Â  Â  Â  advAntiplateletsLabel: "On Antiplatelets",
Â  Â  Â  },
Â  Â  Â  de: {
Â  Â  Â  Â  appTitle: "iGFAP Check",
Â  Â  Â  Â  codePrompt: "ğŸ”‘ Bitte geben Sie Ihren Zugangscode ein:",
Â  Â  Â  Â  accessCodeButton: "Absenden",
Â  Â  Â  Â  homeButton: "ğŸ  Startseite",
Â  Â  Â  Â  moduleSelectionTitle: "Wahrscheinlichkeit prÃ¼fen fÃ¼r:",
Â  Â  Â  Â  comaModuleButton: "Intrakranielle Blutungen bei komatÃ¶sen Patienten (GCS 3-8)",
Â  Â  Â  Â  strokeModuleButton: "Intrazerebrale Blutungen bei Patienten mit Schlaganfallsymptomen",
Â  Â  Â  Â  switchToAdvancedStrokeButton: "Erweitertes Modell verwenden (13 Parameter - Validiert)",
Â  Â  Â  Â  advancedStrokeModuleTitle: "Erweitertes Schlaganfall-Modell (Validiert - 13 Parameter)",
Â  Â  Â  Â  comaModuleTitle: "Intrakranielle Blutung bei komatÃ¶sen Patienten (GCS 3-8)",
Â  Â  Â  Â  strokeModuleTitle: "Intrazerebrale Blutung bei Patienten mit Schlaganfallsymptomen (Standard)",
Â  Â  Â  Â  strokePrerequisiteTitle: "Voraussetzungen fÃ¼r die Schlaganfallrisikoberechnung",
Â  Â  Â  Â  accessError: "Falscher Code oder Serverfehler. Bitte versuchen Sie es erneut.",
Â  Â  Â  Â  prerequisiteError: "Alle Voraussetzungen mÃ¼ssen erfÃ¼llt sein, um fortzufahren.",
Â  Â  Â  Â  advancedStrokeError: "Bitte fÃ¼llen Sie alle Felder mit gÃ¼ltigen Werten aus und stellen Sie sicher, dass die Scores berechnet wurden.",
Â  Â  Â  Â  calculateButton: "Wahrscheinlichkeit berechnen",
Â  Â  Â  Â  calculateAdvancedStrokeButton: "Erweiterte Wahrscheinlichkeit berechnen",
Â  Â  Â  Â  proceedButton: "Zur Berechnung fortfahren",
Â  Â  Â  Â  backButton: "â¬…ï¸ ZurÃ¼ck",
Â  Â  Â  Â  backToStandardStrokeButton: "â¬…ï¸ ZurÃ¼ck zum Standard-Schlaganfall",
Â  Â  Â  Â  rangeErrorGFAP: "Bitte geben Sie einen GFAP-Wert zwischen 0 und 50000 pg/mL ein.",
Â  Â  Â  Â  invalidInput: "Bitte geben Sie einen gÃ¼ltigen Wert ein!",
Â  Â  Â  Â  lowRisk: "Geringes Risiko",
Â  Â  Â  Â  mediumRisk: "Mittleres Risiko",
Â  Â  Â  Â  highRisk: "Hohes Risiko",
Â  Â  Â  Â  disclaimer: "Die Berechnungen dienen nur Forschungszwecken. Treffen Sie keine klinischen Entscheidungen auf dieser Grundlage.",
Â  Â  Â  Â  confirmButton: "BestÃ¤tigen",
Â  Â  Â  Â  probability: "Wahrscheinlichkeit",
Â  Â  Â  Â  riskLevel: "Risikostufe",
Â  Â  Â  Â  gfapLabel: "GFAP-Wert (pg/mL)",
Â  Â  Â  Â  ageLabel: "Patientenalter (Jahre)",
Â  Â  Â  Â  sbpLabel: "Systolischer Blutdruck (mmHg)",
Â  Â  Â  Â  sbpError: "GÃ¼ltiger systolischer Blutdruckbereich: 50-300 mmHg.",
Â  Â  Â  Â  dbpLabel: "Diastolischer Blutdruck (mmHg)",
Â  Â  Â  Â  dbpError: "GÃ¼ltiger diastolischer Blutdruckbereich: 30-200 mmHg.",
Â  Â  Â  Â  fastEdError: "UngÃ¼ltiger FAST-ED-Score (0-9).",
Â  Â  Â  Â  raceScoreError: "UngÃ¼ltiger RACE-Score (0-9).",
Â  Â  Â  Â  invalidAge: "Bitte geben Sie ein gÃ¼ltiges Alter ein (18-120).",
Â  Â  Â  Â  invalidGFAP: "UngÃ¼ltiger GFAP-Wert. Muss zwischen 0 und 50000 liegen.",
Â  Â  Â  Â  prerequisite1: "BestÃ¤tigtes Zeitfenster < 6 Stunden",
Â  Â  Â  Â  prerequisite2: "Keine neurologischen Defizite vor dem Ereignis",
Â  Â  Â  Â  prerequisite3: "Kein erkennbares SchÃ¤del-Hirn-Trauma (schwerer Sturz)",
Â  Â  Â  Â  prerequisite4: "FAST-ED-Score >= 3 Punkte",
Â  Â  Â  Â  serverError: "Ein Serverfehler ist aufgetreten. Bitte versuchen Sie es spÃ¤ter erneut.",
Â  Â  Â  Â  gfapPlaceholder: "GFAP-Wert (pg/mL)",
Â  Â  Â  Â  agePlaceholder: "Patientenalter (Jahre)",
Â  Â  Â  Â  sbpPlaceholder: "Systolischer Blutdruck (mmHg)",
Â  Â  Â  Â  dbpPlaceholder: "z.B. 90",
Â  Â  Â  Â  accessCodePlaceholder: "Code eingeben",
Â  Â  Â  Â  darkModeToggleLabelOn: "Wechseln zu Hellmodus",
Â  Â  Â  Â  darkModeToggleLabelOff: "Wechseln zu Dunkelmodus",
Â  Â  Â  Â  advAgeLabel: "Patientenalter (Jahre)",
Â  Â  Â  Â  advGfapLabel: "GFAP-Wert (pg/mL)",
Â  Â  Â  Â  advSbpLabel: "Systolischer Blutdruck (mmHg)",
Â  Â  Â  Â  advDbpLabel: "Diastolischer Blutdruck (mmHg)",
Â  Â  Â  Â  advFastEdDisplayLabel: "FAST-ED-Score:",
Â  Â  Â  Â  toggleFastEdBtnTextCalculate: "Berechnen/Bearbeiten",
Â  Â  Â  Â  toggleFastEdBtnTextHide: "Komponenten ausblenden",
Â  Â  Â  Â  fastEdInfoText: "WÃ¤hlen Sie vorhandene Befunde fÃ¼r FAST-ED:",
Â  Â  Â  Â  fastEdFacialPalsyLabel: "Fazialisparese (teilweise/komplett)",
Â  Â  Â  Â  fastEdArmWeaknessLabel: "Arm-SchwÃ¤che",
Â  Â  Â  Â  fastEdArm0Label: "0 - Kein Absinken",
Â  Â  Â  Â  fastEdArm1Label: "1 - Absinken",
Â  Â  Â  Â  fastEdArm2Label: "2 - Keine Bewegung / FÃ¤llt",
Â  Â  Â  Â  fastEdSpeechChangesLabel: "SprachverÃ¤nderungen",
Â  Â  Â  Â  fastEdSpeech0Label: "0 - Normal",
Â  Â  Â  Â  fastEdSpeech1Label: "1 - Leicht/mittelgradig",
Â  Â  Â  Â  fastEdSpeech2Label: "2 - Schwer/Stumm",
Â  Â  Â  Â  fastEdEyeDeviationLabel: "Blickdeviation",
Â  Â  Â  Â  fastEdEye0Label: "0 - Abwesend",
Â  Â  Â  Â  fastEdEye1Label: "1 - Teilweise",
Â  Â  Â  Â  fastEdEye2Label: "2 - Forcierte Deviation",
Â  Â  Â  Â  fastEdDenialNeglectLabel: "Verleugnung/Neglect",
Â  Â  Â  Â  fastEdDenial0Label: "0 - Abwesend",
Â  Â  Â  Â  fastEdDenial1Label: "1 - Leicht (z.B. Extinktion)",
Â  Â  Â  Â  fastEdDenial2Label: "2 - Schwer (z.B. Unbewusstheit)",
Â  Â  Â  Â  advAdditionalSymptomsLabel: "ZusÃ¤tzliche Symptome & Anamnese (Ankreuzen, falls vorhanden/ja):",
Â  Â  Â  Â  advEyeDeviationFlippedLabel: "Blickdeviation (Symptom)",
Â  Â  Â  Â  advArmPareseFlippedLabel: "Armparese (Symptom)",
Â  Â  Â  Â  advBeinPareseFlippedLabel: "Beinparese (Symptom)",
Â  Â  Â  Â  advVigilanzminderungLabel: "Vigilanzminderung",
Â  Â  Â  Â  advAfibLabel: "Bekanntes Vorhofflimmern",
Â  Â  Â  Â  advHeadacheLabel: "Kopfschmerzen",
Â  Â  Â  Â  advNoakLabel: "Antikoagulanzien (NOAK)",
Â  Â  Â  Â  advAntiplateletsLabel: "Thrombozytenaggregationshemmer",
Â  Â  Â  }
Â  Â  };

Â  Â  // List of all section IDs for show/hide functionality
Â  Â  const ALL_SECTIONS = [
Â  Â  Â  'codeEntrySection',
Â  Â  Â  'moduleSelectionSection',
Â  Â  Â  'comaModuleSection',
Â  Â  Â  'strokePrerequisiteSection',
Â  Â  Â  'strokeModuleSection',
Â  Â  Â  'advancedStrokeModuleSection'
Â  Â  ];

Â  Â  /**
Â  Â  Â * Show only the specified section by removing 'hidden' from that ID
Â  Â  Â * and adding 'hidden' to all others.
Â  Â  Â */
Â  Â  function showSection(sectionIdToShow) {
Â  Â  Â  ALL_SECTIONS.forEach(id => {
Â  Â  Â  Â  const section = document.getElementById(id);
Â  Â  Â  Â  if (section) {
Â  Â  Â  Â  Â  if (id === sectionIdToShow) {
Â  Â  Â  Â  Â  Â  section.classList.remove('hidden');
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  section.classList.add('hidden');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  /**
Â  Â  Â * Update text content of an element (or its inner <span>) using translations.
Â  Â  Â */
Â  Â  function updateTextContent(elementId, translationKey) {
Â  Â  Â  const element = document.getElementById(elementId);
Â  Â  Â  if (
Â  Â  Â  Â  element &&
Â  Â  Â  Â  translations[currentLang] &&
Â  Â  Â  Â  translations[currentLang][translationKey] !== undefined
Â  Â  Â  ) {
Â  Â  Â  Â  const target = element.querySelector('span') || element;
Â  Â  Â  Â  target.textContent = translations[currentLang][translationKey];
Â  Â  Â  } else if (
Â  Â  Â  Â  element &&
Â  Â  Â  Â  translations[currentLang] &&
Â  Â  Â  Â  translations[currentLang][translationKey] === undefined
Â  Â  Â  ) {
Â  Â  Â  Â  console.warn(
Â  Â  Â  Â  Â  `Translation key '${translationKey}' not found for lang '${currentLang}' for elementId '${elementId}'`
Â  Â  Â  Â  );
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Update placeholder text of an input element using translations.
Â  Â  Â */
Â  Â  function updatePlaceholder(elementId, translationKey) {
Â  Â  Â  const element = document.getElementById(elementId);
Â  Â  Â  if (
Â  Â  Â  Â  element &&
Â  Â  Â  Â  translations[currentLang] &&
Â  Â  Â  Â  translations[currentLang][translationKey] !== undefined
Â  Â  Â  ) {
Â  Â  Â  Â  element.placeholder = translations[currentLang][translationKey];
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Toggle button between loading and normal state.
Â  Â  Â */
Â  Â  function setButtonLoading(buttonElement, isLoading) {
Â  Â  Â  if (!buttonElement) return;
Â  Â  Â  if (isLoading) {
Â  Â  Â  Â  buttonElement.classList.add('loading');
Â  Â  Â  Â  buttonElement.disabled = true;
Â  Â  Â  } else {
Â  Â  Â  Â  buttonElement.classList.remove('loading');
Â  Â  Â  Â  buttonElement.disabled = false;
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Switch UI language between English and German.
Â  Â  Â * Updates text content, placeholders, and aria-labels accordingly.
Â  Â  Â */
Â  Â  function switchLanguage(lang) {
Â  Â  Â  currentLang = lang;
Â  Â  Â  document.documentElement.lang = lang;
Â  Â  Â  localStorage.setItem('language', lang);
Â  Â  Â  const texts = translations[lang] || translations.en;

Â  Â  Â  // Update static text elements
Â  Â  Â  updateTextContent('appTitle', 'appTitle');
Â  Â  Â  updateTextContent('codePrompt', 'codePrompt');
Â  Â  Â  updateTextContent('accessCodeButton', 'accessCodeButton');
Â  Â  Â  updateTextContent('homeButton', 'homeButton');

Â  Â  Â  updateTextContent('moduleSelectionTitle', 'moduleSelectionTitle');
Â  Â  Â  updateTextContent('comaModuleButton', 'comaModuleButton');
Â  Â  Â  updateTextContent('strokeModuleButton', 'strokeModuleButton');

Â  Â  Â  updateTextContent('comaModuleTitle', 'comaModuleTitle');
Â  Â  Â  updateTextContent('gfapComaLabel', 'gfapLabel');
Â  Â  Â  updateTextContent('calculateComaButton', 'calculateButton');
Â  Â  Â  updateTextContent('comaBackButton', 'backButton');

Â  Â  Â  updateTextContent('strokePrerequisiteTitle', 'strokePrerequisiteTitle');
Â  Â  Â  updateTextContent('prerequisite1Label', 'prerequisite1');
Â  Â  Â  updateTextContent('prerequisite2Label', 'prerequisite2');
Â  Â  Â  updateTextContent('prerequisite3Label', 'prerequisite3');
Â  Â  Â  updateTextContent('prerequisite4Label', 'prerequisite4');
Â  Â  Â  updateTextContent('proceedButton', 'proceedButton');
Â  Â  Â  updateTextContent('strokePrerequisiteBackButton', 'backButton');

Â  Â  Â  updateTextContent('strokeModuleTitle', 'strokeModuleTitle');
Â  Â  Â  updateTextContent('ageLabel', 'ageLabel');
Â  Â  Â  updateTextContent('gfapStrokeLabel', 'gfapLabel');
Â  Â  Â  updateTextContent('sbpLabel', 'sbpLabel');
Â  Â  Â  updateTextContent('calculateStrokeButton', 'calculateButton');
Â  Â  Â  updateTextContent('switchToAdvancedStrokeButton', 'switchToAdvancedStrokeButton');
Â  Â  Â  updateTextContent('strokeModuleBackButton', 'backButton');

Â  Â  Â  updateTextContent('advancedStrokeModuleTitle', 'advancedStrokeModuleTitle');
Â  Â  Â  updateTextContent('advAgeLabel', 'advAgeLabel');
Â  Â  Â  updateTextContent('advGfapLabel', 'advGfapLabel');
Â  Â  Â  updateTextContent('advSbpLabel', 'advSbpLabel');
Â  Â  Â  updateTextContent('advDbpLabel', 'advDbpLabel');

Â  Â  Â  // Toggle text on FAST ED toggle button
Â  Â  Â  const fastEdContainer = document.getElementById('fastEdComponentsContainer');
Â  Â  Â  const fastEdBtnTextEl = document.getElementById('toggleFastEdBtnText');
Â  Â  Â  if (
Â  Â  Â  Â  fastEdBtnTextEl
Â  Â  Â  )
Â  Â  Â  Â  fastEdBtnTextEl.textContent =
Â  Â  Â  Â  Â  texts[
Â  Â  Â  Â  Â  Â  fastEdContainer && fastEdContainer.classList.contains('hidden')
Â  Â  Â  Â  Â  Â  Â  ? 'toggleFastEdBtnTextCalculate'
Â  Â  Â  Â  Â  Â  Â  : 'toggleFastEdBtnTextHide'
Â  Â  Â  Â  Â  ];

Â  Â  Â  // Update all FAST ED / RACE related labels
Â  Â  Â  Object.keys(texts)
Â  Â  Â  Â  .filter((k) => k.startsWith('fastEd')) // REMOVED RACE
Â  Â  Â  Â  .forEach((key) => updateTextContent(key, key));

Â  Â  Â  updateTextContent('advAdditionalSymptomsLabel', 'advAdditionalSymptomsLabel');
Â  Â  Â  Object.keys(texts)
Â  Â  Â  Â  .filter((k) => k.startsWith('adv') && (k.endsWith('Label') || k.endsWith('FlippedLabel')))
Â  Â  Â  Â  .forEach((key) => updateTextContent(key, key));

Â  Â  Â  // Update "Altered Sensorium" label separately for German (word length variation)
Â  Â  Â  const vigilanzLabel = document.getElementById('advVigilanzminderungLabel');
Â  Â  Â  if (vigilanzLabel) {
Â  Â  Â  Â  vigilanzLabel.textContent = texts['advVigilanzminderungLabel'];
Â  Â  Â  }

Â  Â  Â  updateTextContent('calculateAdvancedStrokeButton', 'calculateAdvancedStrokeButton');
Â  Â  Â  updateTextContent('advancedStrokeModuleBackButton', 'backToStandardStrokeButton');

Â  Â  Â  updateTextContent('disclaimerModalTitleText', 'disclaimer');
Â  Â  Â  updateTextContent('disclaimerConfirmButton', 'confirmButton');

Â  Â  Â  // Update placeholders for code entry and advanced stroke inputs
Â  Â  Â  updatePlaceholder('accessCodeInput', 'accessCodePlaceholder');
Â  Â  Â  updatePlaceholder('advAgeInput', 'agePlaceholder');
Â  Â  Â  updatePlaceholder('advGfapInput', 'gfapPlaceholder');
Â  Â  Â  updatePlaceholder('advSbpInput', 'sbpPlaceholder');
Â  Â  Â  updatePlaceholder('advDbpInput', 'dbpPlaceholder');

Â  Â  Â  // Update aria-label for dark mode toggle based on current mode
Â  Â  Â  const darkModeButton = document.getElementById('darkModeToggle');
Â  Â  Â  if (darkModeButton) {
Â  Â  Â  Â  darkModeButton.setAttribute(
Â  Â  Â  Â  Â  'aria-label',
Â  Â  Â  Â  Â  document.body.classList.contains('dark-mode')
Â  Â  Â  Â  Â  Â  ? texts.darkModeToggleLabelOn
Â  Â  Â  Â  Â  Â  : texts.darkModeToggleLabelOff
Â  Â  Â  Â  );
Â  Â  Â  }

Â  Â  Â  // If any errors are visible, update their text
Â  Â  Â  ['accessError', 'prerequisiteError', 'advancedStrokeError'].forEach((errId) => {
Â  Â  Â  Â  const errEl = document.getElementById(errId);
Â  Â  Â  Â  if (errEl && !errEl.classList.contains('hidden')) {
Â  Â  Â  Â  Â  let key = errId;
Â  Â  Â  Â  Â  if (errId === 'accessError' && errEl.dataset.isServerError === 'true') {
Â  Â  Â  Â  Â  Â  key = 'serverError';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  errEl.textContent = texts[key] || 'An error occurred.';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  /**
Â  Â  Â * Clear Coma Module inputs and hide result
Â  Â  Â */
Â  Â  function resetComaModuleInputs() {
Â  Â  Â  const gfapInput = document.getElementById('gfapComaInput');
Â  Â  Â  if (gfapInput) gfapInput.value = '';
Â  Â  Â  const comaResult = document.getElementById('comaResult');
Â  Â  Â  if (comaResult) {
Â  Â  Â  Â  comaResult.classList.add('hidden');
Â  Â  Â  Â  comaResult.innerHTML = '';
Â  Â  Â  Â  comaResult.className = 'result hidden';
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Clear Stroke Module inputs, checkboxes, and hide result/errors
Â  Â  Â */
Â  Â  function resetStrokeModuleInputs() {
Â  Â  Â  ['ageInput', 'gfapStrokeInput', 'sbpInput'].forEach((id) => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if (el) el.value = '';
Â  Â  Â  });
Â  Â  Â  const strokeResult = document.getElementById('strokeResult');
Â  Â  Â  if (strokeResult) {
Â  Â  Â  Â  strokeResult.classList.add('hidden');
Â  Â  Â  Â  strokeResult.innerHTML = '';
Â  Â  Â  Â  strokeResult.className = 'result hidden';
Â  Â  Â  }
Â  Â  Â  ['prerequisite1', 'prerequisite2', 'prerequisite3', 'prerequisite4'].forEach((id) => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if (el) el.checked = false;
Â  Â  Â  });
Â  Â  Â  const prereqError = document.getElementById('prerequisiteError');
Â  Â  Â  if (prereqError) prereqError.classList.add('hidden');
Â  Â  }

Â  Â  /**
Â  Â  Â * Clear Advanced Stroke Module inputs, score components, and hide results/errors
Â  Â  Â */
Â  Â  function resetAdvancedStrokeModuleInputs() {
Â  Â  Â  // Clear basic fields
Â  Â  Â  const fieldsToClear = ['advAgeInput', 'advGfapInput', 'advSbpInput', 'advDbpInput'];
Â  Â  Â  fieldsToClear.forEach((id) => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if (el) el.value = '';
Â  Â  Â  });

Â  Â  Â  // Clear symptom checkboxes and FAST ED toggles
Â  Â  Â  const checkboxesToClear = [
Â  Â  Â  Â  'advEyeDeviationFlippedInput',
Â  Â  Â  Â  'advArmPareseFlippedInput',
Â  Â  Â  Â  'advBeinPareseFlippedInput',
Â  Â  Â  Â  'advVigilanzminderungInput',
Â  Â  Â  Â  'advAfibInput',
Â  Â  Â  Â  'advHeadacheInput',
Â  Â  Â  Â  'advNoakInput',
Â  Â  Â  Â  'advAntiplateletsInput',
Â  Â  Â  Â  'fastEdFacialPalsy',
Â  Â  Â  ];
Â  Â  Â  checkboxesToClear.forEach((id) => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if (el) el.checked = false;
Â  Â  Â  });

Â  Â  Â  // Reset FAST ED select values to 0
Â  Â  Â  const selectsToReset = {
Â  Â  Â  Â  fastEdArmWeakness: '0',
Â  Â  Â  Â  fastEdSpeechChanges: '0',
Â  Â  Â  Â  fastEdEyeDeviation: '0',
Â  Â  Â  Â  fastEdDenialNeglect: '0',
Â  Â  Â  };
Â  Â  Â  Object.keys(selectsToReset).forEach((id) => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if (el) el.value = selectsToReset[id];
Â  Â  Â  });

Â  Â  Â  // Update displayed FAST ED score after clearing
Â  Â  Â  if (typeof updateFastEdScore === 'function') updateFastEdScore();

Â  Â  Â  // Hide score component container
Â  Â  Â  const fastEdContainer = document.getElementById('fastEdComponentsContainer');
Â  Â  Â  if (fastEdContainer) fastEdContainer.classList.add('hidden');
Â  Â  Â  
Â  Â  Â  // Reset toggle button aria-expanded and text
Â  Â  Â  const fastEdBtn = document.getElementById('toggleFastEdBtn');
Â  Â  Â  if (fastEdBtn) fastEdBtn.setAttribute('aria-expanded', 'false');
Â  Â  Â  const fastEdBtnTextEl = document.getElementById('toggleFastEdBtnText');
Â  Â  Â  if (fastEdBtnTextEl && translations[currentLang]) {
Â  Â  Â  Â  Â  fastEdBtnTextEl.textContent = translations[currentLang].toggleFastEdBtnTextCalculate || 'Calculate/Edit';
Â  Â  Â  }

Â  Â  Â  // Hide result and error elements
Â  Â  Â  const resultEl = document.getElementById('advancedStrokeResult');
Â  Â  Â  if (resultEl) {
Â  Â  Â  Â  resultEl.classList.add('hidden');
Â  Â  Â  Â  resultEl.innerHTML = '';
Â  Â  Â  Â  resultEl.className = 'result hidden';
Â  Â  Â  }
Â  Â  Â  const errorEl = document.getElementById('advancedStrokeError');
Â  Â  Â  if (errorEl) errorEl.classList.add('hidden');
Â  Â  }

Â  Â  /**
Â  Â  Â * Navigate to module selection screen if authenticated; otherwise show access code entry.
Â  Â  Â */
Â  Â  function navigateToModuleSelection() {
Â  Â  Â  // Check if user is authenticated
Â  Â  Â  if (sessionStorage.getItem('isAuthenticated') !== 'true') {
Â  Â  Â  Â  showSection('codeEntrySection');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Show module selection, reset other modules
Â  Â  Â  showSection('moduleSelectionSection');
Â  Â  Â  resetComaModuleInputs();
Â  Â  Â  resetStrokeModuleInputs();
Â  Â  Â  if (typeof resetAdvancedStrokeModuleInputs === 'function') resetAdvancedStrokeModuleInputs();
Â  Â  Â  const accessCodeInput = document.getElementById('accessCodeInput');
Â  Â  Â  if (accessCodeInput) accessCodeInput.value = '';
Â  Â  Â  const accessErrorEl = document.getElementById('accessError');
Â  Â  Â  if (accessErrorEl) accessErrorEl.classList.add('hidden');
Â  Â  Â  const prereqErrorEl = document.getElementById('prerequisiteError');
Â  Â  Â  if (prereqErrorEl) prereqErrorEl.classList.add('hidden');
Â  Â  Â  const advErrorEl = document.getElementById('advancedStrokeError');
Â  Â  Â  if (advErrorEl) advErrorEl.classList.add('hidden');
Â  Â  }

Â  Â  /**
Â  Â  Â * Navigate back to code entry (log out).
Â  Â  Â */
Â  Â  function navigateToCodeEntry() {
Â  Â  Â  showSection('codeEntrySection');
Â  Â  Â  resetComaModuleInputs();
Â  Â  Â  resetStrokeModuleInputs();
Â  Â  Â  if (typeof resetAdvancedStrokeModuleInputs === 'function') resetAdvancedStrokeModuleInputs();
Â  Â  Â  const accessCodeInput = document.getElementById('accessCodeInput');
Â  Â  Â  if (accessCodeInput) {
Â  Â  Â  Â  accessCodeInput.value = '';
Â  Â  Â  Â  accessCodeInput.focus();
Â  Â  Â  }
Â  Â  Â  const accessErrorEl = document.getElementById('accessError');
Â  Â  Â  if (accessErrorEl) accessErrorEl.classList.add('hidden');
Â  Â  }

Â  Â  /**
Â  Â  Â * Navigate directly to standard stroke module (skipping prerequisites) and clear advanced inputs.
Â  Â  Â */
Â  Â  function navigateToStrokeModule() {
Â  Â  Â  showSection('strokeModuleSection');
Â  Â  Â  if (typeof resetAdvancedStrokeModuleInputs === 'function') resetAdvancedStrokeModuleInputs();
Â  Â  Â  const ageInput = document.getElementById('ageInput');
Â  Â  Â  if (ageInput) ageInput.focus();
Â  Â  }

Â  Â  /**
Â  Â  Â * Determine risk category (low/medium/high) based on probability percentage.
Â  Â  Â */
Â  Â  function updateRiskStratification(probability) {
Â  Â  Â  let riskLevel, riskClass;
Â  Â  Â  if (probability < 25) {
Â  Â  Â  Â  riskLevel = translations[currentLang].lowRisk;
Â  Â  Â  Â  riskClass = 'low-risk';
Â  Â  Â  } else if (probability < 50) {
Â  Â  Â  Â  riskLevel = translations[currentLang].mediumRisk;
Â  Â  Â  Â  riskClass = 'medium-risk';
Â  Â  Â  } else {
Â  Â  Â  Â  riskLevel = translations[currentLang].highRisk;
Â  Â  Â  Â  riskClass = 'red-risk';
Â  Â  Â  }
Â  Â  Â  return { riskLevel, riskClass };
Â  Â  }

Â  Â  /**
Â  Â  Â * Synchronize symptom checkboxes (eye deviation, arm paresis, leg paresis)
Â  Â  Â * based on FAST ED score selections.
Â  Â  Â */
Â  Â  function syncSymptomsFromScores() {
Â  Â  Â  // Eye Deviation: true if FAST ED eye deviation > 0
Â  Â  Â  const fastEdEyeDeviation = document.getElementById('fastEdEyeDeviation');
Â  Â  Â  const eyeDeviationSymptom = document.getElementById('advEyeDeviationFlippedInput');
Â  Â  Â  if (fastEdEyeDeviation && eyeDeviationSymptom) {
Â  Â  Â  Â  eyeDeviationSymptom.checked = parseInt(fastEdEyeDeviation.value) > 0;
Â  Â  Â  }

Â  Â  Â  // Arm Paresis: true if FAST ED arm weakness > 0
Â  Â  Â  const fastEdArmWeakness = document.getElementById('fastEdArmWeakness');
Â  Â  Â  const armParesisSymptom = document.getElementById('advArmPareseFlippedInput');
Â  Â  Â  if (fastEdArmWeakness && armParesisSymptom) {
Â  Â  Â  Â  armParesisSymptom.checked = parseInt(fastEdArmWeakness.value) > 0;
Â  Â  Â  }

Â  Â  Â  // Leg Paresis is now a manual input since RACE score is removed.
Â  Â  Â  // No sync logic is needed for it.
Â  Â  }

Â  Â  /**
Â  Â  Â * Validate the access code by sending it to the backend.
Â  Â  Â * Show error messages or navigate to module selection on success.
Â  Â  Â */
Â  Â  async function validateAccessCode() {
Â  Â  Â  const accessCodeInput = document.getElementById('accessCodeInput');
Â  Â  Â  const accessCode = accessCodeInput.value.trim();
Â  Â  Â  const accessErrorEl = document.getElementById('accessError');
Â  Â  Â  const accessCodeButton = document.getElementById('accessCodeButton');

Â  Â  Â  // If input is empty, show error
Â  Â  Â  if (!accessCode) {
Â  Â  Â  Â  accessErrorEl.textContent = translations[currentLang].invalidInput;
Â  Â  Â  Â  accessErrorEl.classList.remove('hidden');
Â  Â  Â  Â  accessErrorEl.dataset.isServerError = 'false';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  setButtonLoading(accessCodeButton, true);
Â  Â  Â  accessErrorEl.classList.add('hidden');

Â  Â  Â  try {
Â  Â  Â  Â  // Send access code to validation endpoint
Â  Â  Â  Â  const response = await fetch(ACCESS_CODE_VALIDATOR_URL, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify({ accessCode: accessCode }),
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  if (response.ok && data.success) {
Â  Â  Â  Â  Â  // Store authentication state and show module selection
Â  Â  Â  Â  Â  sessionStorage.setItem('isAuthenticated', 'true');
Â  Â  Â  Â  Â  navigateToModuleSelection();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  accessErrorEl.textContent = data.message || translations[currentLang].accessError;
Â  Â  Â  Â  Â  accessErrorEl.classList.remove('hidden');
Â  Â  Â  Â  Â  accessErrorEl.dataset.isServerError = String(response.status >= 500);
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error validating access code:', error);
Â  Â  Â  Â  accessErrorEl.textContent = translations[currentLang].serverError;
Â  Â  Â  Â  accessErrorEl.classList.remove('hidden');
Â  Â  Â  Â  accessErrorEl.dataset.isServerError = 'true';
Â  Â  Â  } finally {
Â  Â  Â  Â  setButtonLoading(accessCodeButton, false);
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Show the Coma Module: clear inputs, focus on GFAP input.
Â  Â  Â */
Â  Â  function startComaModule() {
Â  Â  Â  showSection('comaModuleSection');
Â  Â  Â  resetComaModuleInputs();
Â  Â  Â  const gfapInput = document.getElementById('gfapComaInput');
Â  Â  Â  if (gfapInput) gfapInput.focus();
Â  Â  }

Â  Â  /**
Â  Â  Â * Show the Stroke Prerequisite Section: clear stroke inputs, focus first checkbox.
Â  Â  Â */
Â  Â  function startStandardStrokeModule() {
Â  Â  Â  showSection('strokePrerequisiteSection');
Â  Â  Â  resetStrokeModuleInputs();
Â  Â  Â  const prereq1 = document.getElementById('prerequisite1');
Â  Â  Â  if (prereq1) prereq1.focus();
Â  Â  }

Â  Â  /**
Â  Â  Â * Show the Advanced Stroke Module: clear advanced inputs, focus on age input.
Â  Â  Â */
Â  Â  function startAdvancedStrokeModuleFromStandard() {
Â  Â  Â  showSection('advancedStrokeModuleSection');
Â  Â  Â  resetAdvancedStrokeModuleInputs();
Â  Â  Â  const advAgeInput = document.getElementById('advAgeInput');
Â  Â  Â  if (advAgeInput) advAgeInput.focus();
Â  Â  }

Â  Â  /**
Â  Â  Â * Validate that all stroke prerequisites are checked before showing Stroke Module.
Â  Â  Â */
Â  Â  function validatePrerequisites() {
Â  Â  Â  const checksMet = ['prerequisite1', 'prerequisite2', 'prerequisite3', 'prerequisite4'].every(
Â  Â  Â  Â  (id) => document.getElementById(id)?.checked
Â  Â  Â  );
Â  Â  Â  const prerequisiteErrorEl = document.getElementById('prerequisiteError');

Â  Â  Â  if (checksMet) {
Â  Â  Â  Â  showSection('strokeModuleSection');
Â  Â  Â  Â  const ageInput = document.getElementById('ageInput');
Â  Â  Â  Â  if (ageInput) ageInput.focus();
Â  Â  Â  Â  if (prerequisiteErrorEl) prerequisiteErrorEl.classList.add('hidden');
Â  Â  Â  } else {
Â  Â  Â  Â  if (prerequisiteErrorEl) {
Â  Â  Â  Â  Â  prerequisiteErrorEl.textContent = translations[currentLang].prerequisiteError;
Â  Â  Â  Â  Â  prerequisiteErrorEl.classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Display the disclaimer modal before showing results.
Â  Â  Â */
Â  Â  function showDisclaimer() {
Â  Â  Â  const modal = document.getElementById('disclaimerModal');
Â  Â  Â  if (!modal) return;
Â  Â  Â  modal.style.display = 'flex';
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  modal.classList.add('show');
Â  Â  Â  Â  const confirmBtn = document.getElementById('disclaimerConfirmButton');
Â  Â  Â  Â  if (confirmBtn) confirmBtn.focus();
Â  Â  Â  }, 10);
Â  Â  }

Â  Â  /**
Â  Â  Â * Close the disclaimer modal, then reveal pendingResult if set (with risk class).
Â  Â  Â */
Â  Â  function closeDisclaimer() {
Â  Â  Â  const modal = document.getElementById('disclaimerModal');
Â  Â  Â  if (!modal) return;
Â  Â  Â  modal.classList.remove('show');
Â  Â  Â  modal.addEventListener(
Â  Â  Â  Â  'transitionend',
Â  Â  Â  Â  function handler() {
Â  Â  Â  Â  Â  modal.style.display = 'none';
Â  Â  Â  Â  Â  modal.removeEventListener('transitionend', handler);
Â  Â  Â  Â  Â  if (pendingResult) {
Â  Â  Â  Â  Â  Â  let focusButtonId = null;
Â  Â  Â  Â  Â  Â  if (pendingResult.element.id === 'comaResult') focusButtonId = 'calculateComaButton';
Â  Â  Â  Â  Â  Â  else if (pendingResult.element.id === 'strokeResult')
Â  Â  Â  Â  Â  Â  Â  focusButtonId = 'calculateStrokeButton';
Â  Â  Â  Â  Â  Â  else if (pendingResult.element.id === 'advancedStrokeResult')
Â  Â  Â  Â  Â  Â  Â  focusButtonId = 'calculateAdvancedStrokeButton';

Â  Â  Â  Â  Â  Â  const focusButton = document.getElementById(focusButtonId);
Â  Â  Â  Â  Â  Â  if (focusButton) focusButton.focus();

Â  Â  Â  Â  Â  Â  // Apply risk class to result element for coma and stroke modules
Â  Â  Â  Â  Â  Â  if (
Â  Â  Â  Â  Â  Â  Â  pendingResult.element.id === 'comaResult' ||
Â  Â  Â  Â  Â  Â  Â  pendingResult.element.id === 'strokeResult'
Â  Â  Â  Â  Â  Â  ) {
Â  Â  Â  Â  Â  Â  Â  pendingResult.element.classList.add(pendingResult.riskClass);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  { once: true }
Â  Â  Â  );
Â  Â  }

Â  Â  let updateFastEdScore;

Â  Â  /**
Â  Â  Â * Setup interactive score calculator for FAST ED.
Â  Â  Â */
Â  Â  function setupInteractiveScore(
Â  Â  Â  toggleBtnId,
Â  Â  Â  componentsContainerId,
Â  Â  Â  scoreDisplayId,
Â  Â  Â  hiddenInputId,
Â  Â  Â  componentConfig
Â  Â  ) {
Â  Â  Â  const toggleBtn = document.getElementById(toggleBtnId);
Â  Â  Â  const componentsDiv = document.getElementById(componentsContainerId);
Â  Â  Â  const scoreDisplay = document.getElementById(scoreDisplayId);
Â  Â  Â  const hiddenInput = document.getElementById(hiddenInputId);
Â  Â  Â  const toggleBtnTextEl = document.getElementById(toggleBtnId + 'Text');

Â  Â  Â  if (!toggleBtn || !componentsDiv || !scoreDisplay || !hiddenInput || !toggleBtnTextEl) {
Â  Â  Â  Â  return () => {};
Â  Â  Â  }

Â  Â  Â  /**
Â  Â  Â  Â * Calculate total score based on component states (checkbox/select),
Â  Â  Â  Â * update display and hidden input, then sync symptom checkboxes.
Â  Â  Â  Â */
Â  Â  Â  function calculateAndUpdate() {
Â  Â  Â  Â  let currentScore = 0;
Â  Â  Â  Â  componentConfig.forEach((comp) => {
Â  Â  Â  Â  Â  const element = document.getElementById(comp.id);
Â  Â  Â  Â  Â  if (element) {
Â  Â  Â  Â  Â  Â  if (comp.type === 'checkbox') {
Â  Â  Â  Â  Â  Â  Â  if (element.checked) {
Â  Â  Â  Â  Â  Â  Â  Â  currentScore += parseInt(comp.points || element.dataset.points || 0);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (comp.type === 'select') {
Â  Â  Â  Â  Â  Â  Â  currentScore += parseInt(element.value);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  scoreDisplay.textContent = currentScore;
Â  Â  Â  Â  hiddenInput.value = currentScore;
Â  Â  Â  Â  syncSymptomsFromScores(); // Keep symptom checkboxes in sync
Â  Â  Â  }

Â  Â  Â  // Attach change listeners to each component to recalculate on change
Â  Â  Â  componentConfig.forEach((comp) => {
Â  Â  Â  Â  const element = document.getElementById(comp.id);
Â  Â  Â  Â  if (element) {
Â  Â  Â  Â  Â  element.addEventListener('change', calculateAndUpdate);
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // Toggle visibility of component container on button click
Â  Â  Â  toggleBtn.addEventListener('click', () => {
Â  Â  Â  Â  const isHiddenAfterToggle = componentsDiv.classList.toggle('hidden');
Â  Â  Â  Â  toggleBtn.setAttribute('aria-expanded', String(!isHiddenAfterToggle));

Â  Â  Â  Â  // Determine appropriate toggle button text (Calculate/Edit vs. Hide)
Â  Â  Â  Â  let calculateKey = 'toggleFastEdBtnTextCalculate';
Â  Â  Â  Â  let hideKey = 'toggleFastEdBtnTextHide';
Â  Â  Â  Â  toggleBtnTextEl.textContent = translations[currentLang][
Â  Â  Â  Â  Â  isHiddenAfterToggle ? calculateKey : hideKey
Â  Â  Â  Â  ];

Â  Â  Â  Â  // If showing container, focus first component
Â  Â  Â  Â  if (!isHiddenAfterToggle && componentConfig.length > 0) {
Â  Â  Â  Â  Â  const firstComponent = document.getElementById(componentConfig[0].id);
Â  Â  Â  Â  Â  if (firstComponent) firstComponent.focus();
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // Initial calculation to set score to 0
Â  Â  Â  calculateAndUpdate();
Â  Â  Â  return calculateAndUpdate;
Â  Â  }

Â  Â  /**
Â  Â  Â * Calculate coma risk by sending GFAP value to backend.
Â  Â  Â * Displays a disclaimer modal before showing result.
Â  Â  Â */
Â  Â  async function calculateComaRisk() {
Â  Â  Â  const gfapInput = document.getElementById('gfapComaInput');
Â  Â  Â  const gfap = parseFloat(gfapInput?.value);
Â  Â  Â  const resultEl = document.getElementById('comaResult');
Â  Â  Â  const calculateButton = document.getElementById('calculateComaButton');

Â  Â  Â  if (!resultEl) return;
Â  Â  Â  // Hide previous result
Â  Â  Â  resultEl.classList.add('hidden');
Â  Â  Â  resultEl.className = 'result hidden';

Â  Â  Â  // Validate GFAP input range
Â  Â  Â  if (isNaN(gfap) || gfap < 29 || gfap > 10001) {
Â  Â  Â  Â  resultEl.textContent = translations[currentLang].rangeErrorGFAP.replace(
Â  Â  Â  Â  Â  '0 and 50000',
Â  Â  Â  Â  Â  '29 and 10001'
Â  Â  Â  Â  );
Â  Â  Â  Â  resultEl.classList.add('warning');
Â  Â  Â  Â  resultEl.classList.remove('hidden');
Â  Â  Â  Â  if (gfapInput) gfapInput.focus();
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Show loading spinner on button
Â  Â  Â  setButtonLoading(calculateButton, true);
Â  Â  Â  try {
Â  Â  Â  Â  // Send GFAP to coma risk API
Â  Â  Â  Â  const response = await fetch(COMA_CALCULATOR_URL, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify({ gfap: gfap })
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  if (response.ok && data.success) {
Â  Â  Â  Â  Â  // Show disclaimer before revealing result
Â  Â  Â  Â  Â  showDisclaimer();

Â  Â  Â  Â  Â  // Determine risk level and CSS class
Â  Â  Â  Â  Â  const { riskLevel, riskClass } = updateRiskStratification(data.probability);

Â  Â  Â  Â  Â  // Store pendingResult to display after disclaimer
Â  Â  Â  Â  Â  pendingResult = {
Â  Â  Â  Â  Â  Â  element: resultEl,
Â  Â  Â  Â  Â  Â  html: `<strong>${translations[currentLang].probability}:</strong> ${data.probability.toFixed(
Â  Â  Â  Â  Â  Â  Â  1
Â  Â  Â  Â  Â  Â  )}%<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <strong>${translations[currentLang].riskLevel}:</strong> ${riskLevel}`,
Â  Â  Â  Â  Â  Â  baseClass: 'result',
Â  Â  Â  Â  Â  Â  riskClass: riskClass
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Show server or validation error
Â  Â  Â  Â  Â  resultEl.textContent = data.message || translations[currentLang].serverError;
Â  Â  Â  Â  Â  resultEl.classList.add('warning');
Â  Â  Â  Â  Â  resultEl.classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error calculating coma risk:', error);
Â  Â  Â  Â  resultEl.textContent = translations[currentLang].serverError;
Â  Â  Â  Â  resultEl.classList.add('warning');
Â  Â  Â  Â  resultEl.classList.remove('hidden');
Â  Â  Â  } finally {
Â  Â  Â  Â  // Remove loading spinner
Â  Â  Â  Â  setButtonLoading(calculateButton, false);
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Calculate stroke risk by sending age, GFAP, and SBP to backend.
Â  Â  Â * Displays a disclaimer modal before showing result.
Â  Â  Â */
Â  Â  async function calculateStrokeRisk() {
Â  Â  Â  const ageInput = document.getElementById('ageInput');
Â  Â  Â  const gfapStrokeInput = document.getElementById('gfapStrokeInput');
Â  Â  Â  const sbpInput = document.getElementById('sbpInput');
Â  Â  Â  const resultEl = document.getElementById('strokeResult');
Â  Â  Â  const calculateButton = document.getElementById('calculateStrokeButton');

Â  Â  Â  if (!resultEl) return;
Â  Â  Â  const age = parseInt(ageInput?.value);
Â  Â  Â  const gfap = parseFloat(gfapStrokeInput?.value);
Â  Â  Â  const sbp = parseFloat(sbpInput?.value);

Â  Â  Â  // Hide previous result
Â  Â  Â  resultEl.classList.add('hidden');
Â  Â  Â  resultEl.className = 'result hidden';

Â  Â  Â  // Validate age
Â  Â  Â  if (isNaN(age) || age < 18 || age > 120) {
Â  Â  Â  Â  resultEl.textContent = translations[currentLang].invalidAge;
Â  Â  Â  Â  resultEl.classList.add('warning');
Â  Â  Â  Â  resultEl.classList.remove('hidden');
Â  Â  Â  Â  if (ageInput) ageInput.focus();
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  // Validate GFAP
Â  Â  Â  if (isNaN(gfap) || gfap < 29 || gfap > 10001) {
Â  Â  Â  Â  resultEl.textContent = translations[currentLang].invalidGFAP.replace(
Â  Â  Â  Â  Â  '0 and 50000',
Â  Â  Â  Â  Â  '29 and 10001'
Â  Â  Â  Â  );
Â  Â  Â  Â  resultEl.classList.add('warning');
Â  Â  Â  Â  resultEl.classList.remove('hidden');
Â  Â  Â  Â  if (gfapStrokeInput) gfapStrokeInput.focus();
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  // Validate SBP
Â  Â  Â  if (isNaN(sbp) || sbp < 50 || sbp > 250) {
Â  Â  Â  Â  resultEl.textContent = translations[currentLang].sbpError.replace('50-300', '50-250');
Â  Â  Â  Â  resultEl.classList.add('warning');
Â  Â  Â  Â  resultEl.classList.remove('hidden');
Â  Â  Â  Â  if (sbpInput) sbpInput.focus();
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Show loading spinner
Â  Â  Â  setButtonLoading(calculateButton, true);
Â  Â  Â  try {
Â  Â  Â  Â  // Send stroke parameters to API
Â  Â  Â  Â  const response = await fetch(STROKE_CALCULATOR_URL, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify({ age: age, gfap: gfap, sbp: sbp })
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  if (response.ok && data.success) {
Â  Â  Â  Â  Â  // Show disclaimer before revealing result
Â  Â  Â  Â  Â  showDisclaimer();

Â  Â  Â  Â  Â  // Determine risk level and CSS class
Â  Â  Â  Â  Â  const { riskLevel, riskClass } = updateRiskStratification(data.probability);

Â  Â  Â  Â  Â  // Store pendingResult to display after disclaimer
Â  Â  Â  Â  Â  pendingResult = {
Â  Â  Â  Â  Â  Â  element: resultEl,
Â  Â  Â  Â  Â  Â  html: `<strong>${translations[currentLang].probability}:</strong> ${data.probability.toFixed(
Â  Â  Â  Â  Â  Â  Â  1
Â  Â  Â  Â  Â  Â  )}%<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <strong>${translations[currentLang].riskLevel}:</strong> ${riskLevel}`,
Â  Â  Â  Â  Â  Â  baseClass: 'result',
Â  Â  Â  Â  Â  Â  riskClass: riskClass
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Show server or validation error
Â  Â  Â  Â  Â  resultEl.textContent = data.message || translations[currentLang].serverError;
Â  Â  Â  Â  Â  resultEl.classList.add('warning');
Â  Â  Â  Â  Â  resultEl.classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error calculating stroke risk:', error);
Â  Â  Â  Â  resultEl.textContent = translations[currentLang].serverError;
Â  Â  Â  Â  resultEl.classList.add('warning');
Â  Â  Â  Â  resultEl.classList.remove('hidden');
Â  Â  Â  } finally {
Â  Â  Â  Â  // Remove loading spinner
Â  Â  Â  Â  setButtonLoading(calculateButton, false);
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Calculate advanced stroke risk by sending all parameters to backend.
Â  Â  Â * Validates inputs, shows errors inline, displays disclaimer before result.
Â  Â  Â */
Â  Â  async function calculateAdvancedStrokeRisk() {
Â  Â  Â  const resultEl = document.getElementById('advancedStrokeResult');
Â  Â  Â  const errorEl = document.getElementById('advancedStrokeError');
Â  Â  Â  const calculateButton = document.getElementById('calculateAdvancedStrokeButton');

Â  Â  Â  if (!resultEl || !errorEl || !calculateButton) {
Â  Â  Â  Â  console.error('Advanced stroke module elements not found.');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Hide previous result and error
Â  Â  Â  resultEl.classList.add('hidden');
Â  Â  Â  resultEl.className = 'result hidden';
Â  Â  Â  errorEl.classList.add('hidden');

Â  Â  Â  // Remove previous input-error classes
Â  Â  Â  document.querySelectorAll('.input-error').forEach((el) => {
Â  Â  Â  Â  el.classList.remove('input-error');
Â  Â  Â  });

Â  Â  Â  // Parse input values
Â  Â  Â  const age = parseInt(document.getElementById('advAgeInput')?.value);
Â  Â  Â  const gfap = parseFloat(document.getElementById('advGfapInput')?.value);
Â  Â  Â  const sbp = parseFloat(document.getElementById('advSbpInput')?.value);
Â  Â  Â  const dbp = parseFloat(document.getElementById('advDbpInput')?.value);
Â  Â  Â  const fastEd = parseInt(document.getElementById('advFastEdInput')?.value);
Â  Â  Â  
Â  Â  Â  // Convert symptom checkboxes to binary values (1 or 0)
Â  Â  Â  const eyeDeviation = document.getElementById('advEyeDeviationFlippedInput')?.checked ? 1 : 0;
Â  Â  Â  const armParese = document.getElementById('advArmPareseFlippedInput')?.checked ? 1 : 0;
Â  Â  Â  const beinParese = document.getElementById('advBeinPareseFlippedInput')?.checked ? 1 : 0;
Â  Â  Â  const vigilanzminderung = document.getElementById('advVigilanzminderungInput')?.checked ? 1 : 0;
Â  Â  Â  const afib = document.getElementById('advAfibInput')?.checked ? 1 : 0;
Â  Â  Â  const headache = document.getElementById('advHeadacheInput')?.checked ? 1 : 0;
Â  Â  Â  const noak = document.getElementById('advNoakInput')?.checked ? 1 : 0;
Â  Â  Â  const antiplatelets = document.getElementById('advAntiplateletsInput')?.checked ? 1 : 0;

Â  Â  Â  // Define validation rules for advanced inputs
Â  Â  Â  const fieldsToValidate = [
Â  Â  Â  Â  { id: 'advAgeInput', condition: isNaN(age) || age < 18 || age > 120, error: translations[currentLang].invalidAge },
Â  Â  Â  Â  { id: 'advGfapInput', condition: isNaN(gfap) || gfap < 0 || gfap > 50000, error: translations[currentLang].invalidGFAP },
Â  Â  Â  Â  { id: 'advSbpInput', condition: isNaN(sbp) || sbp < 50 || sbp > 300, error: translations[currentLang].sbpError },
Â  Â  Â  Â  { id: 'advDbpInput', condition: isNaN(dbp) || dbp < 30 || dbp > 200, error: translations[currentLang].dbpError },
Â  Â  Â  Â  { id: 'advFastEdInput', condition: isNaN(fastEd) || fastEd < 0 || fastEd > 9, error: translations[currentLang].fastEdError },
Â  Â  Â  ];

Â  Â  Â  // Collect error messages and highlight invalid fields
Â  Â  Â  let errorMessages = [];
Â  Â  Â  fieldsToValidate.forEach((field) => {
Â  Â  Â  Â  if (field.condition) {
Â  Â  Â  Â  Â  errorMessages.push(field.error);
Â  Â  Â  Â  Â  const inputEl = document.getElementById(field.id);
Â  Â  Â  Â  Â  if (inputEl) inputEl.classList.add('input-error');
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // If any errors exist, show them and abort
Â  Â  Â  if (errorMessages.length > 0) {
Â  Â  Â  Â  errorEl.innerHTML = errorMessages.join('<br>');
Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Show loading spinner
Â  Â  Â  setButtonLoading(calculateButton, true);

Â  Â  Â  // Build input features for backend request
Â  Â  Â  const inputFeatures = {
Â  Â  Â  Â  'Age (years)': age,
Â  Â  Â  Â  'FAST ED Score': fastEd,
Â  Â  Â  Â  'Eye Deviation': eyeDeviation,
Â  Â  Â  Â  'Armparese': armParese,
Â  Â  Â  Â  'Beinparese': beinParese,
Â  Â  Â  Â  'Vigilanzminderung': vigilanzminderung,
Â  Â  Â  Â  'Atrial Fibrillation': afib,
Â  Â  Â  Â  'Headache': headache,
Â  Â  Â  Â  'Systolic BP': sbp,
Â  Â  Â  Â  'Diastolic BP': dbp,
Â  Â  Â  Â  'Antcoagulated-NOAK': noak,
Â  Â  Â  Â  'Antiplatelets': antiplatelets,
Â  Â  Â  Â  'GFAP value': gfap
Â  Â  Â  };

Â  Â  Â  try {
Â  Â  Â  Â  // Send advanced stroke data to API
Â  Â  Â  Â  const response = await fetch(ADVANCED_STROKE_CALCULATOR_URL, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify(inputFeatures)
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  if (response.ok && data.success) {
Â  Â  Â  Â  Â  // Show disclaimer before displaying result
Â  Â  Â  Â  Â  showDisclaimer();

Â  Â  Â  Â  Â  // Determine risk level and CSS class
Â  Â  Â  Â  Â  const { riskLevel, riskClass } = updateRiskStratification(data.probability);
Â  Â  Â  Â  Â  let riskLevelDisplay = translations[currentLang][riskLevel] || riskLevel;

Â  Â  Â  Â  Â  // Store pending result for after disclaimer
Â  Â  Â  Â  Â  pendingResult = {
Â  Â  Â  Â  Â  Â  element: resultEl,
Â  Â  Â  Â  Â  Â  html: `<strong>${translations[currentLang].probability}:</strong> ${
Â  Â  Â  Â  Â  Â  Â  data.probability !== undefined ? data.probability.toFixed(1) : 'N/A'
Â  Â  Â  Â  Â  Â  }%<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <strong>${translations[currentLang].riskLevel}:</strong> <span class="${riskClass}">${riskLevelDisplay}</span>`,
Â  Â  Â  Â  Â  Â  baseClass: 'result',
Â  Â  Â  Â  Â  Â  riskClass: riskClass
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Show server or validation error
Â  Â  Â  Â  Â  errorEl.textContent = data.message || translations[currentLang].serverError;
Â  Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error calculating advanced stroke risk:', error);
Â  Â  Â  Â  errorEl.textContent = translations[currentLang].serverError;
Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  } finally {
Â  Â  Â  Â  // Remove loading spinner
Â  Â  Â  Â  setButtonLoading(calculateButton, false);
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Initialization after DOM loads:
Â  Â  Â * - Check authentication state
Â  Â  Â * - Set current year in footer
Â  Â  Â * - Set focus on access code input
Â  Â  Â * - Initialize dark mode state
Â  Â  Â * - Set preferred language
Â  Â  Â * - Setup interactive score calculators
Â  Â  Â * - Register service worker
Â  Â  Â * - Attach event listeners
Â  Â  Â */
Â  Â  document.addEventListener('DOMContentLoaded', function () {
Â  Â  Â  // Check if already authenticated, otherwise show code entry
Â  Â  Â  if (sessionStorage.getItem('isAuthenticated') === 'true') {
Â  Â  Â  Â  navigateToModuleSelection();
Â  Â  Â  } else {
Â  Â  Â  Â  showSection('codeEntrySection');
Â  Â  Â  }

Â  Â  Â  // Update footer year
Â  Â  Â  if (document.getElementById('currentYear')) {
Â  Â  Â  Â  document.getElementById('currentYear').textContent = new Date().getFullYear();
Â  Â  Â  }

Â  Â  Â  // Focus on access code input
Â  Â  Â  const accessCodeInput = document.getElementById('accessCodeInput');
Â  Â  Â  if (accessCodeInput) accessCodeInput.focus();

Â  Â  Â  // Initialize dark mode based on localStorage
Â  Â  Â  const darkModeToggleSpan = document.getElementById('darkModeToggle')?.querySelector('span');
Â  Â  Â  if (localStorage.getItem('darkMode') === 'enabled') {
Â  Â  Â  Â  document.body.classList.add('dark-mode');
Â  Â  Â  Â  if (darkModeToggleSpan) darkModeToggleSpan.textContent = 'â˜€ï¸';
Â  Â  Â  } else {
Â  Â  Â  Â  if (darkModeToggleSpan) darkModeToggleSpan.textContent = 'ğŸŒ™';
Â  Â  Â  }
Â  Â  Â  // Set preferred language from localStorage (default English)
Â  Â  Â  const preferredLang = localStorage.getItem('language') || 'en';
Â  Â  Â  switchLanguage(preferredLang);

Â  Â  Â  // Configuration for FAST ED interactive score calculator
Â  Â  Â  const fastEdComponentConfig = [
Â  Â  Â  Â  { id: 'fastEdFacialPalsy', type: 'checkbox', points: 1 },
Â  Â  Â  Â  { id: 'fastEdArmWeakness', type: 'select' },
Â  Â  Â  Â  { id: 'fastEdSpeechChanges', type: 'select' },
Â  Â  Â  Â  { id: 'fastEdEyeDeviation', type: 'select' },
Â  Â  Â  Â  { id: 'fastEdDenialNeglect', type: 'select' }
Â  Â  Â  ];
Â  Â  Â  // Initialize FAST ED score calculator logic
Â  Â  Â  updateFastEdScore = setupInteractiveScore(
Â  Â  Â  Â  'toggleFastEdBtn',
Â  Â  Â  Â  'fastEdComponentsContainer',
Â  Â  Â  Â  'advFastEdScoreDisplay',
Â  Â  Â  Â  'advFastEdInput',
Â  Â  Â  Â  fastEdComponentConfig
Â  Â  Â  );

Â  Â  Â  // Perform initial symptom synchronization
Â  Â  Â  syncSymptomsFromScores();

Â  Â  Â  // Service worker registration for offline capabilities
Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  Â  navigator.serviceWorker
Â  Â  Â  Â  Â  Â  .register('./sw.js')
Â  Â  Â  Â  Â  Â  .then((reg) => console.log('Service Worker registered with scope:', reg.scope))
Â  Â  Â  Â  Â  Â  .catch((err) => console.error('Service Worker registration failed:', err));
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  // Event listeners for access code validation and Enter key press
Â  Â  Â  document.getElementById('accessCodeButton')?.addEventListener('click', validateAccessCode);
Â  Â  Â  document.getElementById('accessCodeInput')?.addEventListener('keypress', (e) => {
Â  Â  Â  Â  if (e.key === 'Enter') validateAccessCode();
Â  Â  Â  });

Â  Â  Â  // Event listeners to switch to coma and stroke modules
Â  Â  Â  document.getElementById('comaModuleButton')?.addEventListener('click', startComaModule);
Â  Â  Â  document.getElementById('strokeModuleButton')?.addEventListener('click', startStandardStrokeModule);
Â  Â  Â  document
Â  Â  Â  Â  .getElementById('switchToAdvancedStrokeButton')
Â  Â  Â  Â  ?.addEventListener('click', startAdvancedStrokeModuleFromStandard);

Â  Â  Â  // Event listener for stroke prerequisites validation
Â  Â  Â  document.getElementById('proceedButton')?.addEventListener('click', validatePrerequisites);

Â  Â  Â  // Event listeners for coma risk calculation and Enter key press on GFAP input
Â  Â  Â  document.getElementById('calculateComaButton')?.addEventListener('click', calculateComaRisk);
Â  Â  Â  document.getElementById('gfapComaInput')?.addEventListener('keypress', (e) => {
Â  Â  Â  Â  if (e.key === 'Enter') calculateComaRisk();
Â  Â  Â  });

Â  Â  Â  // Event listeners for stroke risk calculation and Enter key presses on inputs
Â  Â  Â  document
Â  Â  Â  Â  .getElementById('calculateStrokeButton')
Â  Â  Â  Â  ?.addEventListener('click', calculateStrokeRisk);
Â  Â  Â  ['ageInput', 'gfapStrokeInput', 'sbpInput'].forEach((id) => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if (el) el.addEventListener('keypress', (e) => {
Â  Â  Â  Â  Â  if (e.key === 'Enter') calculateStrokeRisk();
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  // Event listeners for advanced stroke calculation and Enter key presses on inputs
Â  Â  Â  document
Â  Â  Â  Â  .getElementById('calculateAdvancedStrokeButton')
Â  Â  Â  Â  ?.addEventListener('click', calculateAdvancedStrokeRisk);
Â  Â  Â  ['advAgeInput', 'advGfapInput', 'advSbpInput', 'advDbpInput'].forEach((id) => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if (el) el.addEventListener('keypress', (e) => {
Â  Â  Â  Â  Â  if (e.key === 'Enter') calculateAdvancedStrokeRisk();
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  // Dark mode toggle behavior
Â  Â  Â  const darkModeButton = document.getElementById('darkModeToggle');
Â  Â  Â  darkModeButton?.addEventListener('click', function () {
Â  Â  Â  Â  document.body.classList.toggle('dark-mode');
Â  Â  Â  Â  const texts = translations[currentLang];
Â  Â  Â  Â  const iconSpan = darkModeButton.querySelector('span');
Â  Â  Â  Â  if (document.body.classList.contains('dark-mode')) {
Â  Â  Â  Â  Â  if (iconSpan) iconSpan.textContent = 'â˜€ï¸';
Â  Â  Â  Â  Â  darkModeButton.setAttribute('aria-label', texts.darkModeToggleLabelOn);
Â  Â  Â  Â  Â  localStorage.setItem('darkMode', 'enabled');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  if (iconSpan) iconSpan.textContent = 'ğŸŒ™';
Â  Â  Â  Â  Â  darkModeButton.setAttribute('aria-label', texts.darkModeToggleLabelOff);
Â  Â  Â  Â  Â  localStorage.setItem('darkMode', 'disabled');
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // Confirm disclaimer: close modal and show pending result
Â  Â  Â  document
Â  Â  Â  Â  .getElementById('disclaimerConfirmButton')
Â  Â  Â  Â  ?.addEventListener('click', function () {
Â  Â  Â  Â  Â  closeDisclaimer();
Â  Â  Â  Â  Â  if (pendingResult) {
Â  Â  Â  Â  Â  Â  pendingResult.element.innerHTML = pendingResult.html;
Â  Â  Â  Â  Â  Â  pendingResult.element.className = `${pendingResult.baseClass}`;
Â  Â  Â  Â  Â  Â  pendingResult.element.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  // Apply risk class to coma and stroke result elements
Â  Â  Â  Â  Â  Â  if (
Â  Â  Â  Â  Â  Â  Â  pendingResult.element.id === 'comaResult' ||
Â  Â  Â  Â  Â  Â  Â  pendingResult.element.id === 'strokeResult'
Â  Â  Â  Â  Â  Â  ) {
Â  Â  Â  Â  Â  Â  Â  pendingResult.element.classList.add(pendingResult.riskClass);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  pendingResult = null;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  });
Â  </script>
</body>
</html>
