<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iGFAP Check - Mark 6 (XGBoost & Rapid/Max)</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#007bff" />
  <style>
    /* Root-level CSS variables for theming */
    :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --secondary-color: #dc3545;
      --secondary-hover: #b52b3a;
      --experimental-color: #ffc107;
      --text-color: #212529;
      --background-color: #f8f9fa;
      --error-color: #dc3545;
      --error-bg: #f8d7da;
      --button-radius: 5px;
      --input-border: #ced4da;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --text-color: #f8f9fa;
      --background-color: #212529;
      --input-border: #495057;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Container styling for central panels */
    .container {
      max-width: 500px;
      margin: 70px auto 20px auto;
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    [data-theme="dark"] .container {
      background-color: #343a40;
    }

    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    /* Input and button styling */
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    input[type="number"], select {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid var(--input-border);
      border-radius: var(--button-radius);
      font-size: 16px;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    [data-theme="dark"] input {
      background-color: #495057;
      color: #f8f9fa;
      border-color: var(--input-border);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .checkbox-group label {
      margin-left: 8px;
      font-weight: normal;
    }

    .input-group {
      margin-bottom: 10px;
    }

    .primary, .secondary {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: var(--button-radius);
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .primary {
      background-color: var(--primary-color);
      color: white;
    }
    .primary:hover {
      background-color: var(--primary-hover);
    }

    .secondary {
      background-color: var(--secondary-color);
      color: white;
    }
    .secondary:hover {
      background-color: var(--secondary-hover);
    }

    /* Result and error styling */
    .result {
      margin-top: 15px;
      padding: 10px;
      border-radius: var(--button-radius);
      text-align: center;
      font-weight: 500;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .result.high { background-color: #dc3545; color: white; }       /* High risk = red */
    .result.medium { background-color: #ffc107; color: black; }     /* Medium = yellow */
    .result.low { background-color: #28a745; color: white; }        /* Low = green */

    .error {
      color: var(--error-color);
      background-color: var(--error-bg);
      padding: 10px;
      border-radius: var(--button-radius);
      margin-top: 10px;
      text-align: center;
    }

    /* Hidden utility */
    .hidden { display: none; }

    /* Back-to-top button */
    #backToTop {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: none;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: background-color 0.2s ease;
    }
    #backToTop:hover {
      background-color: var(--primary-hover);
    }
  </style>
</head>
<body data-theme="light">
  <button id="backToTop" title="Back to top">‚¨ÜÔ∏è</button>

  <!-- Language / Theme Switcher Panel -->
  <div style="text-align:center; margin-top: 20px;">
    <select id="languageSwitcher">
      <option value="en">English</option>
      <option value="de">Deutsch</option>
    </select>
    <button id="themeToggle">üåô</button>
  </div>

  <!-- Main Title -->
  <div class="container">
    <h1>iGFAP Stroke Risk Calculator</h1>
    <p style="text-align:center;">Select an option below to begin</p>
    <button class="primary" id="icpButton">Intracerebral Hemorrhage</button>
    <button class="primary" id="saHButton" data-translate="sahButton">Subarachnoid Hemorrhage</button>
    <button class="primary" id="updateNotesButton" data-translate="updateNotesButton">Update Notes</button>
  </div>

  <!-- Intracerebral Hemorrhage Module Choice -->
  <section id="strokeChoiceSection" class="container hidden">
    <h2 data-translate="strokeChoiceTitle">Choose Model Pathway</h2>
    <button class="primary" id="standardModelButton" data-translate="standardModelButton">
      <span>Standard Model (3 inputs)</span>
    </button>
    <button class="primary" id="advancedModelButton" data-translate="advancedModelButton">
      <span>Advanced Model</span>
    </button>
    <button class="secondary" id="strokeBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
  </section>

  <!-- Standard Model Prerequisites -->
  <section id="standardPrerequisitesSection" class="container hidden">
    <h2 data-translate="standardPrereqTitle">Standard Model Prerequisites</h2>
    <div class="checkbox-group">
      <input type="checkbox" id="stdPrereq1" />
      <label for="stdPrereq1" data-translate="prereq1">Confirmed time window &lt; 6 hours</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="stdPrereq2" />
      <label for="stdPrereq2" data-translate="prereq2">No prior neurological deficits</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="stdPrereq3" />
      <label for="stdPrereq3" data-translate="prereq3">No identifiable head trauma</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="stdPrereq4" />
      <label for="stdPrereq4" data-translate="prereq4">FAST ED Score ‚â• 3</label>
    </div>
    <button class="primary" id="standardNextButton" data-translate="nextButton">
      <span>Next</span>
    </button>
    <button class="secondary" id="standardBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <p id="standardPrereqError" class="error hidden"></p>
  </section>

  <!-- Standard Model Input Form (3 inputs) -->
  <section id="standardStrokeModuleSection" class="container hidden">
    <h2 data-translate="standardStrokeTitle">Intracerebral Hemorrhage (Standard)</h2>
    <div class="input-group">
      <label for="stdAgeInput" data-translate="ageLabel">Patient Age (Years)</label>
      <input type="number" id="stdAgeInput" min="18" max="120" />
    </div>
    <div class="input-group">
      <label for="stdGfapInput" data-translate="gfapLabel">GFAP Value (pg/mL)</label>
      <input type="number" id="stdGfapInput" min="29" max="10001" />
    </div>
    <div class="input-group">
      <label for="stdSbpInput" data-translate="sbpLabel">Systolic BP (mmHg)</label>
      <input type="number" id="stdSbpInput" min="50" max="250" />
    </div>
    <button class="primary" id="calculateStandardButton" data-translate="calculateButton">
      <span>Calculate Probability</span>
    </button>
    <button class="secondary" id="stdBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <div class="result hidden" id="standardResult" aria-live="polite"></div>
    <p id="standardError" class="error hidden"></p>
  </section>

  <!-- Advanced Model Prerequisites -->
  <section id="advancedPrerequisitesSection" class="container hidden">
    <h2 data-translate="advancedPrereqTitle">Advanced Model Prerequisites</h2>
    <div class="checkbox-group">
      <input type="checkbox" id="advPrereq1" />
      <label for="advPrereq1" data-translate="prereq1">Confirmed time window &lt; 6 hours</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="advPrereq2" />
      <label for="advPrereq2" data-translate="prereq2">No prior neurological deficits</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="advPrereq3" />
      <label for="advPrereq3" data-translate="prereq3">No identifiable head trauma</label>
    </div>
    <button class="primary" id="advancedNextButton" data-translate="nextButton">
      <span>Next</span>
    </button>
    <button class="secondary" id="advancedBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <p id="advancedPrereqError" class="error hidden"></p>
  </section>

  <!-- Rapid vs. Max Choice (after advanced prerequisites) -->
  <section id="rapidMaxChoiceSection" class="container hidden">
    <h2 data-translate="rapidMaxChoiceTitle">Choose Rapid or Max Version</h2>
    <button class="primary" id="rapidVersionButton" data-translate="rapidVersionButton">
      <span>Rapid/Schnell (5 inputs)</span>
    </button>
    <button class="primary" id="maxVersionButton" data-translate="maxVersionButton">
      <span>Max Version (13 inputs)</span>
    </button>
    <button class="secondary" id="rapidMaxBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
  </section>

  <!-- Rapid Model Input Form (5 inputs) -->
  <section id="rapidStrokeModuleSection" class="container hidden">
    <h2 data-translate="rapidStrokeTitle">Intracerebral Hemorrhage (Rapid ‚Äì 5 inputs)</h2>
    <div class="input-group">
      <label for="rapidAgeInput" data-translate="ageLabel">Patient Age (Years)</label>
      <input type="number" id="rapidAgeInput" min="18" max="120" />
    </div>
    <div class="input-group">
      <label for="rapidGfapInput" data-translate="gfapLabel">GFAP Value (pg/mL)</label>
      <input type="number" id="rapidGfapInput" min="29" max="10001" />
    </div>
    <div class="input-group">
      <label for="rapidSbpInput" data-translate="sbpLabel">Systolic BP (mmHg)</label>
      <input type="number" id="rapidSbpInput" min="50" max="250" />
    </div>
    <div class="input-group">
      <label for="rapidFastEdInput" data-translate="fastEdLabel">FAST ED Score</label>
      <input type="number" id="rapidFastEdInput" min="0" max="9" />
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="rapidHeadacheInput" />
      <label for="rapidHeadacheInput" data-translate="headacheLabel">Headache</label>
    </div>
    <button class="primary" id="calculateRapidButton" data-translate="calculateButton">
      <span>Calculate Probability</span>
    </button>
    <button class="secondary" id="rapidBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <div class="result hidden" id="rapidResult" aria-live="polite"></div>
    <p id="rapidError" class="error hidden"></p>
  </section>

  <!-- Max (13-input) Model Input Form -->
  <section id="maxStrokeModuleSection" class="container hidden">
    <h2 data-translate="maxStrokeTitle">Intracerebral Hemorrhage (Max ‚Äì 13 inputs)</h2>
    <div class="input-group">
      <label for="advAgeInput" data-translate="ageLabel">Patient Age (Years)</label>
      <input type="number" id="advAgeInput" min="18" max="120" />
    </div>
    <div class="input-group">
      <label for="advGfapInput" data-translate="gfapLabel">GFAP Value (pg/mL)</label>
      <input type="number" id="advGfapInput" min="29" max="10001" />
    </div>
    <div class="input-group">
      <label for="advSbpInput" data-translate="sbpLabel">Systolic BP (mmHg)</label>
      <input type="number" id="advSbpInput" min="50" max="250" />
    </div>
    <div class="input-group">
      <label for="advFastEdInput" data-translate="fastEdLabel">FAST ED Score</label>
      <input type="number" id="advFastEdInput" min="0" max="9" />
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="advHeadacheInput" />
      <label for="advHeadacheInput" data-translate="headacheLabel">Headache</label>
    </div>
    <div class="input-group">
      <label for="advGcsInput" data-translate="gcsLabel">Glasgow Coma Scale</label>
      <input type="number" id="advGcsInput" min="3" max="15"/>
    </div>
    <div class="input-group">
      <label for="advNauseaInput" data-translate="nauseaLabel">Nausea/Vomiting</label>
      <input type="checkbox" id="advNauseaInput"/>
    </div>
    <div class="input-group">
      <label for="advPupilsInput" data-translate="pupilsLabel">Abnormal Pupils</label>
      <input type="checkbox" id="advPupilsInput"/>
    </div>
    <div class="input-group">
      <label for="advHemiparesisInput" data-translate="hemiparesisLabel">Hemiparesis</label>
      <input type="checkbox" id="advHemiparesisInput"/>
    </div>
    <div class="input-group">
      <label for="advDysphasiaInput" data-translate="dysphasiaLabel">Dysphasia</label>
      <input type="checkbox" id="advDysphasiaInput"/>
    </div>
    <div class="input-group">
      <label for="advAtaxiaInput" data-translate="ataxiaLabel">Ataxia</label>
      <input type="checkbox" id="advAtaxiaInput"/>
    </div>
    <div class="input-group">
      <label for="advVisualLossInput" data-translate="visualLossLabel">Visual Loss</label>
      <input type="checkbox" id="advVisualLossInput"/>
    </div>
    <button class="primary" id="calculateMaxButton" data-translate="calculateButton">
      <span>Calculate Probability</span>
    </button>
    <button class="secondary" id="maxBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <div class="result hidden" id="maxResult" aria-live="polite"></div>
    <p id="maxError" class="error hidden"></p>
  </section>

  <!-- Subarachnoid Hemorrhage Module -->
  <section id="saHModuleSection" class="container hidden">
    <h2 data-translate="saHTitle">Subarachnoid Hemorrhage Risk</h2>
    <!-- SAH form fields (example) -->
    <div class="input-group">
      <label for="sahAgeInput" data-translate="ageLabel">Patient Age (Years)</label>
      <input type="number" id="sahAgeInput" min="18" max="120" />
    </div>
    <div class="input-group">
      <label for="sahBPInput" data-translate="sahBpLabel">Blood Pressure (mmHg)</label>
      <input type="number" id="sahBPInput" min="50" max="250" />
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="sahSevereHeadache" />
      <label for="sahSevereHeadache" data-translate="sahHeadacheLabel">Severe Headache</label>
    </div>
    <button class="primary" id="calculateSAHButton" data-translate="calculateButton">
      <span>Calculate Probability</span>
    </button>
    <button class="secondary" id="sahBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
    <div class="result hidden" id="sahResult" aria-live="polite"></div>
    <p id="sahError" class="error hidden"></p>
  </section>

  <!-- Update Notes Section -->
  <section id="updateNotesSection" class="container hidden">
    <h2 data-translate="updateNotesTitle">Latest Updates & Notes</h2>
    <p data-translate="updateNotesContent">
      Version 6 adds a Rapid vs. Max toggle for the stroke module. Rapid uses a 5-input Random Forest model; Max uses the full 13-input XGBoost model.
    </p>
    <button class="secondary" id="notesBackButton" data-translate="backButton">
      <span>‚¨ÖÔ∏è Back</span>
    </button>
  </section>

  <!-- Disclaimer Modal -->
  <div id="disclaimerModal" class="hidden" style="position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5);">
    <div class="container" style="max-width: 400px; margin: 100px auto; background: white; position: relative;">
      <h2 data-translate="disclaimerTitle">Disclaimer</h2>
      <p data-translate="disclaimerText">
        This tool is for educational purposes only. It does not replace clinical judgment. Always consult a medical professional.
      </p>
      <button class="primary" id="closeDisclaimer" data-translate="closeDisclaimerButton">
        <span>Close</span>
      </button>
    </div>
  </div>

  <script>
    // Translation dictionary
    const translations = {
      en: {
        sahTitle: "Subarachnoid Hemorrhage Risk",
        sahBpLabel: "Blood Pressure (mmHg)",
        sahHeadacheLabel: "Severe Headache",
        sahBackButton: "‚¨ÖÔ∏è Back",
        sahError: "Please check your inputs.",
        sahResultLow: "Low risk of SAH.",
        sahResultHigh: "High risk of SAH.",
        sahButton: "Subarachnoid Hemorrhage",
        updateNotesButton: "Update Notes",
        updateNotesTitle: "Latest Updates & Notes",
        updateNotesContent: "Version 6 adds a Rapid vs. Max toggle for the stroke module. Rapid uses a 5-input Random Forest model; Max uses the full 13-input XGBoost model.",
        strokeChoiceTitle: "Choose Model Pathway",
        standardModelButton: "Standard Model (3 inputs)",
        advancedModelButton: "Advanced Model",
        backButton: "‚¨ÖÔ∏è Back",
        standardPrereqTitle: "Standard Model Prerequisites",
        advancedPrereqTitle: "Advanced Model Prerequisites",
        prereq1: "Confirmed time window < 6 hours",
        prereq2: "No prior neurological deficits",
        prereq3: "No identifiable head trauma",
        prereq4: "FAST ED Score ‚â• 3",
        prerequisiteError: "Please check all prerequisites.",
        nextButton: "Next",
        standardStrokeTitle: "Intracerebral Hemorrhage (Standard)",
        maxStrokeTitle: "Intracerebral Hemorrhage (Max ‚Äì 13 inputs)",
        rapidMaxChoiceTitle: "Choose Rapid or Max Version",
        rapidVersionButton: "Rapid/Schnell (5 inputs)",
        maxVersionButton: "Max Version (13 inputs)",
        rapidStrokeTitle: "Intracerebral Hemorrhage (Rapid ‚Äì 5 inputs)",
        fastEdLabel: "FAST ED Score",
        headacheLabel: "Headache",
        gcsLabel: "Glasgow Coma Scale",
        nauseaLabel: "Nausea/Vomiting",
        pupilsLabel: "Abnormal Pupils",
        hemiparesisLabel: "Hemiparesis",
        dysphasiaLabel: "Dysphasia",
        ataxiaLabel: "Ataxia",
        visualLossLabel: "Visual Loss",
        calculateButton: "Calculate Probability",
        probability: "Probability",
        riskLevel: "Risk Level",
        invalidAge: "Please enter a valid age (18‚Äì120).",
        invalidGFAP: "GFAP must be between 29 and 10001.",
        sbpError: "Systolic BP must be between 50 and 250.",
        fastEdError: "FAST ED Score must be 0‚Äì9.",
        serverError: "Server error. Try again later."
      },
      de: {
        sahTitle: "Subarachnoidale Blutungswahrscheinlichkeit",
        sahBpLabel: "Blutdruck (mmHg)",
        sahHeadacheLabel: "Starke Kopfschmerzen",
        sahBackButton: "‚¨ÖÔ∏è Zur√ºck",
        sahError: "Bitte pr√ºfen Sie Ihre Eingaben.",
        sahResultLow: "Niedriges SAH-Risiko.",
        sahResultHigh: "Hohes SAH-Risiko.",
        sahButton: "Subarachnoidale Blutung",
        updateNotesButton: "Aktualisierungshinweise",
        updateNotesTitle: "Neueste Updates & Notizen",
        updateNotesContent: "Version 6 f√ºgt eine Schnell- vs. Max-Auswahl zum Stroke-Modul hinzu. Schnell verwendet ein 5-Eingaben-Random-Forest-Modell; Max verwendet das vollst√§ndige 13-Eingaben-XGBoost-Modell.",
        strokeChoiceTitle: "Modell-Pfad ausw√§hlen",
        standardModelButton: "Standardmodell (3 Eingaben)",
        advancedModelButton: "Erweitertes Modell",
        backButton: "‚¨ÖÔ∏è Zur√ºck",
        standardPrereqTitle: "Standardmodell-Voraussetzungen",
        advancedPrereqTitle: "Erweitertes Modell ‚Äì Voraussetzungen",
        prereq1: "Best√§tigter Zeitrahmen < 6 Stunden",
        prereq2: "Keine vorbestehenden neurologischen Defizite",
        prereq3: "Kein erkennbares Sch√§deltrauma",
        prereq4: "FAST ED-Score ‚â• 3",
        prerequisiteError: "Bitte pr√ºfen Sie alle Voraussetzungen.",
        nextButton: "Weiter",
        standardStrokeTitle: "Intrazerebrale Blutung (Standard)",
        maxStrokeTitle: "Intrazerebrale Blutung (Max ‚Äì 13 Eingaben)",
        rapidMaxChoiceTitle: "Schnell- oder Max-Version ausw√§hlen",
        rapidVersionButton: "Schnell (5 Eingaben)",
        maxVersionButton: "Max-Version (13 Eingaben)",
        rapidStrokeTitle: "Intrazerebrale Blutung (Schnell ‚Äì 5 Eingaben)",
        fastEdLabel: "FAST ED-Score",
        headacheLabel: "Kopfschmerz",
        gcsLabel: "Glasgow-Coma-Scale",
        nauseaLabel: "√úbelkeit/Erbrechen",
        pupilsLabel: "Abnorme Pupillen",
        hemiparesisLabel: "Hemiparese",
        dysphasiaLabel: "Dysphasie",
        ataxiaLabel: "Ataxie",
        visualLossLabel: "Sehverlust",
        calculateButton: "Wahrscheinlichkeit berechnen",
        probability: "Wahrscheinlichkeit",
        riskLevel: "Risikostufe",
        invalidAge: "Bitte geben Sie ein g√ºltiges Alter ein (18‚Äì120).",
        invalidGFAP: "GFAP muss zwischen 29 und 10001 liegen.",
        sbpError: "Systolischer Blutdruck muss zwischen 50 und 250 liegen.",
        fastEdError: "FAST ED-Score muss 0‚Äì9 sein.",
        serverError: "Serverfehler. Bitte sp√§ter erneut versuchen."
      }
    };

    let currentLang = "en";
    const ALL_SECTIONS = [
      "strokeChoiceSection",
      "standardPrerequisitesSection",
      "standardStrokeModuleSection",
      "advancedPrerequisitesSection",
      "rapidMaxChoiceSection",
      "rapidStrokeModuleSection",
      "maxStrokeModuleSection",
      "saHModuleSection",
      "updateNotesSection"
    ];

    // Show/hide sections
    function showSection(sectionId) {
      ALL_SECTIONS.forEach(id => {
        document.getElementById(id).classList.add("hidden");
      });
      document.getElementById(sectionId).classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Update text content based on current language
    function translatePage() {
      document.querySelectorAll("[data-translate]").forEach(el => {
        const key = el.getAttribute("data-translate");
        if (translations[currentLang][key]) {
          el.textContent = translations[currentLang][key];
        }
      });
      // Update error/result templates if needed
    }

    // Toggle theme
    function toggleTheme() {
      const body = document.body;
      if (body.getAttribute("data-theme") === "dark") {
        body.setAttribute("data-theme", "light");
        document.getElementById("themeToggle").textContent = "üåô";
      } else {
        body.setAttribute("data-theme", "dark");
        document.getElementById("themeToggle").textContent = "‚òÄÔ∏è";
      }
    }

    // Back-to-top button behavior
    window.addEventListener("scroll", () => {
      const btn = document.getElementById("backToTop");
      if (window.scrollY > 300) {
        btn.style.display = "block";
      } else {
        btn.style.display = "none";
      }
    });
    document.getElementById("backToTop").addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Utility: Show disclaimer modal
    function showDisclaimer() {
      document.getElementById("disclaimerModal").classList.remove("hidden");
    }
    document.getElementById("closeDisclaimer").addEventListener("click", () => {
      document.getElementById("disclaimerModal").classList.add("hidden");
    });

    // Utility: Button loading state
    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.disabled = true;
        button.textContent = "Loading‚Ä¶";
      } else {
        button.disabled = false;
        // Restore text via translation key
        const key = button.getAttribute("data-translate");
        if (translations[currentLang][key]) {
          button.textContent = translations[currentLang][key];
        }
      }
    }

    // Risk stratification helper
    function updateRiskStratification(prob) {
      let riskLevel = "", riskClass = "";
      if (prob >= 50) {
        riskLevel = currentLang === "en" ? "High Risk" : "Hohes Risiko";
        riskClass = "high";
      } else if (prob >= 20) {
        riskLevel = currentLang === "en" ? "Medium Risk" : "Mittleres Risiko";
        riskClass = "medium";
      } else {
        riskLevel = currentLang === "en" ? "Low Risk" : "Niedriges Risiko";
        riskClass = "low";
      }
      return { riskLevel, riskClass };
    }

    // Document ready
    window.addEventListener("DOMContentLoaded", () => {
      translatePage();

      // Language switcher
      document.getElementById("languageSwitcher").addEventListener("change", (e) => {
        currentLang = e.target.value;
        translatePage();
      });

      // Theme toggle
      document.getElementById("themeToggle").addEventListener("click", toggleTheme);

      // Main menu buttons
      document.getElementById("icpButton").addEventListener("click", () => {
        showSection("strokeChoiceSection");
      });
      document.getElementById("saHButton").addEventListener("click", () => {
        showSection("saHModuleSection");
      });
      document.getElementById("updateNotesButton").addEventListener("click", () => {
        showSection("updateNotesSection");
      });

      // Back buttons for main menu sections
      document.getElementById("strokeBackButton").addEventListener("click", () => {
        showSection("body"); // returns to main menu
      });
      document.getElementById("notesBackButton").addEventListener("click", () => {
        showSection("body");
      });

      // Standard Model flow
      document.getElementById("standardModelButton").addEventListener("click", () => {
        showSection("standardPrerequisitesSection");
      });
      document.getElementById("standardBackButton").addEventListener("click", () => {
        showSection("strokeChoiceSection");
      });
      document.getElementById("standardNextButton").addEventListener("click", () => {
        const checksMet = ["stdPrereq1", "stdPrereq2", "stdPrereq3", "stdPrereq4"].every(
          id => document.getElementById(id).checked
        );
        const errEl = document.getElementById("standardPrereqError");
        if (checksMet) {
          errEl.classList.add("hidden");
          showSection("standardStrokeModuleSection");
          document.getElementById("stdAgeInput").focus();
        } else {
          errEl.textContent = translations[currentLang].prerequisiteError;
          errEl.classList.remove("hidden");
        }
      });

      // Standard calculate
      document.getElementById("calculateStandardButton").addEventListener("click", async () => {
        const age = parseInt(document.getElementById("stdAgeInput").value, 10);
        const gfap = parseFloat(document.getElementById("stdGfapInput").value);
        const sbp = parseFloat(document.getElementById("stdSbpInput").value);
        const resultEl = document.getElementById("standardResult");
        const errorEl = document.getElementById("standardError");
        const btn = document.getElementById("calculateStandardButton");
        resultEl.className = "result hidden";
        errorEl.classList.add("hidden");

        // Validate inputs
        let errors = [];
        if (isNaN(age) || age < 18 || age > 120) errors.push(translations[currentLang].invalidAge);
        if (isNaN(gfap) || gfap < 29 || gfap > 10001) errors.push(translations[currentLang].invalidGFAP.replace("0 and 50000", "29 and 10001"));
        if (isNaN(sbp) || sbp < 50 || sbp > 250) errors.push(translations[currentLang].sbpError.replace("50-300", "50-250"));

        if (errors.length) {
          errorEl.innerHTML = errors.join("<br>");
          errorEl.classList.remove("hidden");
          return;
        }

        setButtonLoading(btn, true);
        try {
          const response = await fetch("https://europe-west3-igfap-452720.cloudfunctions.net/calculate-standard-stroke-xgb", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ age, gfap, sbp })
          });
          const data = await response.json();
          if (response.ok && data.success) {
            showDisclaimer();
            const { riskLevel, riskClass } = updateRiskStratification(data.probability);
            resultEl.innerHTML = `<strong>${translations[currentLang].probability}:</strong> ${data.probability.toFixed(1)}%<br>
                                  <strong>${translations[currentLang].riskLevel}:</strong> ${riskLevel}`;
            resultEl.classList.remove("hidden");
            resultEl.classList.add(riskClass);
          } else {
            errorEl.textContent = data.message || translations[currentLang].serverError;
            errorEl.classList.remove("hidden");
          }
        } catch (err) {
          console.error(err);
          errorEl.textContent = translations[currentLang].serverError;
          errorEl.classList.remove("hidden");
        } finally {
          setButtonLoading(btn, false);
        }
      });

      document.getElementById("stdBackButton").addEventListener("click", () => {
        showSection("standardPrerequisitesSection");
      });

      // Advanced Model flow
      document.getElementById("advancedModelButton").addEventListener("click", () => {
        showSection("advancedPrerequisitesSection");
      });
      document.getElementById("advancedBackButton").addEventListener("click", () => {
        showSection("strokeChoiceSection");
      });
      document.getElementById("advancedNextButton").addEventListener("click", () => {
        const checksMet = ["advPrereq1", "advPrereq2", "advPrereq3"].every(
          id => document.getElementById(id).checked
        );
        const errEl = document.getElementById("advancedPrereqError");
        if (checksMet) {
          errEl.classList.add("hidden");
          showSection("rapidMaxChoiceSection");
        } else {
          errEl.textContent = translations[currentLang].prerequisiteError;
          errEl.classList.remove("hidden");
        }
      });

      // Rapid vs. Max choice buttons
      document.getElementById("rapidVersionButton").addEventListener("click", () => {
        showSection("rapidStrokeModuleSection");
        document.getElementById("rapidAgeInput").focus();
      });
      document.getElementById("maxVersionButton").addEventListener("click", () => {
        showSection("maxStrokeModuleSection");
        document.getElementById("advAgeInput").focus();
      });
      document.getElementById("rapidMaxBackButton").addEventListener("click", () => {
        showSection("advancedPrerequisitesSection");
      });

      // Rapid calculate
      async function calculateRapidRisk() {
        const age = parseInt(document.getElementById("rapidAgeInput").value, 10);
        const gfap = parseFloat(document.getElementById("rapidGfapInput").value);
        const sbp = parseFloat(document.getElementById("rapidSbpInput").value);
        const fastEd = parseInt(document.getElementById("rapidFastEdInput").value, 10);
        const headache = document.getElementById("rapidHeadacheInput").checked ? 1 : 0;

        const resultEl = document.getElementById("rapidResult");
        const errorEl = document.getElementById("rapidError");
        const btn = document.getElementById("calculateRapidButton");
        resultEl.className = "result hidden";
        errorEl.classList.add("hidden");

        // Validate inputs
        let errors = [];
        if (isNaN(age) || age < 18 || age > 120) errors.push(translations[currentLang].invalidAge);
        if (isNaN(gfap) || gfap < 29 || gfap > 10001) errors.push(translations[currentLang].invalidGFAP.replace("0 and 50000", "29 and 10001"));
        if (isNaN(sbp) || sbp < 50 || sbp > 250) errors.push(translations[currentLang].sbpError.replace("50-300", "50-250"));
        if (isNaN(fastEd) || fastEd < 0 || fastEd > 9) errors.push(translations[currentLang].fastEdError);

        if (errors.length) {
          errorEl.innerHTML = errors.join("<br>");
          errorEl.classList.remove("hidden");
          return;
        }

        setButtonLoading(btn, true);
        try {
          const response = await fetch("https://europe-west3-igfap-452720.cloudfunctions.net/calculate-rapid-stroke-rf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ age: age, gfap: gfap, sbp: sbp, fast_ed: fastEd, headache: headache })
          });
          const data = await response.json();
          if (response.ok && data.success) {
            showDisclaimer();
            const { riskLevel, riskClass } = updateRiskStratification(data.probability);
            resultEl.innerHTML = `<strong>${translations[currentLang].probability}:</strong> ${data.probability.toFixed(1)}%<br>
                                  <strong>${translations[currentLang].riskLevel}:</strong> ${riskLevel}`;
            resultEl.classList.remove("hidden");
            resultEl.classList.add(riskClass);
          } else {
            errorEl.textContent = data.message || translations[currentLang].serverError;
            errorEl.classList.remove("hidden");
          }
        } catch (err) {
          console.error("Error calculating rapid risk:", err);
          errorEl.textContent = translations[currentLang].serverError;
          errorEl.classList.remove("hidden");
        } finally {
          setButtonLoading(btn, false);
        }
      }
      document.getElementById("calculateRapidButton").addEventListener("click", calculateRapidRisk);
      document.getElementById("rapidBackButton").addEventListener("click", () => {
        showSection("rapidMaxChoiceSection");
      });
      ["rapidAgeInput", "rapidGfapInput", "rapidSbpInput", "rapidFastEdInput"].forEach(id => {
        document.getElementById(id).addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            calculateRapidRisk();
          }
        });
      });

      // Max calculate
      document.getElementById("maxBackButton").addEventListener("click", () => {
        showSection("rapidMaxChoiceSection");
      });
      document.getElementById("calculateMaxButton").addEventListener("click", async () => {
        const age = parseInt(document.getElementById("advAgeInput").value, 10);
        const gfap = parseFloat(document.getElementById("advGfapInput").value);
        const sbp = parseFloat(document.getElementById("advSbpInput").value);
        const fastEd = parseInt(document.getElementById("advFastEdInput").value, 10);
        const headache = document.getElementById("advHeadacheInput").checked ? 1 : 0;
        const gcs = parseInt(document.getElementById("advGcsInput").value, 10);
        const nausea = document.getElementById("advNauseaInput").checked ? 1 : 0;
        const pupils = document.getElementById("advPupilsInput").checked ? 1 : 0;
        const hemiparesis = document.getElementById("advHemiparesisInput").checked ? 1 : 0;
        const dysphasia = document.getElementById("advDysphasiaInput").checked ? 1 : 0;
        const ataxia = document.getElementById("advAtaxiaInput").checked ? 1 : 0;
        const visualLoss = document.getElementById("advVisualLossInput").checked ? 1 : 0;

        const resultEl = document.getElementById("maxResult");
        const errorEl = document.getElementById("maxError");
        const btn = document.getElementById("calculateMaxButton");
        resultEl.className = "result hidden";
        errorEl.classList.add("hidden");

        // Validate inputs
        let errors = [];
        if (isNaN(age) || age < 18 || age > 120) errors.push(translations[currentLang].invalidAge);
        if (isNaN(gfap) || gfap < 29 || gfap > 10001) errors.push(translations[currentLang].invalidGFAP.replace("0 and 50000", "29 and 10001"));
        if (isNaN(sbp) || sbp < 50 || sbp > 250) errors.push(translations[currentLang].sbpError.replace("50-300", "50-250"));
        if (isNaN(fastEd) || fastEd < 0 || fastEd > 9) errors.push(translations[currentLang].fastEdError);
        if (isNaN(gcs) || gcs < 3 || gcs > 15) errors.push(translations[currentLang].gcsError || "GCS must be 3‚Äì15.");

        if (errors.length) {
          errorEl.innerHTML = errors.join("<br>");
          errorEl.classList.remove("hidden");
          return;
        }

        setButtonLoading(btn, true);
        try {
          const response = await fetch("https://europe-west3-igfap-452720.cloudfunctions.net/calculate-max-stroke-xgb", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              age, gfap, sbp, fast_ed: fastEd, headache, gcs, nausea, pupils,
              hemiparesis, dysphasia, ataxia, visual_loss: visualLoss
            })
          });
          const data = await response.json();
          if (response.ok && data.success) {
            showDisclaimer();
            const { riskLevel, riskClass } = updateRiskStratification(data.probability);
            resultEl.innerHTML = `<strong>${translations[currentLang].probability}:</strong> ${data.probability.toFixed(1)}%<br>
                                  <strong>${translations[currentLang].riskLevel}:</strong> ${riskLevel}`;
            resultEl.classList.remove("hidden");
            resultEl.classList.add(riskClass);
          } else {
            errorEl.textContent = data.message || translations[currentLang].serverError;
            errorEl.classList.remove("hidden");
          }
        } catch (err) {
          console.error(err);
          errorEl.textContent = translations[currentLang].serverError;
          errorEl.classList.remove("hidden");
        } finally {
          setButtonLoading(btn, false);
        }
      });

      // SAH calculate
      document.getElementById("calculateSAHButton").addEventListener("click", async () => {
        const age = parseInt(document.getElementById("sahAgeInput").value, 10);
        const bp = parseFloat(document.getElementById("sahBPInput").value);
        const headache = document.getElementById("sahSevereHeadache").checked ? 1 : 0;

        const resultEl = document.getElementById("sahResult");
        const errorEl = document.getElementById("sahError");
        const btn = document.getElementById("calculateSAHButton");
        resultEl.className = "result hidden";
        errorEl.classList.add("hidden");

        let errors = [];
        if (isNaN(age) || age < 18 || age > 120) errors.push(translations[currentLang].invalidAge);
        if (isNaN(bp) || bp < 50 || bp > 250) errors.push(translations[currentLang].sbpError.replace("50-300", "50-250"));

        if (errors.length) {
          errorEl.innerHTML = errors.join("<br>");
          errorEl.classList.remove("hidden");
          return;
        }

        setButtonLoading(btn, true);
        try {
          const response = await fetch("https://europe-west3-igfap-452720.cloudfunctions.net/calculate-sah-risk", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ age, bp, headache })
          });
          const data = await response.json();
          if (response.ok && data.success) {
            showDisclaimer();
            const riskText = data.probability >= 50
              ? (currentLang === "en" ? translations[currentLang].sahResultHigh : translations[currentLang].sahResultHigh)
              : (currentLang === "en" ? translations[currentLang].sahResultLow : translations[currentLang].sahResultLow);
            resultEl.textContent = riskText;
            resultEl.classList.remove("hidden");
            resultEl.classList.add(data.probability >= 50 ? "high" : "low");
          } else {
            errorEl.textContent = data.message || translations[currentLang].serverError;
            errorEl.classList.remove("hidden");
          }
        } catch (err) {
          console.error(err);
          errorEl.textContent = translations[currentLang].serverError;
          errorEl.classList.remove("hidden");
        } finally {
          setButtonLoading(btn, false);
        }
      });
      document.getElementById("sahBackButton").addEventListener("click", () => {
        showSection("strokeChoiceSection");
      });

    }); // end DOMContentLoaded
  </script>
</body>
</html>
